<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tile & Sanitaryware Inventory</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    /* Explorer-like table */
    .table-explorer { background: #fff; border-radius: 6px; overflow: hidden; }
    .table-explorer thead { background:#f1f3f5; }
    .table-explorer tbody tr:hover { background: #f8fafc; cursor: default; }
    .file-icon { font-size: 1.25rem; display:inline-block; width:1.6rem; text-align:center; }
    .file-icon.tile { color: #0d6efd; }       /* blue */
    .file-icon.sanitary { color: #198754; }   /* green */
    .file-icon.accessory { color: #fd7e14; }  /* orange */

    /* Stock badge sizes */
    .stock-badge { font-size: .85rem; padding: .25rem .5rem; border-radius: .5rem; }

    /* Mobile stacked list */
    .mobile-list { display: none; }
    .mobile-item { background: #fff; padding: .75rem; border-radius: .5rem; margin-bottom:.7rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .mobile-item .meta { font-size: .9rem; color: #6c757d; }

    /* Make the table use compact spacing */
    .table-sm td, .table-sm th { padding: .45rem .6rem; vertical-align: middle; }

    /* Responsive: on small screens, show mobile list and hide table */
    @media (max-width: 767.98px) {
      .desktop-table { display: none !important; }
      .mobile-list { display: block !important; }
    }

    /* Buttons small */
    .btn-action-sm { padding: .25rem .5rem; font-size: .85rem; }

  </style>
</head>
<body>
  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator" style="position:fixed;top:70px;left:20px;background:#fff;padding:8px 12px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:none;z-index:1000;">
    <i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span>
  </div>

  <!-- Header / Navbar -->
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm me-2" onclick="manualRefresh()">
          <i id="refreshIcon" class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Actions -->
    <div class="row mb-4">
      <div class="col-12 text-center">
        <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()"><i class="bi bi-plus-circle"></i> Add Product</button>
        <button class="btn btn-info btn-lg mb-2" onclick="showSalesSection()"><i class="bi bi-cart-check"></i> Record Sale</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-box-seam text-primary" style="font-size:2rem"></i><h3 id="totalProducts" class="mt-2">0</h3><p class="text-muted mb-0">Total Products</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-currency-rupee text-success" style="font-size:2rem"></i><h3 id="salesToday" class="mt-2">‚Çπ0</h3><p class="text-muted mb-0">Sales Today</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem"></i><h3 id="lowStock" class="mt-2">0</h3><p class="text-muted mb-0">Low Stock Items</p></div></div></div>
    </div>

    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <input id="searchInput" class="form-control form-control-lg" placeholder="üîç Search products by name, brand or size..." onkeyup="searchProducts()">
      </div>
    </div>

    <!-- Desktop Table (Explorer-style) -->
    <div class="row mb-4">
      <div class="col-12 desktop-table">
        <div class="table-explorer">
          <table class="table table-sm table-striped table-hover mb-0">
            <thead>
              <tr>
                <th style="width:50px">Icon</th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Brand</th>
                <th>Size</th>
                <th style="width:120px">Stock</th>
                <th style="width:140px">Price</th>
                <th style="width:150px">Actions</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- Rows injected here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile stacked list -->
      <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;">
        <!-- Mobile items injected here -->
      </div>
    </div>

    <!-- Recent Sales -->
    <div class="row">
      <div class="col-12">
        <h4 class="mb-3">Recent Sales</h4>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-primary">
              <tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr>
            </thead>
            <tbody id="salesList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Product Modal (imageUrl removed) -->
  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 id="modalTitle" class="modal-title">Add New Product</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row mb-3">
          <div class="col-md-8">
            <label class="form-label">Product Name *</label>
            <input id="productName" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Category *</label>
            <select id="category" class="form-select" required>
              <option value="">Select</option>
              <option value="Tiles">Tiles</option>
              <option value="Sanitaryware">Sanitaryware</option>
              <option value="Accessories">Accessories</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Brand</label>
            <input id="brand" class="form-control" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Size</label>
            <input id="size" class="form-control" placeholder="e.g., 2x2 feet or Standard" />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Unit Type *</label>
            <select id="unitType" class="form-select" required>
              <option value="Box">Box</option>
              <option value="Piece">Piece</option>
              <option value="SFT">Square Feet</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Pieces per Box</label>
            <input id="piecesPerBox" class="form-control" type="number" value="1" />
          </div>
          <div class="col-md-4">
            <label class="form-label">SFT per Box</label>
            <input id="sftPerBox" class="form-control" type="number" step="0.01" />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Price per Unit *</label>
            <input id="price" class="form-control" type="number" step="0.01" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Current Stock *</label>
            <input id="stock" class="form-control" type="number" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Minimum Stock</label>
            <input id="minStock" class="form-control" type="number" value="5" />
          </div>
        </div>

        <!-- imageUrl explicitly removed as requested -->

      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div>
  </div></div></div>

  <!-- Sales Modal -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-info text-white"><h5 class="modal-title">Record New Sale</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="salesForm">
        <div class="mb-3"><label class="form-label">Select Product *</label><select id="saleProduct" class="form-select" onchange="updateSalePriceInstant()" required><option value="">Choose product...</option></select></div>
        <div class="mb-3"><label class="form-label">Quantity *</label><input id="saleQuantity" class="form-control" type="number" min="1" oninput="updateSalePriceInstant()" required /></div>
        <div class="mb-3"><label class="form-label">Unit Price</label><input id="saleUnitPrice" class="form-control" readonly /></div>
        <div class="mb-3"><label class="form-label">Total Amount (Editable)</label><input id="saleTotal" class="form-control" type="number" step="0.01" placeholder="0.00" oninput="markTotalAsEdited()" /><small class="text-muted">Auto-calculated, but editable</small></div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-success" onclick="recordSale()">Complete Sale</button></div>
  </div></div></div>

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /*************************
   * Config + State
   *************************/
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyeHFA8lBZ8WJYwdrl0htCzhMumMOlAqFKDpAhp3aRAw1dxN222-uJaBMbzKCl3wNbD/exec';
  let cachedProducts = [];
  let cachedSales = [];
  let syncInProgress = false;
  let hasInitialLoaded = false;

  /*************************
   * Helpers
   *************************/
  function showSyncIndicator(message, type='syncing') {
    const el = document.getElementById('syncIndicator');
    const txt = document.getElementById('syncText');
    txt.textContent = message;
    el.style.display = 'block';
    if (type === 'success') setTimeout(()=> el.style.display='none', 1400);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  async function safeParseResponse(res) {
    const txt = await res.text();
    try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
    catch(e) { return { ok: res.ok, json: null, text: txt }; }
  }

  function fetchWithTimeout(url, options={}, timeoutMs=8000) {
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), timeoutMs);
    return fetch(url, Object.assign({}, options, { signal: controller.signal }))
      .finally(()=> clearTimeout(id));
  }

  /*************************
   * Sync (manual refresh)
   *************************/
  async function tryGetAll(timeoutMs=7000) {
    const url = `${GOOGLE_SCRIPT_URL}?action=getAll&t=${Date.now()}`;
    const res = await fetchWithTimeout(url, {}, timeoutMs);
    if (!res.ok) throw new Error('Network response not ok: ' + res.status);
    return await res.json();
  }

  async function fallbackGetProductsAndSales() {
    try {
      const prodRes = await fetchWithTimeout(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`, {}, 5000);
      if (prodRes.ok) {
        const prodJson = await prodRes.json();
        if (prodJson && prodJson.products) {
          cachedProducts = prodJson.products;
          hasInitialLoaded = true;
          renderProducts();
        }
      }
    } catch(e){ console.warn('fallback products failed', e); }

    try {
      const salesRes = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales&t=${Date.now()}`);
      if (salesRes.ok) {
        const salesJson = await salesRes.json();
        if (salesJson && salesJson.sales) {
          cachedSales = salesJson.sales;
          hasInitialLoaded = true;
          renderSales();
        }
      }
    } catch(e){ console.warn('fallback sales failed', e); }
  }

  async function syncFromGoogleSheets() {
    if (syncInProgress) return;
    syncInProgress = true;
    showSyncIndicator('Syncing...', 'syncing');
    try {
      try {
        const data = await tryGetAll(7000);
        if (data && data.success) {
          const productsChanged = JSON.stringify(cachedProducts) !== JSON.stringify(data.products || []);
          const salesChanged = JSON.stringify(cachedSales) !== JSON.stringify(data.sales || []);
          if (productsChanged || salesChanged || !hasInitialLoaded) {
            cachedProducts = data.products || [];
            cachedSales = data.sales || [];
            hasInitialLoaded = true;
            renderProducts();
            renderSales();
            showSyncIndicator('‚úÖ Synced!', 'success');
          } else {
            hideSyncIndicator();
          }
          return;
        } else {
          console.warn('getAll did not return success, fallback');
        }
      } catch (err) {
        console.warn('getAll failed, fallback', err);
      }
      await fallbackGetProductsAndSales();
      showSyncIndicator('‚úÖ Synced!', 'success');
    } catch(e) {
      console.error('sync error', e);
      alert('‚ùå Refresh failed. Check network or Apps Script deployment.');
    } finally {
      syncInProgress = false;
    }
  }

  // Manual refresh button
  async function manualRefresh() {
    const btn = document.getElementById('refreshBtn');
    const icon = document.getElementById('refreshIcon');
    try {
      btn.disabled = true;
      icon.className = 'bi bi-arrow-clockwise spinner-border spinner-border-sm';
      await syncFromGoogleSheets();
    } finally {
      icon.className = 'bi bi-arrow-clockwise';
      btn.disabled = false;
    }
  }

  /*************************
   * Renderers (desktop table + mobile stacked)
   *************************/
  function categoryIconClass(category) {
    if (!category) return 'file-icon';
    const c = category.toLowerCase();
    if (c.includes('tile')) return 'file-icon tile';
    if (c.includes('sanitary')) return 'file-icon sanitary';
    if (c.includes('access')) return 'file-icon accessory';
    return 'file-icon';
  }

  function stockBadgeHtml(stock, minStock) {
    minStock = (typeof minStock === 'number') ? minStock : Number(minStock) || 5;
    stock = Number(stock) || 0;
    if (stock === 0) {
      return `<span class="stock-badge bg-danger text-white">Out of Stock</span>`;
    } else if (stock <= minStock) {
      return `<span class="stock-badge bg-warning text-dark">Low (${stock})</span>`;
    } else {
      return `<span class="stock-badge bg-success text-white">In Stock (${stock})</span>`;
    }
  }

  function renderProducts() {
    renderProductsTable();
    renderProductsMobileList();
    updateSummaryFromCache();
    loadProductsForSaleFromCache();
  }

  function renderProductsTable() {
    const tbody = document.getElementById('productsTableBody');
    if (!hasInitialLoaded) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventory‚Ä¶</div></td></tr>`;
      return;
    }
    if (!cachedProducts || cachedProducts.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
      return;
    }
    let html = '';
    (cachedProducts || []).forEach(p => {
      const iconClass = categoryIconClass(p.category);
      const stockHtml = stockBadgeHtml(p.stock, p.minStock);
      const priceText = (p.price !== undefined && p.price !== null) ? `‚Çπ${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
      const sizeText = p.size || '';
      html += `<tr>
        <td><i class="bi bi-file-earmark-fill ${iconClass.replace('file-icon ', '')}" style="font-size:1.15rem; ${iconClass.includes('tile')? 'color:#0d6efd;': iconClass.includes('sanitary')? 'color:#198754;': iconClass.includes('accessory')? 'color:#fd7e14;':'' }"></i></td>
        <td>${escapeHtml(p.name || '')}</td>
        <td>${escapeHtml(p.category || '')}</td>
        <td>${escapeHtml(p.brand || '')}</td>
        <td><strong>${escapeHtml(sizeText)}</strong></td>
        <td>${stockHtml}</td>
        <td>${priceText}</td>
        <td>
          <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i> Delete</button>
        </td>
      </tr>`;
    });
    tbody.innerHTML = html;
  }

  function renderProductsMobileList() {
    const container = document.getElementById('mobileProductsList');
    if (!hasInitialLoaded) {
      container.innerHTML = `<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventory‚Ä¶</div></div>`;
      return;
    }
    if (!cachedProducts || cachedProducts.length === 0) {
      container.innerHTML = `<div class="mobile-item text-center text-muted">No products yet</div>`;
      return;
    }
    let html = '';
    (cachedProducts || []).forEach(p => {
      const sizeText = p.size || '';
      const stockHtml = stockBadgeHtml(p.stock, p.minStock);
      const priceText = (p.price !== undefined && p.price !== null) ? `‚Çπ${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
      const iconColorClass = categoryIconClass(p.category);
      const iconInlineColor = iconColorClass.includes('tile')? '#0d6efd' : iconColorClass.includes('sanitary')? '#198754' : iconColorClass.includes('accessory')? '#fd7e14' : '#6c757d';
      html += `<div class="mobile-item d-flex align-items-start justify-content-between">
        <div style="display:flex;gap:.8rem;align-items:center;">
          <div style="width:36px;text-align:center;"><i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconInlineColor}"></i></div>
          <div>
            <div style="font-weight:600">${escapeHtml(p.name||'')}</div>
            <div class="meta">${escapeHtml(p.category||'')} ‚Ä¢ ${escapeHtml(p.brand||'')}</div>
            <div class="meta"><strong>${escapeHtml(sizeText)}</strong> ‚Ä¢ <span>${priceText}</span></div>
          </div>
        </div>
        <div style="text-align:right;">
          <div>${stockHtml}</div>
          <div style="margin-top:.5rem">
            <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>`;
    });
    container.innerHTML = html;
  }

  function escapeHtml(text) {
    if (!text && text !== 0) return '';
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  /*************************
   * Sales rendering & summary
   *************************/
  function renderSales() {
    const tbody = document.getElementById('salesList');
    if (!hasInitialLoaded) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading sales‚Ä¶</div></td></tr>`;
      return;
    }
    if (!cachedSales || cachedSales.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`;
      return;
    }
    let html = '';
    const recent = (cachedSales || []).slice(0,10);
    recent.forEach(sale => {
      const d = new Date(sale.date || '');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">‚Çπ${parseFloat(sale.totalAmount || 0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
  }

  function updateSummaryFromCache() {
    if (!hasInitialLoaded) {
      document.getElementById('totalProducts').textContent = 'Loading...';
      document.getElementById('salesToday').textContent = 'Loading...';
      document.getElementById('lowStock').textContent = 'Loading...';
      return;
    }
    document.getElementById('totalProducts').textContent = (cachedProducts||[]).length;
    const today = new Date().toDateString();
    const todaySales = (cachedSales||[]).filter(s=> new Date(s.date).toDateString() === today);
    const sum = todaySales.reduce((acc, s) => acc + parseFloat(s.totalAmount || 0), 0);
    document.getElementById('salesToday').textContent = '‚Çπ' + sum.toFixed(2);
    const low = (cachedProducts||[]).filter(p => p.stock <= p.minStock && p.stock > 0).length;
    document.getElementById('lowStock').textContent = low;
  }

  function loadProductsForSaleFromCache() {
    const sel = document.getElementById('saleProduct');
    sel.innerHTML = '<option value="">Choose product...</option>';
    (cachedProducts||[]).forEach(p => {
      if (p.stock > 0) sel.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)} (Stock: ${p.stock} ${p.unitType})</option>`;
    });
  }

  /*************************
   * CRUD operations (client)
   *************************/
  function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

  async function saveProductToSheet(product, isEdit=false) {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=${isEdit? 'updateProduct':'addProduct'}`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(product)
      });
      const parsed = await safeParseResponse(res);
      if (parsed.json && parsed.json.success) return parsed.json;
      else throw new Error(parsed.text || 'Save failed');
    } catch (err) {
      console.error('saveProductToSheet error', err);
      return null;
    }
  }

  async function deleteProductFromSheet(id) {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=deleteProduct`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({ id })
      });
      const parsed = await safeParseResponse(res);
      return parsed.json && parsed.json.success;
    } catch (e) {
      console.error('deleteProductFromSheet error', e);
      return false;
    }
  }

  async function saveSaleToSheet(sale) {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=addSale`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(sale)
      });
      const parsed = await safeParseResponse(res);
      return parsed.json && parsed.json.success ? parsed.json : null;
    } catch (e) {
      console.error('saveSaleToSheet error', e);
      return null;
    }
  }

  /***** UI CRUD handlers *****/
  let editingProductId = null;

  function showAddProduct() {
    editingProductId = null;
    document.getElementById('modalTitle').textContent = 'Add New Product';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
  }

  function editProduct(id) {
    const p = (cachedProducts||[]).find(x=>x.id===id);
    if (!p) { alert('‚ùå Product not found!'); return; }
    editingProductId = id;
    document.getElementById('modalTitle').textContent = 'Edit Product';
    document.getElementById('productId').value = p.id;
    document.getElementById('productName').value = p.name;
    document.getElementById('category').value = p.category;
    document.getElementById('brand').value = p.brand||'';
    document.getElementById('size').value = p.size||'';
    document.getElementById('unitType').value = p.unitType;
    document.getElementById('piecesPerBox').value = p.piecesPerBox||1;
    document.getElementById('sftPerBox').value = p.sftPerBox||'';
    document.getElementById('price').value = p.price;
    document.getElementById('stock').value = p.stock;
    document.getElementById('minStock').value = p.minStock;
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
  }

  async function saveProduct() {
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value.trim();
    const size = document.getElementById('size').value.trim();
    const unitType = document.getElementById('unitType').value;
    const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
    const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const minStock = parseInt(document.getElementById('minStock').value) || 5;

    if (!name || !category || isNaN(price) || isNaN(stock) || stock < 0) { alert('‚ùå Please fill required fields'); return; }

    const product = {
      id: editingProductId || generateId(),
      name, category, brand, size, unitType,
      piecesPerBox, sftPerBox, price, stock, minStock
      // imageUrl deliberately removed
    };

    // optimistic update
    const idx = (cachedProducts||[]).findIndex(p=>p.id===product.id);
    const prev = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
    if (idx !== -1) cachedProducts[idx] = product; else cachedProducts.push(product);
    renderProducts();

    // close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal')); if (modal) modal.hide();

    showSyncIndicator('Saving...', 'syncing');
    const serverResp = await saveProductToSheet(product, !!editingProductId);

    if (serverResp && serverResp.success) {
      if (!editingProductId && serverResp.id) {
        const localIdx = cachedProducts.findIndex(p=>p.id===product.id);
        if (localIdx !== -1) { cachedProducts[localIdx].id = serverResp.id; }
      }
      showSyncIndicator('Saved', 'success');
      editingProductId = null;
      setTimeout(()=> alert('‚úÖ Product saved'), 300);
    } else {
      // revert
      if (prev) cachedProducts[idx] = prev;
      else cachedProducts = (cachedProducts||[]).filter(p=>p.id!==product.id);
      renderProducts();
      alert('‚ùå Save failed ‚Äî changes reverted locally.');
    }
  }

  function deleteProduct(id) {
    if (!confirm('Are you sure?')) return;
    const prev = cachedProducts.slice();
    cachedProducts = (cachedProducts||[]).filter(p=>p.id!==id);
    renderProducts();
    showSyncIndicator('Deleting...', 'syncing');
    deleteProductFromSheet(id).then(success => {
      if (success) { showSyncIndicator('Deleted', 'success'); setTimeout(()=> alert('‚úÖ Deleted'), 300); }
      else { cachedProducts = prev; renderProducts(); alert('‚ùå Delete failed ‚Äî reverted locally.'); }
    });
  }

  /* SALES: same as previous logic (optimistic + server write) */
  let totalEdited = false;
  function showSalesSection() { loadProductsForSaleFromCache(); document.getElementById('salesForm').reset(); document.getElementById('saleTotal').value=''; document.getElementById('saleUnitPrice').value=''; totalEdited=false; const modal = new bootstrap.Modal(document.getElementById('salesModal')); modal.show(); }
  function updateSalePriceInstant(){
    if (totalEdited) return;
    const pid = document.getElementById('saleProduct').value;
    const qty = parseInt(document.getElementById('saleQuantity').value) || 0;
    if (!pid || qty<=0){ document.getElementById('saleTotal').value=''; document.getElementById('saleUnitPrice').value=''; return; }
    const product = (cachedProducts||[]).find(p=>p.id===pid);
    if (!product) return;
    if (qty>product.stock){ alert(`‚ùå Only ${product.stock} available`); document.getElementById('saleQuantity').value=product.stock; return; }
    document.getElementById('saleTotal').value = (product.price * qty).toFixed(2);
    document.getElementById('saleUnitPrice').value = '‚Çπ'+product.price+'/'+product.unitType;
  }
  function markTotalAsEdited(){ totalEdited=true; }

  async function recordSale(){
    const pid = document.getElementById('saleProduct').value;
    const qty = parseInt(document.getElementById('saleQuantity').value);
    const totalAmount = parseFloat(document.getElementById('saleTotal').value);
    if (!pid || !qty || qty<=0 || !totalAmount){ alert('‚ùå Fill sale details'); return; }
    const product = (cachedProducts||[]).find(p=>p.id===pid);
    if (!product) { alert('‚ùå Product not found'); return; }
    if (qty>product.stock){ alert('‚ùå Insufficient stock'); return; }

    const sale = { id: generateId(), productId: product.id, productName: product.name, quantity: qty, unitType: product.unitType, totalAmount: totalAmount, date: new Date().toISOString() };

    // optimistic update
    product.stock -= qty;
    cachedSales.unshift(sale);
    renderProducts(); renderSales();

    const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal')); if (modal) modal.hide();
    showSyncIndicator('Saving sale...', 'syncing');
    const resp = await saveSaleToSheet(sale);
    if (resp && resp.success) {
      showSyncIndicator('Saved', 'success'); setTimeout(()=> alert(`‚úÖ Sale recorded: ‚Çπ${totalAmount.toFixed(2)}`), 300);
    } else {
      // revert
      cachedSales = cachedSales.filter(s=>s.id!==sale.id);
      const prod = (cachedProducts||[]).find(p=>p.id===pid);
      if (prod) prod.stock += qty;
      renderProducts(); renderSales();
      alert('‚ùå Sale save failed ‚Äî reverted locally.');
    }
  }

  /*************************
   * Search / Export / Import
   *************************/
  function searchProducts(){
    const term = (document.getElementById('searchInput').value||'').toLowerCase();
    const filtered = (cachedProducts||[]).filter(p=> (p.name||'').toLowerCase().includes(term) || (p.brand||'').toLowerCase().includes(term) || (p.size||'').toLowerCase().includes(term) || (p.category||'').toLowerCase().includes(term));
    // temporarily render filtered arrays (desktop + mobile)
    const origProducts = cachedProducts;
    cachedProducts = filtered;
    renderProducts();
    cachedProducts = origProducts; // restore
  }

  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('‚úÖ Backup downloaded');
  }

  function importData(){ document.getElementById('fileInput').click(); }
  function handleFileImport(e){ const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(evt){ try { const data = JSON.parse(evt.target.result); if (data.products) cachedProducts = data.products; if (data.sales) cachedSales = data.sales; hasInitialLoaded = true; renderProducts(); renderSales(); alert('‚úÖ Data restored (local)'); } catch(err){ alert('‚ùå Invalid file'); } }; reader.readAsText(file); }

  /*************************
   * Init - single manual-sync mode on load
   *************************/
  (function init(){
    // placeholders
    renderProducts();
    renderSales();
    // initial one-time load
    syncFromGoogleSheets();
    // don't auto-poll: manual-only
  })();

  </script>
</body>
</html>

