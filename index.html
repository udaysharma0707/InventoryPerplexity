<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tile & Sanitaryware Inventory</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    .product-card{transition:transform .2s,box-shadow .2s;height:100%;border:1px solid #dee2e6}
    .product-card:hover{transform:translateY(-5px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .product-image{width:100%;height:200px;object-fit:cover;background:#e9ecef}
    .stock-badge{font-size:1rem;padding:.5rem 1rem}
    .stock-good{background:#28a745;color:#fff}.stock-low{background:#ffc107;color:#000}.stock-out{background:#dc3545;color:#fff}
    .card-actions{display:flex;gap:.5rem}.btn-action{flex:1}.btn-lg{padding:1rem 2rem;font-size:1.2rem}
    .empty-state{text-align:center;padding:3rem;color:#6c757d}.empty-state i{font-size:4rem;margin-bottom:1rem}
    .sync-indicator{position:fixed;top:70px;left:20px;background:#fff;padding:8px 16px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);font-size:.9rem;z-index:1000;display:none}
    .sync-indicator.syncing{display:block;color:#0d6efd}.sync-indicator.success{display:block;color:#28a745}
    @media(max-width:768px){.btn-lg{padding:.75rem 1.5rem;font-size:1rem}.product-image{height:150px}.sync-indicator{top:60px;left:10px;font-size:.8rem;padding:6px 12px}}
  </style>
</head>
<body>
  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator"><i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span></div>

  <!-- Header -->
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">

    <!-- Actions -->
    <div class="row mb-4">
      <div class="col-12 text-center">
        <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()"><i class="bi bi-plus-circle"></i> Add Product</button>
        <button class="btn btn-info btn-lg mb-2" onclick="showSalesSection()"><i class="bi bi-cart-check"></i> Record Sale</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-box-seam text-primary" style="font-size:2rem"></i><h3 id="totalProducts" class="mt-2">0</h3><p class="text-muted mb-0">Total Products</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-currency-rupee text-success" style="font-size:2rem"></i><h3 id="salesToday" class="mt-2">‚Çπ0</h3><p class="text-muted mb-0">Sales Today</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem"></i><h3 id="lowStock" class="mt-2">0</h3><p class="text-muted mb-0">Low Stock Items</p></div></div></div>
    </div>

    <!-- Search -->
    <div class="row mb-3"><div class="col-md-6 mx-auto"><input id="searchInput" class="form-control form-control-lg" placeholder="üîç Search products by name or brand..." onkeyup="searchProducts()"></div></div>

    <!-- Products -->
    <div class="row mb-4"><div class="col-12"><h4 class="mb-3">Products Inventory</h4><div class="row" id="productsList"></div></div></div>

    <!-- Sales -->
    <div class="row"><div class="col-12"><h4 class="mb-3">Recent Sales</h4><div class="table-responsive"><table class="table table-striped"><thead class="table-primary"><tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr></thead><tbody id="salesList"></tbody></table></div></div></div>

  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 id="modalTitle" class="modal-title">Add New Product</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row mb-3"><div class="col-md-8"><label class="form-label">Product Name *</label><input id="productName" class="form-control" required></div><div class="col-md-4"><label class="form-label">Category *</label><select id="category" class="form-select" required><option value="">Select</option><option>Tiles</option><option>Sanitaryware</option><option>Accessories</option></select></div></div>
        <div class="row mb-3"><div class="col-md-6"><label class="form-label">Brand</label><input id="brand" class="form-control"></div><div class="col-md-6"><label class="form-label">Size</label><input id="size" class="form-control" placeholder="e.g., 2x2 feet"></div></div>
        <div class="row mb-3"><div class="col-md-4"><label class="form-label">Unit Type *</label><select id="unitType" class="form-select" required><option value="Box">Box</option><option value="Piece">Piece</option><option value="SFT">Square Feet</option></select></div><div class="col-md-4"><label class="form-label">Pieces per Box</label><input id="piecesPerBox" class="form-control" type="number" value="1"></div><div class="col-md-4"><label class="form-label">SFT per Box</label><input id="sftPerBox" class="form-control" type="number" step="0.01"></div></div>
        <div class="row mb-3"><div class="col-md-4"><label class="form-label">Price per Unit *</label><input id="price" class="form-control" type="number" step="0.01" required></div><div class="col-md-4"><label class="form-label">Current Stock *</label><input id="stock" class="form-control" type="number" required></div><div class="col-md-4"><label class="form-label">Minimum Stock</label><input id="minStock" class="form-control" type="number" value="5"></div></div>
        <div class="mb-3"><label class="form-label">Product Image URL (optional)</label><input id="imageUrl" class="form-control" type="url" placeholder="https://example.com/image.jpg"></div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div>
  </div></div></div>

  <!-- Sales Modal -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-info text-white"><h5 class="modal-title">Record New Sale</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="salesForm">
        <div class="mb-3"><label class="form-label">Select Product *</label><select id="saleProduct" class="form-select" onchange="updateSalePriceInstant()" required><option value="">Choose product...</option></select></div>
        <div class="mb-3"><label class="form-label">Quantity *</label><input id="saleQuantity" class="form-control" type="number" min="1" oninput="updateSalePriceInstant()" required></div>
        <div class="mb-3"><label class="form-label">Unit Price</label><input id="saleUnitPrice" class="form-control" readonly></div>
        <div class="mb-3"><label class="form-label">Total Amount (Editable)</label><input id="saleTotal" class="form-control" type="number" step="0.01" placeholder="0.00" oninput="markTotalAsEdited()"><small class="text-muted">Auto-calculated, but editable</small></div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-success" onclick="recordSale()">Complete Sale</button></div>
  </div></div></div>

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /*************************
   * Configuration
   *************************/
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzNkvZW4g5Bp6JWuGGgcE55dbhbSCVZ7ioWwzKzgBm3FLn9tS_XNXHg2SJnyxUKtWf8/exec';
  // Adjust these to tune behavior
  const NORMAL_POLL_MS = 20000;      // normal polling interval
  const FAST_POLL_MS = 8000;         // fast polling interval after a local change
  const FAST_POLL_DURATION_MS = 80000; // how long to fast-poll after a change

  /*************************
   * State
   *************************/
  let cachedProducts = [];
  let cachedSales = [];
  let syncInProgress = false;
  let hasInitialLoaded = false;
  let pollInterval = NORMAL_POLL_MS;
  let pollTimer = null;
  let lastLocalChangeAt = 0; // timestamp when this client last performed a write
  let lastServerSignal = 0;  // server-side "bump" time (to detect remote changes quickly)

  /*************************
   * UI helpers
   *************************/
  function showSyncIndicator(message, type='syncing') {
    const el = document.getElementById('syncIndicator');
    const txt = document.getElementById('syncText');
    el.className = `sync-indicator ${type}`;
    txt.textContent = message;
    el.style.display = 'block';
    if (type === 'success') setTimeout(()=> el.style.display='none', 1600);
  }
  function hideSyncIndicator() { document.getElementById('syncIndicator').style.display='none'; }

  /*************************
   * Network helpers
   *************************/
  async function safeParseResponse(res) {
    const txt = await res.text();
    try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
    catch(e) { return { ok: res.ok, json: null, text: txt }; }
  }

  function fetchWithTimeout(url, options={}, timeoutMs=8000) {
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), timeoutMs);
    return fetch(url, Object.assign({}, options, { signal: controller.signal }))
      .finally(()=> clearTimeout(id));
  }

  /*************************
   * Polling / Sync logic
   *
   * Approach:
   * - Primary: call getAll (fast combined read).
   * - If getAll times out -> fallback: fetch products quickly, then fetch sales in background.
   * - Poll interval is NORMAL_POLL_MS. When a local write happens, we "fast poll" for FAST_POLL_DURATION_MS.
   * - The server-side cache is invalidated on writes (Apps Script removes cache key). Clients will pick that up quickly.
   *************************/
  async function tryGetAll(timeoutMs=7000) {
    const url = `${GOOGLE_SCRIPT_URL}?action=getAll&t=${Date.now()}`;
    try {
      const res = await fetchWithTimeout(url, {}, timeoutMs);
      if (!res.ok) throw new Error('Network response not ok: ' + res.status);
      const data = await res.json();
      return data;
    } catch (err) {
      // propagate
      throw err;
    }
  }

  async function fallbackGetProductsAndSales() {
    // Fetch products quickly
    try {
      const prodRes = await fetchWithTimeout(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`, {}, 5000);
      if (prodRes.ok) {
        const prodJson = await prodRes.json();
        if (prodJson && prodJson.products) {
          cachedProducts = prodJson.products;
          hasInitialLoaded = true;
          displayProductsFromCache();
          updateSummaryFromCache();
          loadProductsForSaleFromCache();
        }
      }
    } catch(e){
      console.warn('fallback products failed', e);
    }

    // Background: fetch sales
    try {
      const salesRes = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales&t=${Date.now()}`);
      if (salesRes.ok) {
        const salesJson = await salesRes.json();
        if (salesJson && salesJson.sales) {
          cachedSales = salesJson.sales;
          hasInitialLoaded = true;
          displaySalesFromCache();
          updateSummaryFromCache();
        }
      }
    } catch(e){
      console.warn('fallback sales failed', e);
    }
  }

  async function syncFromGoogleSheets() {
    if (syncInProgress) return;
    syncInProgress = true;
    showSyncIndicator('Syncing...', 'syncing');

    try {
      // Try combined endpoint first with modest timeout
      try {
        const data = await tryGetAll(7000);
        if (data && data.success) {
          // if server sends a signal timestamp (optional) use it to detect remote changes
          // (not required; left for extensibility)
          if (data.signal) lastServerSignal = data.signal;

          const productsChanged = JSON.stringify(cachedProducts) !== JSON.stringify(data.products || []);
          const salesChanged = JSON.stringify(cachedSales) !== JSON.stringify(data.sales || []);
          if (productsChanged || salesChanged || !hasInitialLoaded) {
            cachedProducts = data.products || [];
            cachedSales = data.sales || [];
            hasInitialLoaded = true;
            displayProductsFromCache();
            displaySalesFromCache();
            updateSummaryFromCache();
            loadProductsForSaleFromCache();
            showSyncIndicator('Synced!', 'success');
          } else {
            hideSyncIndicator();
          }
          return;
        } else {
          // try fallback
          console.warn('getAll responded without success, falling back', data);
        }
      } catch (err) {
        console.warn('getAll failed or timed out, falling back:', err.message || err);
      }

      // fallback path
      await fallbackGetProductsAndSales();
    } catch (outer) {
      console.error('syncFromGoogleSheets outer error:', outer);
    } finally {
      syncInProgress = false;
    }
  }

  /*************************
   * Poll scheduler (adapts between normal & fast polling)
   *************************/
  function schedulePolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async () => {
      // If we recently made a local change, use FAST poll for a while
      const now = Date.now();
      if (lastLocalChangeAt && now - lastLocalChangeAt <= FAST_POLL_DURATION_MS) {
        // leave poll interval as FAST (we schedule intervals using setInterval, so just call sync)
        await syncFromGoogleSheets();
        return;
      }
      // Normal poll
      await syncFromGoogleSheets();
    }, pollInterval);
  }

  function triggerFastPolling() {
    lastLocalChangeAt = Date.now();
    // temporarily set pollInterval to FAST and re-schedule
    const old = pollInterval;
    pollInterval = FAST_POLL_MS;
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    // use setInterval with FAST polling
    pollTimer = setInterval(async () => {
      const now = Date.now();
      if (now - lastLocalChangeAt > FAST_POLL_DURATION_MS) {
        // revert to normal polling
        clearInterval(pollTimer);
        pollInterval = NORMAL_POLL_MS;
        schedulePolling();
      } else {
        await syncFromGoogleSheets();
      }
    }, pollInterval);
  }

  /*************************
   * Display functions
   *************************/
  function displayProductsFromCache() {
    const container = document.getElementById('productsList');
    if (!hasInitialLoaded) {
      container.innerHTML = `<div class="col-12 text-center py-5"><div class="spinner-border" role="status"></div><p class="mt-3 text-muted">Loading inventory‚Ä¶</p></div>`;
      return;
    }
    if (!cachedProducts || cachedProducts.length === 0) {
      container.innerHTML = `<div class="col-12"><div class="empty-state"><i class="bi bi-inbox"></i><h4>No Products Yet</h4><p>Click "Add Product" to add your first item</p></div></div>`;
      return;
    }
    container.innerHTML = '';
    cachedProducts.forEach(product => {
      const stockClass = product.stock > product.minStock ? 'stock-good' : (product.stock > 0 ? 'stock-low' : 'stock-out');
      const stockText  = product.stock > product.minStock ? 'In Stock' : (product.stock > 0 ? 'Low Stock' : 'Out of Stock');
      const imageUrl = product.imageUrl || ('https://via.placeholder.com/300x200?text=' + encodeURIComponent(product.name));
      const card = `
        <div class="col-md-6 col-lg-4 mb-3">
          <div class="card product-card">
            <img src="${imageUrl}" class="product-image" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
            <div class="card-body">
              <h5 class="card-title">${product.name}</h5>
              <p class="card-text text-muted mb-2"><small>${product.category} ${product.brand? '‚Ä¢ ' + product.brand : ''}</small></p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge stock-badge ${stockClass}">${stockText}</span>
                <h5 class="mb-0">Stock: ${product.stock}</h5>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Price: <strong>‚Çπ${product.price}</strong>/${product.unitType}</span>
              </div>
              <div class="card-actions">
                <button class="btn btn-primary btn-action" onclick="editProduct('${product.id}')"><i class="bi bi-pencil"></i> Edit</button>
                <button class="btn btn-danger btn-action" onclick="deleteProduct('${product.id}')"><i class="bi bi-trash"></i> Delete</button>
              </div>
            </div>
          </div>
        </div>`;
      container.innerHTML += card;
    });
  }

  function displaySalesFromCache() {
    const tbody = document.getElementById('salesList');
    if (!hasInitialLoaded) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border" role="status"></div><div class="mt-2 text-muted">Loading sales‚Ä¶</div></td></tr>`;
      return;
    }
    if (!cachedSales || cachedSales.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`;
      return;
    }
    tbody.innerHTML = '';
    const recent = cachedSales.slice(0,10);
    recent.forEach(sale => {
      const d = new Date(sale.date);
      const formatted = d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
      tbody.innerHTML += `<tr><td>${formatted}</td><td>${sale.productName}</td><td>${sale.quantity}</td><td>${sale.unitType}</td><td class="text-success fw-bold">‚Çπ${parseFloat(sale.totalAmount).toFixed(2)}</td></tr>`;
    });
  }

  function updateSummaryFromCache() {
    if (!hasInitialLoaded) {
      document.getElementById('totalProducts').textContent = 'Loading...';
      document.getElementById('salesToday').textContent = 'Loading...';
      document.getElementById('lowStock').textContent = 'Loading...';
      return;
    }
    document.getElementById('totalProducts').textContent = (cachedProducts||[]).length;
    const today = new Date().toDateString();
    const todaySales = (cachedSales||[]).filter(s=> new Date(s.date).toDateString() === today);
    const sum = todaySales.reduce((acc, s) => acc + parseFloat(s.totalAmount || 0), 0);
    document.getElementById('salesToday').textContent = '‚Çπ' + sum.toFixed(2);
    const low = (cachedProducts||[]).filter(p => p.stock <= p.minStock && p.stock > 0).length;
    document.getElementById('lowStock').textContent = low;
  }

  function loadProductsForSaleFromCache() {
    const sel = document.getElementById('saleProduct');
    sel.innerHTML = '<option value="">Choose product...</option>';
    (cachedProducts||[]).forEach(p => {
      if (p.stock > 0) sel.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.stock} ${p.unitType})</option>`;
    });
  }

  /*************************
   * CRUD operations (client side)
   * - optimistic updates locally
   * - write to Google Apps Script
   * - trigger fast polling so other devices pick up quickly
   *************************/
  function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

  // Save product to Apps Script
  async function saveProductToSheet(product, isEdit=false) {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=${isEdit? 'updateProduct':'addProduct'}`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(product)
      });
      const parsed = await safeParseResponse(res);
      if (parsed.json && parsed.json.success) {
        // trigger server cache refresh detection for others by calling sync soon
        // server invalidates getAll cache on write (Apps Script should do this)
        return parsed.json;
      } else {
        throw new Error(parsed.text || 'Save failed');
      }
    } catch (err) {
      console.error('saveProductToSheet error', err);
      return null;
    }
  }

  async function deleteProductFromSheet(id) {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=deleteProduct`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({ id })
      });
      const parsed = await safeParseResponse(res);
      return parsed.json && parsed.json.success;
    } catch (e) {
      console.error('deleteProductFromSheet error', e);
      return false;
    }
  }

  async function saveSaleToSheet(sale) {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=addSale`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(sale)
      });
      const parsed = await safeParseResponse(res);
      return parsed.json && parsed.json.success ? parsed.json : null;
    } catch (e) {
      console.error('saveSaleToSheet error', e);
      return null;
    }
  }

  /***** UI CRUD handlers *****/
  let editingProductId = null;

  function showAddProduct() {
    editingProductId = null;
    document.getElementById('modalTitle').textContent = 'Add New Product';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
  }

  function editProduct(id) {
    const p = (cachedProducts||[]).find(x=>x.id===id);
    if (!p) { alert('‚ùå Product not found!'); return; }
    editingProductId = id;
    document.getElementById('modalTitle').textContent = 'Edit Product';
    document.getElementById('productId').value = p.id;
    document.getElementById('productName').value = p.name;
    document.getElementById('category').value = p.category;
    document.getElementById('brand').value = p.brand||'';
    document.getElementById('size').value = p.size||'';
    document.getElementById('unitType').value = p.unitType;
    document.getElementById('piecesPerBox').value = p.piecesPerBox||1;
    document.getElementById('sftPerBox').value = p.sftPerBox||'';
    document.getElementById('price').value = p.price;
    document.getElementById('stock').value = p.stock;
    document.getElementById('minStock').value = p.minStock;
    document.getElementById('imageUrl').value = p.imageUrl||'';
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
  }

  async function saveProduct() {
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value.trim();
    const size = document.getElementById('size').value.trim();
    const unitType = document.getElementById('unitType').value;
    const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
    const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const minStock = parseInt(document.getElementById('minStock').value) || 5;
    const imageUrl = document.getElementById('imageUrl').value.trim();

    if (!name || !category || isNaN(price) || isNaN(stock) || stock < 0) { alert('‚ùå Please fill required fields'); return; }

    const product = {
      id: editingProductId || generateId(),
      name, category, brand, size, unitType,
      piecesPerBox, sftPerBox, price, stock, minStock, imageUrl
    };

    // optimistic local update
    const idx = (cachedProducts||[]).findIndex(p=>p.id===product.id);
    const prev = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
    if (idx !== -1) cachedProducts[idx] = product; else cachedProducts.push(product);
    displayProductsFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache();

    // close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal')); if (modal) modal.hide();

    // write to server (fire & forget but we check response)
    showSyncIndicator('Saving...', 'syncing');
    const serverResp = await saveProductToSheet(product, !!editingProductId);
    // trigger fast polling so other devices fetch the update quickly
    triggerFastPolling();

    if (serverResp && serverResp.success) {
      // if server returned new id (for add), update local id
      if (!editingProductId && serverResp.id) {
        const localIdx = cachedProducts.findIndex(p=>p.id===product.id);
        if (localIdx !== -1) { cachedProducts[localIdx].id = serverResp.id; product.id = serverResp.id; displayProductsFromCache(); loadProductsForSaleFromCache(); updateSummaryFromCache(); }
      }
      showSyncIndicator('Saved', 'success');
      editingProductId = null;
      setTimeout(()=> alert('‚úÖ Product saved'), 300);
    } else {
      // revert optimistic
      if (prev) cachedProducts[idx] = prev; else cachedProducts = (cachedProducts||[]).filter(p=>p.id!==product.id);
      displayProductsFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache();
      alert('‚ùå Save failed ‚Äî changes reverted locally. Check console for errors.');
    }
  }

  function deleteProduct(id) {
    if (!confirm('Are you sure?')) return;
    const prev = cachedProducts.slice();
    cachedProducts = (cachedProducts||[]).filter(p=>p.id!==id);
    displayProductsFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache();
    showSyncIndicator('Deleting...', 'syncing');
    // trigger fast polling (so other clients pick change quickly)
    triggerFastPolling();
    deleteProductFromSheet(id).then(success => {
      if (success) { showSyncIndicator('Deleted', 'success'); setTimeout(()=> alert('‚úÖ Deleted'), 300); }
      else { cachedProducts = prev; displayProductsFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache(); alert('‚ùå Delete failed ‚Äî reverted locally.'); }
    });
  }

  // SALES
  let totalEdited = false;
  function showSalesSection() { loadProductsForSaleFromCache(); document.getElementById('salesForm').reset(); document.getElementById('saleTotal').value=''; document.getElementById('saleUnitPrice').value=''; totalEdited=false; const modal = new bootstrap.Modal(document.getElementById('salesModal')); modal.show(); }
  function updateSalePriceInstant(){
    if (totalEdited) return;
    const pid = document.getElementById('saleProduct').value;
    const qty = parseInt(document.getElementById('saleQuantity').value) || 0;
    if (!pid || qty<=0){ document.getElementById('saleTotal').value=''; document.getElementById('saleUnitPrice').value=''; return; }
    const product = (cachedProducts||[]).find(p=>p.id===pid);
    if (!product) return;
    if (qty>product.stock){ alert(`‚ùå Only ${product.stock} available`); document.getElementById('saleQuantity').value=product.stock; return; }
    document.getElementById('saleTotal').value = (product.price * qty).toFixed(2);
    document.getElementById('saleUnitPrice').value = '‚Çπ'+product.price+'/'+product.unitType;
  }
  function markTotalAsEdited(){ totalEdited=true; }

  async function recordSale(){
    const pid = document.getElementById('saleProduct').value;
    const qty = parseInt(document.getElementById('saleQuantity').value);
    const totalAmount = parseFloat(document.getElementById('saleTotal').value);
    if (!pid || !qty || qty<=0 || !totalAmount){ alert('‚ùå Fill sale details'); return; }
    const product = (cachedProducts||[]).find(p=>p.id===pid);
    if (!product) { alert('‚ùå Product not found'); return; }
    if (qty>product.stock){ alert('‚ùå Insufficient stock'); return; }

    const sale = { id: generateId(), productId: product.id, productName: product.name, quantity: qty, unitType: product.unitType, totalAmount: totalAmount, date: new Date().toISOString() };

    // optimistic update
    product.stock -= qty;
    cachedSales.unshift(sale);
    displayProductsFromCache(); displaySalesFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache();

    const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal')); if (modal) modal.hide();

    showSyncIndicator('Saving sale...', 'syncing');
    // fast poll so other devices pick up change quickly
    triggerFastPolling();
    const resp = await saveSaleToSheet(sale);
    if (resp && resp.success) {
      showSyncIndicator('Saved', 'success'); setTimeout(()=> alert(`‚úÖ Sale recorded: ‚Çπ${totalAmount.toFixed(2)}`), 300);
    } else {
      // revert optimistic
      cachedSales = cachedSales.filter(s=>s.id!==sale.id);
      const prod = (cachedProducts||[]).find(p=>p.id===pid);
      if (prod) prod.stock += qty;
      displayProductsFromCache(); displaySalesFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache();
      alert('‚ùå Sale save failed ‚Äî reverted locally.');
    }
  }

  /*************************
   * Search / backup / import
   *************************/
  function searchProducts(){
    const term = (document.getElementById('searchInput').value||'').toLowerCase();
    const filtered = (cachedProducts||[]).filter(p=> p.name.toLowerCase().includes(term) || (p.brand && p.brand.toLowerCase().includes(term)) || p.category.toLowerCase().includes(term));
    const container = document.getElementById('productsList');
    if (!filtered || filtered.length===0) {
      container.innerHTML = `<div class="col-12"><div class="empty-state"><i class="bi bi-search"></i><h4>No Results Found</h4><p>Try different search terms</p></div></div>`; return;
    }
    container.innerHTML = '';
    filtered.forEach(product=>{
      const stockClass = product.stock > product.minStock ? 'stock-good' : (product.stock>0 ? 'stock-low':'stock-out');
      const stockText = product.stock > product.minStock ? 'In Stock' : (product.stock>0 ? 'Low Stock':'Out of Stock');
      const imageUrl = product.imageUrl || ('https://via.placeholder.com/300x200?text='+encodeURIComponent(product.name));
      const card = `<div class="col-md-6 col-lg-4 mb-3"><div class="card product-card"><img src="${imageUrl}" class="product-image" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'"><div class="card-body"><h5 class="card-title">${product.name}</h5><p class="card-text text-muted mb-2"><small>${product.category} ${product.brand? '‚Ä¢ '+product.brand : ''}</small></p><div class="d-flex justify-content-between align-items-center mb-2"><span class="badge stock-badge ${stockClass}">${stockText}</span><h5 class="mb-0">Stock: ${product.stock}</h5></div><div class="d-flex justify-content-between align-items-center mb-3"><span>Price: <strong>‚Çπ${product.price}</strong>/${product.unitType}</span></div><div class="card-actions"><button class="btn btn-primary btn-action" onclick="editProduct('${product.id}')"><i class="bi bi-pencil"></i> Edit</button><button class="btn btn-danger btn-action" onclick="deleteProduct('${product.id}')"><i class="bi bi-trash"></i> Delete</button></div></div></div></div>`;
      container.innerHTML += card;
    });
  }

  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('‚úÖ Backup downloaded');
  }

  function importData(){ document.getElementById('fileInput').click(); }

  function handleFileImport(e){
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try {
        const data = JSON.parse(evt.target.result);
        if (data.products) cachedProducts = data.products;
        if (data.sales) cachedSales = data.sales;
        displayProductsFromCache(); displaySalesFromCache(); updateSummaryFromCache(); loadProductsForSaleFromCache();
        alert('‚úÖ Data restored (local)');
      } catch(err){ alert('‚ùå Invalid file'); }
    };
    reader.readAsText(file);
  }

  /*************************
   * Initialization
   *************************/
  // Start polling logic and initial sync
  (function init(){
    // initial display placeholders
    displayProductsFromCache();
    displaySalesFromCache();
    updateSummaryFromCache();

    // start polling (normal)
    schedulePolling();
    // run an immediate sync now
    syncFromGoogleSheets();
  })();

  // schedulePolling defined earlier, but we need to call it here (define now)
  function schedulePolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async () => {
      // if within FAST_POLL_DURATION after local change, faster path is handled by triggerFastPolling
      await syncFromGoogleSheets();
    }, pollInterval);
  }

  // triggerFastPolling already defined

  // visibility-based sync
  document.addEventListener('visibilitychange', () => { if (!document.hidden) syncFromGoogleSheets(); });
  </script>
</body>
</html>

