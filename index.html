<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tile & Sanitaryware Inventory</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

/* Toast Notification Styles */
.toast-container {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 9999;
}

.toast {
    min-width: 250px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 16px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    animation: slideIn 0.3s ease-out;
}

.toast-success {
    border-left: 4px solid #28a745;
}

.toast-warning {
    border-left: 4px solid #ffc107;
}

.toast-error {
    border-left: 4px solid #dc3545;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

        
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            border: 1px solid #dee2e6;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #e9ecef;
        }
        .stock-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }
        .stock-good {
            background-color: #28a745;
            color: white;
        }
        .stock-low {
            background-color: #ffc107;
            color: black;
        }
        .stock-out {
            background-color: #dc3545;
            color: white;
        }
        .card-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-action {
            flex: 1;
        }
        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.2rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .btn-lg {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            .product-image {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    
    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory
            </span>
            <div>
                <button class="btn btn-light btn-sm me-2" onclick="exportData()">
                    <i class="bi bi-download"></i> Backup
                </button>
                <button class="btn btn-light btn-sm" onclick="importData()">
                    <i class="bi bi-upload"></i> Restore
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        
        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()">
                    <i class="bi bi-plus-circle"></i> Add Product
                </button>
                <button class="btn btn-info btn-lg mb-2" onclick="showSalesSection()">
                    <i class="bi bi-cart-check"></i> Record Sale
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-box-seam text-primary" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalProducts">0</h3>
                        <p class="text-muted mb-0">Total Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-currency-rupee text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="salesToday">‚Çπ0</h3>
                        <p class="text-muted mb-0">Sales Today</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="lowStock">0</h3>
                        <p class="text-muted mb-0">Low Stock Items</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="row mb-3">
            <div class="col-md-6 mx-auto">
                <input type="text" class="form-control form-control-lg" id="searchInput" 
                       placeholder="üîç Search products by name or brand..." 
                       onkeyup="searchProducts()">
            </div>
        </div>

        <!-- Products Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">Products Inventory</h4>
                <div class="row" id="productsList">
                    <!-- Products will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Recent Sales Section -->
        <div class="row">
            <div class="col-12">
                <h4 class="mb-3">Recent Sales</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Date & Time</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesList">
                            <!-- Sales will be displayed here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select</option>
                                    <option value="Tiles">Tiles</option>
                                    <option value="Sanitaryware">Sanitaryware</option>
                                    <option value="Accessories">Accessories</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Brand</label>
                                <input type="text" class="form-control" id="brand">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Size</label>
                                <input type="text" class="form-control" id="size" placeholder="e.g., 2x2 feet">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Unit Type *</label>
                                <select class="form-select" id="unitType" required>
                                    <option value="Box">Box</option>
                                    <option value="Piece">Piece</option>
                                    <option value="SFT">Square Feet</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pieces per Box</label>
                                <input type="number" class="form-control" id="piecesPerBox" value="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">SFT per Box</label>
                                <input type="number" class="form-control" id="sftPerBox" step="0.01">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Price per Unit *</label>
                                <input type="number" class="form-control" id="price" required step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Stock *</label>
                                <input type="number" class="form-control" id="stock" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Minimum Stock</label>
                                <input type="number" class="form-control" id="minStock" value="5">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Product Image URL (optional)</label>
                            <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Modal -->
    <div class="modal fade" id="salesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Record New Sale</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="salesForm">
                        <div class="mb-3">
                            <label class="form-label">Select Product *</label>
                            <select class="form-select" id="saleProduct" onchange="updateSalePrice()" required>
                                <option value="">Choose product...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="saleQuantity" 
                                   onkeyup="updateSalePrice()" required min="1">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Unit Price</label>
                            <input type="text" class="form-control" id="saleUnitPrice" readonly>
                        </div>

                        <div class="mb-3">
                            <h4>Total Amount: <span class="text-success" id="saleTotal">‚Çπ0</span></h4>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="recordSale()">Complete Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ALL JavaScript Code Here -->
    <script>
    // ========== GOOGLE SHEETS API FUNCTIONS ==========

// **PASTE YOUR WEB APP URL HERE**
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfBwn8BRffSh20VCTr1ANbEi8HFwgQXB_62I9Ct1s3ROCuA6xlHOzlF3fMZoxL7Aur/exec';

// Get products from Google Sheets
async function getProducts() {
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts`);
        const data = await response.json();
        return data.products || [];
    } catch (error) {
        console.error('Error getting products:', error);
        alert('‚ùå Error loading products. Check console.');
        return [];
    }
}

// Save product to Google Sheets
async function saveProductToSheet(product) {
    try {
        const action = product.id ? 'updateProduct' : 'addProduct';
        
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=${action}`, {
            method: 'POST',
            body: JSON.stringify(product)
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error saving product:', error);
        alert('‚ùå Error saving product. Check console.');
        return {error: true};
    }
}

async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    // Show instant feedback
    showToast('‚úÖ Product deleted! Syncing...', 'success');
    
    // Remove from display immediately (Optimistic UI)
    await displayProducts();
    await updateSummary();
    await loadProductsForSale();
    
    // Delete from Google Sheets in background
    deleteProductFromSheet(id).then(result => {
        if (result.error) {
            showToast('‚ö†Ô∏è Warning: Failed to delete from Google Sheets.', 'warning');
            // Reload data to show correct state
            displayProducts();
        } else {
            showToast('‚úÖ Deleted from Google Sheets!', 'success');
        }
    });
}


// Get sales from Google Sheets
async function getSales() {
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales`);
        const data = await response.json();
        return data.sales || [];
    } catch (error) {
        console.error('Error getting sales:', error);
        return [];
    }
}

// Save sale to Google Sheets
async function saveSaleToSheet(sale) {
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=addSale`, {
            method: 'POST',
            body: JSON.stringify(sale)
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error saving sale:', error);
        return {error: true};
    }
}

// Generate unique ID (not needed anymore, server generates it)
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}


        // ========== PRODUCT FUNCTIONS ==========
        
        let editingProductId = null;
async function displayProducts() {
    const products = await getProducts();
    const productsList = document.getElementById('productsList');
    
    if (products.length === 0) {
        productsList.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>No Products Yet</h4>
                    <p>Click "Add Product" to add your first item</p>
                </div>
            </div>
        `;
        return;
    }
    
    productsList.innerHTML = '';
    
    products.forEach(product => {
        const stockClass = product.stock > product.minStock ? 'stock-good' : 
                          product.stock > 0 ? 'stock-low' : 'stock-out';
        
        const stockText = product.stock > product.minStock ? 'In Stock' : 
                         product.stock > 0 ? 'Low Stock' : 'Out of Stock';
        
        const imageUrl = product.imageUrl || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(product.name);
        
        const card = `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card product-card">
                    <img src="${imageUrl}" class="product-image" alt="${product.name}" 
                         onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-text text-muted mb-2">
                            <small>${product.category} ${product.brand ? '‚Ä¢ ' + product.brand : ''}</small>
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge stock-badge ${stockClass}">${stockText}</span>
                            <h5 class="mb-0">Stock: ${product.stock}</h5>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Price: <strong>‚Çπ${product.price}</strong>/${product.unitType}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary btn-action" onclick="editProduct('${product.id}')">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-action" onclick="deleteProduct('${product.id}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        productsList.innerHTML += card;
    });
}

function showAddProduct() {
    try {
        // Find the add product button
        const addBtn = event.target.closest('button');
        if (addBtn) {
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Opening...';
        }
        
        // Reset form and state
        editingProductId = null;
        document.getElementById('modalTitle').textContent = 'Add New Product';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        
        // Open modal immediately
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
        // Restore button after 500ms
        setTimeout(() => {
            if (addBtn) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add Product';
            }
        }, 500);
        
    } catch (error) {
        console.error('Error opening add product modal:', error);
        setTimeout(() => {
            const addBtn = document.querySelector('.btn-success');
            if (addBtn) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add Product';
            }
        }, 500);
    }
}


      async function editProduct(id) {
    try {
        // Find the edit button
        const editBtn = event.target.closest('button');
        if (editBtn) {
            editBtn.disabled = true;
            editBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
        }
        
        const products = await getProducts();
        const product = products.find(p => p.id === id);
        
        if (!product) {
            alert('‚ùå Product not found!');
            if (editBtn) {
                editBtn.disabled = false;
                editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
            }
            return;
        }
        
        editingProductId = id;
        document.getElementById('modalTitle').textContent = 'Edit Product';
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('category').value = product.category;
        document.getElementById('brand').value = product.brand || '';
        document.getElementById('size').value = product.size || '';
        document.getElementById('unitType').value = product.unitType;
        document.getElementById('piecesPerBox').value = product.piecesPerBox || 1;
        document.getElementById('sftPerBox').value = product.sftPerBox || '';
        document.getElementById('price').value = product.price;
        document.getElementById('stock').value = product.stock;
        document.getElementById('minStock').value = product.minStock;
        document.getElementById('imageUrl').value = product.imageUrl || '';
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
        // Restore button after modal opens
        setTimeout(() => {
            if (editBtn) {
                editBtn.disabled = false;
                editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
            }
        }, 500);
        
    } catch (error) {
        console.error('Edit error:', error);
        alert('‚ùå Error loading product data');
    }
}

async function saveProduct() {
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value.trim();
    const size = document.getElementById('size').value.trim();
    const unitType = document.getElementById('unitType').value;
    const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
    const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const minStock = parseInt(document.getElementById('minStock').value) || 5;
    const imageUrl = document.getElementById('imageUrl').value.trim();
    
    if (!name || !category || !price || stock < 0) {
        alert('‚ùå Please fill all required fields!');
        return;
    }
    
    const product = {
        id: editingProductId || generateId(),
        name, category, brand, size, unitType,
        piecesPerBox, sftPerBox, price, stock, minStock, imageUrl
    };
    
    try {
        // Get the save button
        const saveBtn = document.querySelector('#productModal .btn-primary');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
        }
        
        // FIRE AND FORGET: Send to Google Sheets in background (don't wait)
        saveProductToSheet(product); // No await - fire and forget!
        
        // Close modal IMMEDIATELY
        const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        modal.hide();
        
        // Update display from local cache immediately
        displayProducts();
        updateSummary();
        loadProductsForSale();
        
        // Restore button and show success after 1.5 seconds
        setTimeout(() => {
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Product';
            }
            alert('‚úÖ Product saved successfully!');
        }, 1500);
        
    } catch (error) {
        console.error('Error saving product:', error);
        
        // Restore button even on error
        setTimeout(() => {
            const saveBtn = document.querySelector('#productModal .btn-primary');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Product';
            }
            alert('‚ùå Error: ' + (error.message || 'Failed to save product'));
        }, 1000);
    }
}


async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    try {
        // Find the delete button that was clicked
        const deleteBtn = event.target.closest('button');
        if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
        }
        
        // FIRE AND FORGET: Delete from Google Sheets in background
        deleteProductFromSheet(id); // No await - fire and forget!
        
        // Update display IMMEDIATELY
        displayProducts();
        updateSummary();
        loadProductsForSale();
        
        // Show success after 1.5 seconds
        setTimeout(() => {
            alert('‚úÖ Product deleted successfully!');
        }, 1500);
        
    } catch (error) {
        console.error('Delete error:', error);
        
        setTimeout(() => {
            alert('‚ùå Error: ' + (error.message || 'Failed to delete product'));
            // Reload data to show correct state
            displayProducts();
        }, 1000);
    }
}



        async function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const products = await getProducts();
    
    const filtered = products.filter(p => 
        p.name.toLowerCase().includes(searchTerm) ||
        (p.brand && p.brand.toLowerCase().includes(searchTerm)) ||
        p.category.toLowerCase().includes(searchTerm)
    );
    
    const productsList = document.getElementById('productsList');
    
    if (filtered.length === 0) {
        productsList.innerHTML = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="bi bi-search"></i>
                    <h4>No Results Found</h4>
                    <p>Try different search terms</p>
                </div>
            </div>
        `;
        return;
    }
    
    productsList.innerHTML = '';
    
    filtered.forEach(product => {
        const stockClass = product.stock > product.minStock ? 'stock-good' : 
                          product.stock > 0 ? 'stock-low' : 'stock-out';
        
        const stockText = product.stock > product.minStock ? 'In Stock' : 
                         product.stock > 0 ? 'Low Stock' : 'Out of Stock';
        
        const imageUrl = product.imageUrl || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(product.name);
        
        const card = `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card product-card">
                    <img src="${imageUrl}" class="product-image" alt="${product.name}"
                         onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-text text-muted mb-2">
                            <small>${product.category} ${product.brand ? '‚Ä¢ ' + product.brand : ''}</small>
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge stock-badge ${stockClass}">${stockText}</span>
                            <h5 class="mb-0">Stock: ${product.stock}</h5>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Price: <strong>‚Çπ${product.price}</strong>/${product.unitType}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary btn-action" onclick="editProduct('${product.id}')">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-action" onclick="deleteProduct('${product.id}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        productsList.innerHTML += card;
    });
}


        // ========== SALES FUNCTIONS ==========
        
      async function loadProductsForSale() {
    const products = await getProducts();
    const select = document.getElementById('saleProduct');
    
    select.innerHTML = '<option value="">Choose product...</option>';
    
    products.forEach(product => {
        if (product.stock > 0) {
            select.innerHTML += `
                <option value="${product.id}">
                    ${product.name} (Stock: ${product.stock} ${product.unitType})
                </option>
            `;
        }
    });
}

      async function showSalesSection() {
    try {
        // Find the record sale button
        const saleBtn = event.target.closest('button');
        if (saleBtn) {
            saleBtn.disabled = true;
            saleBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Opening...';
        }
        
        // Load products and reset form
        await loadProductsForSale();
        document.getElementById('salesForm').reset();
        document.getElementById('saleTotal').textContent = '‚Çπ0';
        document.getElementById('saleUnitPrice').value = '';
        
        // Open modal immediately
        const modal = new bootstrap.Modal(document.getElementById('salesModal'));
        modal.show();
        
        // Restore button after 500ms
        setTimeout(() => {
            if (saleBtn) {
                saleBtn.disabled = false;
                saleBtn.innerHTML = '<i class="bi bi-cart-check"></i> Record Sale';
            }
        }, 500);
        
    } catch (error) {
        console.error('Error opening sales modal:', error);
        setTimeout(() => {
            const saleBtn = document.querySelector('.btn-info');
            if (saleBtn) {
                saleBtn.disabled = false;
                saleBtn.innerHTML = '<i class="bi bi-cart-check"></i> Record Sale';
            }
        }, 500);
    }
}

        async function updateSalePrice() {
    const productId = document.getElementById('saleProduct').value;
    const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
    
    if (!productId || quantity <= 0) {
        document.getElementById('saleTotal').textContent = '‚Çπ0';
        document.getElementById('saleUnitPrice').value = '';
        return;
    }
    
    const products = await getProducts();
    const product = products.find(p => p.id === productId);
    
    if (!product) return;
    
    // Check if quantity exceeds stock
    if (quantity > product.stock) {
        alert(`‚ùå Only ${product.stock} ${product.unitType} available in stock!`);
        document.getElementById('saleQuantity').value = product.stock;
        return;
    }
    
    const total = product.price * quantity;
    document.getElementById('saleTotal').textContent = '‚Çπ' + total.toFixed(2);
    document.getElementById('saleUnitPrice').value = '‚Çπ' + product.price + '/' + product.unitType;
}

      async function recordSale() {
    const productId = document.getElementById('saleProduct').value;
    const quantity = parseInt(document.getElementById('saleQuantity').value);
    
    if (!productId || !quantity || quantity <= 0) {
        alert('‚ùå Please select product and enter quantity!');
        return;
    }
    
    const products = await getProducts();
    const product = products.find(p => p.id === productId);
    
    if (!product) {
        alert('‚ùå Product not found!');
        return;
    }
    
    if (quantity > product.stock) {
        alert(`‚ùå Insufficient stock! Only ${product.stock} available.`);
        return;
    }
    
    const total = product.price * quantity;
    
    const sale = {
        productId: product.id,
        productName: product.name,
        quantity: quantity,
        unitType: product.unitType,
        totalAmount: total
    };
    
    try {
        // Get the complete sale button
        const saleBtn = document.querySelector('#salesModal .btn-success');
        if (saleBtn) {
            saleBtn.disabled = true;
            saleBtn.textContent = 'Processing...';
        }
        
        // FIRE AND FORGET: Submit sale in background
        saveSaleToSheet(sale); // No await - fire and forget!
        
        // Close modal IMMEDIATELY
        const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
        modal.hide();
        
        // Reset form immediately
        document.getElementById('salesForm').reset();
        document.getElementById('saleTotal').textContent = '‚Çπ0';
        document.getElementById('saleUnitPrice').value = '';
        
        // Update displays immediately
        displayProducts();
        displaySales();
        updateSummary();
        loadProductsForSale();
        
        // Restore button and show success after 1.5 seconds
        setTimeout(() => {
            if (saleBtn) {
                saleBtn.disabled = false;
                saleBtn.textContent = 'Complete Sale';
            }
            alert(`‚úÖ Sale recorded successfully!\nTotal: ‚Çπ${total.toFixed(2)}`);
        }, 1500);
        
    } catch (error) {
        console.error('Sale recording error:', error);
        
        // Restore button even on error
        setTimeout(() => {
            const saleBtn = document.querySelector('#salesModal .btn-success');
            if (saleBtn) {
                saleBtn.disabled = false;
                saleBtn.textContent = 'Complete Sale';
            }
            alert('‚ùå Error: ' + (error.message || 'Failed to record sale'));
        }, 1000);
    }
}



        async function displaySales() {
    const sales = await getSales();
    const salesList = document.getElementById('salesList');
    
    if (sales.length === 0) {
        salesList.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    No sales recorded yet
                </td>
            </tr>
        `;
        return;
    }
    
    salesList.innerHTML = '';
    
    // Show last 10 sales (reverse order - newest first)
    const recentSales = sales.slice(0, 10).reverse();
    
    recentSales.forEach(sale => {
        const date = new Date(sale.date);
        const formattedDate = date.toLocaleDateString('en-IN') + ' ' + 
                             date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
        
        const row = `
            <tr>
                <td>${formattedDate}</td>
                <td>${sale.productName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.unitType}</td>
                <td class="text-success fw-bold">‚Çπ${parseFloat(sale.totalAmount).toFixed(2)}</td>
            </tr>
        `;
        
        salesList.innerHTML += row;
    });
}

        // Clear product form (called after successful save)
function clearProductForm() {
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    editingProductId = null;
}

// Clear sales form (called after successful sale)
function clearSalesForm() {
    document.getElementById('salesForm').reset();
    document.getElementById('saleTotal').textContent = '‚Çπ0';
    document.getElementById('saleUnitPrice').value = '';
}
// Restore buttons when modals are closed
document.getElementById('productModal').addEventListener('hidden.bs.modal', function () {
    const saveBtn = document.querySelector('#productModal .btn-primary');
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Product';
    }
    clearProductForm();
    
});

document.getElementById('salesModal').addEventListener('hidden.bs.modal', function () {
    const saleBtn = document.querySelector('#salesModal .btn-success');
    if (saleBtn) {
        saleBtn.disabled = false;
        saleBtn.textContent = 'Complete Sale';
    }
    clearSalesForm();
});


        // Toast notification system
function showToast(message, type = 'success') {
    // Create container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div style="flex: 1;">${message}</div>
        <button onclick="this.parentElement.remove()" style="border: none; background: none; font-size: 20px; cursor: pointer; margin-left: 10px;">&times;</button>
    `;
    
    container.appendChild(toast);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
// Local cache for instant display
let cachedProducts = [];
let cachedSales = [];
let cacheTimestamp = 0;
const CACHE_DURATION = 5000; // 5 seconds

// Modified getProducts with cache
async function getProducts() {
    const now = Date.now();
    
    // Return cached data if fresh
    if (cachedProducts.length > 0 && (now - cacheTimestamp) < CACHE_DURATION) {
        return cachedProducts;
    }
    
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts`);
        const data = await response.json();
        cachedProducts = data.products || [];
        cacheTimestamp = now;
        return cachedProducts;
    } catch (error) {
        console.error('Error getting products:', error);
        // Return cached data even if expired
        return cachedProducts;
    }
}

// Modified getSales with cache
async function getSales() {
    const now = Date.now();
    
    if (cachedSales.length > 0 && (now - cacheTimestamp) < CACHE_DURATION) {
        return cachedSales;
    }
    
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales`);
        const data = await response.json();
        cachedSales = data.sales || [];
        return cachedSales;
    } catch (error) {
        console.error('Error getting sales:', error);
        return cachedSales;
    }
}

// Helper function to update local cache
function updateLocalCache(product) {
    const index = cachedProducts.findIndex(p => p.id === product.id);
    if (index !== -1) {
        cachedProducts[index] = product;
    } else {
        cachedProducts.push(product);
    }
}

function removeFromLocalCache(productId) {
    cachedProducts = cachedProducts.filter(p => p.id !== productId);
}

function addSaleToLocalCache(sale) {
    cachedSales.unshift(sale);
}



        // ========== APP FUNCTIONS ==========
        
        async function updateSummary() {
    const products = await getProducts();
    const sales = await getSales();
    
    // Total products
    document.getElementById('totalProducts').textContent = products.length;
    
    // Sales today
    const today = new Date().toDateString();
    const todaySales = sales.filter(sale => {
        const saleDate = new Date(sale.date).toDateString();
        return saleDate === today;
    });
    
    const totalSalesToday = todaySales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);
    document.getElementById('salesToday').textContent = '‚Çπ' + totalSalesToday.toFixed(2);
    
    // Low stock items
    const lowStockItems = products.filter(p => p.stock <= p.minStock && p.stock > 0);
    document.getElementById('lowStock').textContent = lowStockItems.length;
}


      window.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Tile & Sanitaryware Inventory App Loaded');
    
    // Display all data
    await displayProducts();
    await displaySales();
    await updateSummary();
    await loadProductsForSale();
    
    // Setup modal close event listeners for button restoration
    const productModal = document.getElementById('productModal');
    const salesModal = document.getElementById('salesModal');
    
    if (productModal) {
        productModal.addEventListener('hidden.bs.modal', function () {
            const saveBtn = document.querySelector('#productModal .btn-primary');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Product';
            }
            clearProductForm();
        });
    }
    
    if (salesModal) {
        salesModal.addEventListener('hidden.bs.modal', function () {
            const saleBtn = document.querySelector('#salesModal .btn-success');
            if (saleBtn) {
                saleBtn.disabled = false;
                saleBtn.textContent = 'Complete Sale';
            }
            clearSalesForm();
        });
    }
    
    console.log('‚úÖ App initialized with fire-and-forget pattern!');
});


        

    </script>

</body>
</html>



