<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tile & Sanitaryware Inventory</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    .table-explorer { background:#fff; border-radius:6px; overflow:hidden; }
    .file-icon { font-size:1.15rem; display:inline-block; width:1.6rem; text-align:center; }
    .stock-badge{font-size:.85rem;padding:.25rem .5rem;border-radius:.5rem}
    .mobile-list{display:none}
    .mobile-item{background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.7rem;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .btn-action-sm{padding:.25rem .5rem;font-size:.85rem}
    .sync-indicator{position:fixed;top:70px;left:20px;background:#fff;padding:8px 12px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:none;z-index:1000}
    /* Sales grid mobile transforms */
@media (max-width:768px) {
  .desktop-table { display:none !important; }
  .mobile-list { display:block !important; }
  /* Make table rows card-like */
  .grid-table thead { display:none; }
  .grid-table tbody tr { display:block; margin-bottom:12px; padding:12px; border:1px solid #e9ecef; border-radius:8px; background:#fff; }
  .grid-table td { display:block; width:100%; padding:.35rem 0; border:0; }
  .grid-row-number { float:right; font-size:.85rem; color:#6c757d; }
  .product-select, .qty-input, .price-input { width:100% !important; font-size:16px; height:44px; }
  .mobile-two-col { display:flex; gap:10px; }
  .mobile-two-col > div { flex:1; }
  .modal-dialog { margin:.5rem; max-width: calc(100% - 1rem); }
  .modal-body { max-height: calc(100vh - 200px); overflow-y:auto; -webkit-overflow-scrolling: touch; }
  .modal-footer { position: sticky; bottom:0; background: white; z-index:10; box-shadow:0 -2px 10px rgba(0,0,0,.08); }
}

/* ✅ NEW: Mobile Recent Sales Table Optimization */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.75rem;
        overflow-x: auto;
    }
    
    #salesList td {
        padding: 0.4rem 0.2rem !important;
        font-size: 0.75rem;
    }
    
    #salesList th {
        padding: 0.5rem 0.2rem !important;
        font-size: 0.8rem;
    }
    
    #salesList td:nth-child(1),
    #salesList th:nth-child(1) {
        max-width: 85px;
        word-wrap: break-word;
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    #salesList td:nth-child(2),
    #salesList th:nth-child(2) {
        max-width: 110px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #salesList td:nth-child(3),
    #salesList th:nth-child(3) {
        text-align: center;
        max-width: 45px;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(4),
    #salesList th:nth-child(4) {
        text-align: center;
        max-width: 45px;
        font-size: 0.7rem;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(5) {
        font-weight: bold;
        color: #28a745;
        font-size: 0.85rem;
        text-align: right;
        max-width: 80px;
    }
    
    #salesList th:nth-child(5) {
        text-align: right;
        max-width: 80px;
    }
}

  </style>
</head>
<body>
  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator"><i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span></div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm me-2" onclick="manualRefresh()"><i id="refreshIcon" class="bi bi-arrow-clockwise"></i> Refresh</button>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Actions -->
    <div class="row mb-4">
      <div class="col-12 text-center">
        <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()"><i class="bi bi-plus-circle"></i> Add Product</button>
        <button class="btn btn-info btn-lg mb-2" onclick="openSalesModal()"><i class="bi bi-cart-check"></i> Record Sale</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-box-seam text-primary" style="font-size:2rem"></i><h3 id="totalProducts" class="mt-2">0</h3><p class="text-muted mb-0">Total Products</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-currency-rupee text-success" style="font-size:2rem"></i><h3 id="salesToday" class="mt-2">₹0</h3><p class="text-muted mb-0">Sales Today</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem"></i><h3 id="lowStock" class="mt-2">0</h3><p class="text-muted mb-0">Low Stock Items</p></div></div></div>
    </div>

    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <input id="searchInput" class="form-control form-control-lg" placeholder="ðŸ” Search products by name, brand or size..." onkeyup="searchProducts()">
      </div>
    </div>

    <!-- Products table (desktop) & mobile list -->
    <div class="row mb-4">
      <div class="col-12 desktop-table">
        <div class="table-explorer">
          <table class="table table-sm table-striped mb-0">
            <thead><tr><th style="width:50px">Icon</th><th>Product</th><th>Category</th><th>Brand</th><th>Size</th><th style="width:120px">Stock</th><th style="width:140px">Price</th><th style="width:150px">Actions</th></tr></thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;"></div>
    </div>

  <!-- Recent Sales -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Recent Sales</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="openClearSalesPopup()">
                <i class="bi bi-trash"></i> Clear Sales
            </button>
        </div>
        <div class="table-responsive">

          <table class="table table-striped">
            <thead class="table-primary"><tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr></thead>
            <tbody id="salesList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!--  Sales Modal -->
<div class="modal fade" id="clearSalesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Clear Sales History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Clear sales records between specific dates:</p>
                
                <div class="mb-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" class="form-control" id="clearFromDate" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" class="form-control" id="clearToDate" required>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This will clear sales from display only. 
                    Google Sheets data remains unchanged.
                </div>
                
                <div id="clearSalesCount" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    Found <strong id="salesCountNumber">0</strong> sales records in this date range.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearSalesInDateRange()">
                    <i class="bi bi-trash"></i> Clear Sales
                </button>
            </div>
        </div>
    </div>
</div>


  <!-- Add/Edit Product Modal (image removed) -->
  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 id="modalTitle" class="modal-title">Add New Product</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row mb-3">
          <div class="col-md-8"><label class="form-label">Product Name *</label><input id="productName" class="form-control" required/></div>
          <div class="col-md-4"><label class="form-label">Category *</label><select id="category" class="form-select" required><option value="">Select</option><option value="Tiles">Tiles</option><option value="Sanitaryware">Sanitaryware</option><option value="Accessories">Accessories</option></select></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><label class="form-label">Brand</label><input id="brand" class="form-control"/></div>
          <div class="col-md-6"><label class="form-label">Size</label><input id="size" class="form-control" placeholder="e.g., 2x2 feet or Standard"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Unit Type *</label><select id="unitType" class="form-select" required><option value="Box">Box</option><option value="Piece">Piece</option><option value="SFT">Square Feet</option></select></div>
          <div class="col-md-4"><label class="form-label">Pieces per Box</label><input id="piecesPerBox" class="form-control" type="number" value="1"/></div>
          <div class="col-md-4"><label class="form-label">SFT per Box</label><input id="sftPerBox" class="form-control" type="number" step="0.01"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Price per Unit *</label><input id="price" class="form-control" type="number" step="0.01" required/></div>
          <div class="col-md-4"><label class="form-label">Current Stock *</label><input id="stock" class="form-control" type="number" required/></div>
          <div class="col-md-4"><label class="form-label">Minimum Stock</label><input id="minStock" class="form-control" type="number" value="5"/></div>
        </div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div>
  </div></div></div>

  <!-- SALES MODAL (grid) - top buttons removed, kept within body below grid -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Record New Sale</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">
      <div class="table-responsive">
        <table class="table table-sm grid-table mb-0">
          <thead><tr><th class="grid-row-number">#</th><th>Product Name</th><th style="width:130px">Size</th><th style="width:90px">Qty</th><th style="width:110px">Unit</th><th style="width:120px">Price</th><th style="width:140px">Total</th><th style="width:60px"></th></tr></thead>
          <tbody id="product-grid-body"></tbody>
        </table>
      </div>

      <!-- Keep Add buttons only here (below grid) -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="addMoreRows()"><i class="bi bi-plus-circle"></i> Add More Rows</button>
          <button class="btn btn-outline-success btn-sm ms-2" onclick="openCustomProductPopup()"><i class="bi bi-pencil-square"></i> Add Custom Product</button>
        </div>
        <div class="text-end" style="min-width:320px;">
          <table class="table table-borderless mb-0">
            <tr><td class="text-end small-muted"><strong>Subtotal:</strong></td><td id="subtotal" class="text-end">₹0.00</td></tr>
            <tr style="font-size:1.25rem;color:#28a745"><td class="text-end"><strong>GRAND TOTAL:</strong></td><td id="grandTotal" class="text-end">₹0.00</td></tr>
          </table>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="completeSale()">Complete Sale</button>
    </div>
  </div></div></div>

  <!-- CUSTOM PRODUCT MODAL (NEW fields) -->
  <div class="modal fade" id="customProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Add Custom Product</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="customProductForm">
        <div class="mb-3"><label class="form-label">Product Name *</label><input id="customName" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Size</label><input id="customSize" class="form-control" placeholder="e.g., 3x3 feet or Standard"/></div>
        <div class="row">
        
          <div class="col-md-6 mb-3"><label class="form-label">Unit Type *</label><select id="customUnit" class="form-select"><option>Box</option><option>Piece</option><option>SFT</option></select></div>
        </div>
        <div class="mb-3"><label class="form-label">Unit Price *</label><input id="customPrice" type="number" class="form-control" min="0.01" step="0.01" value="0"/></div>
         <div class="col-md-6 mb-3"><label class="form-label">Quantity (for this sale) *</label><input id="customQty" type="number" class="form-control" min="1" value="1"/></div>

        <!-- New optional fields -->
        <div class="mb-3"><label class="form-label">Current Stock (optional)</label><input id="customStock" type="number" class="form-control" min="1" placeholder="If you want to save this product to inventory"/></div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="addToInventory">
          <label class="form-check-label" for="addToInventory">Add product to inventory (if checked)</label>
        </div>

        <div class="mb-3"><label class="form-label">Total</label><div id="customTotal" class="fw-bold">₹0.00</div></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="addCustomProductToGrid()">Add to Sale</button>
    </div>
  </div></div></div>

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /***********************
   * CONFIG
   ***********************/
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxybpZsUsLTlagwm_9vPbk2XfjPK-Div0xz1Z5om9lHsypgGrtbBa6hcOPS0QcS6g8v/exec'; // <-- replace with your deployed URL
  let cachedProducts = [];
  let cachedSales = [];

let deletedSaleIds = []; // NEW: Track manually deleted sales

// NEW: Load deleted IDs from localStorage on page load
try {
    const stored = localStorage.getItem('deletedSaleIds');
    if (stored) {
        deletedSaleIds = JSON.parse(stored);
        console.log('ðŸ“ Loaded', deletedSaleIds.length, 'deleted sale IDs from localStorage');
    }
} catch (e) {
    console.warn('Could not load deletedSaleIds from localStorage', e);
}
    
  let hasInitialLoaded = false;

  // Keep custom products added into the current sale (persist across grid re-builds)
  let customProductsInSale = []; // { id, name, size, unitType, price, quantity, isPersistedToInventory:false/true, tempProductId }







  /***********************
   * Helpers
   ***********************/
  function showSyncIndicator(msg='Syncing...', hideAfterMs=null) {
    const el = document.getElementById('syncIndicator');
    document.getElementById('syncText').textContent = msg;
    el.style.display = 'block';
    if (hideAfterMs) setTimeout(()=> el.style.display = 'none', hideAfterMs);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  function safeParseResponse(res) {
    return res.text().then(txt => {
      try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
      catch(e) { return { ok: res.ok, json: null, text: txt }; }
    });
  }
  function formatCurrency(n){ return '₹' + Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function generateId(){ return 'TMP_' + Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  /***********************
   * Sync / Fetch
   ***********************/
  async function syncFromGoogleSheets() {
    showSyncIndicator('Refreshing...');
    try {
        const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
        if (!res.ok) throw new Error(`Network ${res.status}`);
        const data = await res.json();
        
        if (data && data.success) {
            cachedProducts = data.products || [];
            let allSales = data.sales || [];
            
            // âœ… FIX 1: Filter out manually deleted sales
            cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
            console.log(`ðŸ“Š Loaded ${allSales.length} sales from server, showing ${cachedSales.length} (${allSales.length - cachedSales.length} deleted)`);
            
            // âœ… FIX 2: Sort sales by date (newest first)
            sortSalesByDateDescending();
            
            hasInitialLoaded = true;
            renderProducts();
            renderSales();
            showSyncIndicator('Synced!', 900);
        }
    } catch (err) {
        console.error('sync error', err);
        hideSyncIndicator();
    }
}

  async function fallbackGetProductsAndSales() {
    try { const p = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`); if(p.ok){ const pj=await p.json(); if(pj && pj.products) cachedProducts=pj.products; } }
    catch(e){ console.warn('fallback products failed', e); }
    try { const s = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales&t=${Date.now()}`); if(s.ok){ const sj=await s.json(); if(sj && sj.sales) cachedSales=sj.sales; } }
    catch(e){ console.warn('fallback sales failed', e); }
    hasInitialLoaded = true; renderProducts(); renderSales();
  }
  async function manualRefresh(){ const btn = document.getElementById('refreshBtn'); const icon=document.getElementById('refreshIcon'); btn.disabled=true; icon.className='bi bi-arrow-clockwise spinner-border spinner-border-sm'; await syncFromGoogleSheets(); icon.className='bi bi-arrow-clockwise'; btn.disabled=false; }

  /***********************
   * Rendering
   ***********************/
  function categoryIconColor(cat){
    if(!cat) return '#6c757d';
    const c = cat.toLowerCase();
    if(c.includes('tile')) return '#0d6efd';
    if(c.includes('sanitary')) return '#198754';
    if(c.includes('access')) return '#fd7e14';
    return '#6c757d';
  }

  function stockBadgeHtml(stock, minStock){
    minStock = (typeof minStock === 'number') ? minStock : Number(minStock)||5;
    stock = Number(stock)||0;
    if(stock === 0) return `<span class="stock-badge bg-danger text-white">Out of Stock</span>`;
    if(stock <= minStock) return `<span class="stock-badge bg-warning text-dark">Low (${stock})</span>`;
    return `<span class="stock-badge bg-success text-white">In Stock (${stock})</span>`;
  }

  function renderProducts(){
    const tbody = document.getElementById('productsTableBody');
    if(!hasInitialLoaded){
      tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryâ€¦</div></td></tr>`;
    } else if(!cachedProducts || cachedProducts.length===0){
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
    } else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const priceText = (p.price!==undefined && p.price!==null) ? `₹${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
        html += `<tr>
          <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.category||'')}</td>
          <td>${escapeHtml(p.brand||'')}</td>
          <td><strong>${escapeHtml(p.size||'')}</strong></td>
          <td>${stockBadgeHtml(p.stock,p.minStock)}</td>
          <td>${priceText}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i> Delete</button>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }
    // mobile list
    const container = document.getElementById('mobileProductsList');
    if(!hasInitialLoaded){ container.innerHTML=`<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryâ€¦</div></div>`; }
    else if(!cachedProducts || cachedProducts.length===0){ container.innerHTML=`<div class="mobile-item text-center text-muted">No products yet</div>`; }
    else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        html += `<div class="mobile-item d-flex align-items-start justify-content-between">
          <div style="display:flex;gap:.8rem;align-items:center;">
            <div style="width:36px;text-align:center;"><i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i></div>
            <div>
              <div style="font-weight:600">${escapeHtml(p.name)}</div>
              <div class="small-muted">${escapeHtml(p.category||'')} â€¢ ${escapeHtml(p.brand||'')}</div>
              <div class="small-muted"><strong>${escapeHtml(p.size||'')}</strong> â€¢ ₹${parseFloat(p.price||0).toFixed(2)}/${p.unitType}</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div>${stockBadgeHtml(p.stock,p.minStock)}</div>
            <div style="margin-top:.5rem">
              <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }
    updateSummaryFromCache();
    loadProductsForSaleFromCache();
  }

  function renderSales(){
    const tbody = document.getElementById('salesList');
    if(!hasInitialLoaded){ tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading salesâ€¦</div></td></tr>`; return; }
    if(!cachedSales || cachedSales.length===0){ tbody.innerHTML=`<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`; return; }
    let html = '';
    const recent = (cachedSales || []).slice(0,10);
    recent.forEach(sale => {
      const d = new Date(sale.date||'');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">₹${parseFloat(sale.totalAmount||0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
    updateSummaryFromCache();
  }

  function updateSummaryFromCache(){
    if(!hasInitialLoaded){ document.getElementById('totalProducts').textContent='Loading...'; document.getElementById('salesToday').textContent='Loading...'; document.getElementById('lowStock').textContent='Loading...'; return; }
    document.getElementById('totalProducts').textContent = (cachedProducts||[]).length;
    const today = new Date().toDateString();
    const todaySales = (cachedSales||[]).filter(s => new Date(s.date).toDateString() === today);
    const sum = todaySales.reduce((acc,s) => acc + parseFloat(s.totalAmount||0), 0);
    document.getElementById('salesToday').textContent = '₹' + sum.toFixed(2);
    const low = (cachedProducts||[]).filter(p => p.stock <= p.minStock && p.stock > 0).length;
    document.getElementById('lowStock').textContent = low;
  }

  /***********************
   * Utility: build product selects including custom in-sale items
   ***********************/
  function populateProductSelectForRow(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">-- Select Product --</option>`;
    // Add cachedProducts first
    (cachedProducts || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.dataset.size = p.size || '';
      opt.dataset.unit = p.unitType || '';
      opt.dataset.price = p.price;
      opt.dataset.stock = p.stock;
      opt.text = `${p.name} (Stock: ${p.stock} ${p.unitType})`;
      sel.appendChild(opt);
    });
    // Add custom in-sale products (those not in cachedProducts yet)
    (customProductsInSale || []).forEach(cp => {
      // If a matching id already exists in cachedProducts skip
      if((cachedProducts||[]).find(p => p.id === cp.tempId)) return;
      const opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.dataset.size = cp.size || '';
      opt.dataset.unit = cp.unitType || '';
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity; // treat its available stock as sale-qty (or 9999)
      opt.text = `${cp.name} (Custom)`;
      sel.appendChild(opt);
    });
    if(current) sel.value = current;
  }

  /***********************
   * Save helpers (server calls)
   ***********************/
  async function saveProductToSheet(product, isEdit=false){
    try{
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=${isEdit ? 'updateProduct':'addProduct'}`, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(product)
      });
      const parsed = await safeParseResponse(res);
      return parsed.json || null;
    }catch(e){ console.error('saveProductToSheet', e); return null; }
  }

  async function saveSaleToSheet(item){
    try{
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=addSale`, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(item)
      });
      const parsed = await safeParseResponse(res);
      return parsed.json || null;
    }catch(e){ console.error('saveSaleToSheet', e); return null; }
  }

  async function deleteProductFromSheet(id){
    try{
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=deleteProduct`, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({ id })
      });
      const parsed = await safeParseResponse(res);
      return parsed.json && parsed.json.success;
    }catch(e){ console.error('deleteProductFromSheet', e); return false; }
  }

  /***********************
   * Product CRUD UI
   ***********************/
  let editingProductId = null;
  function showAddProduct(){ editingProductId=null; document.getElementById('modalTitle').textContent='Add New Product'; document.getElementById('productForm').reset(); document.getElementById('productId').value=''; new bootstrap.Modal(document.getElementById('productModal')).show(); }
  function editProduct(id){
    const p = (cachedProducts||[]).find(x=>x.id===id);
    if(!p){ alert('âŒ Product not found'); return; }
    editingProductId = id;
    document.getElementById('modalTitle').textContent='Edit Product';
    document.getElementById('productId').value = p.id;
    document.getElementById('productName').value = p.name;
    document.getElementById('category').value = p.category;
    document.getElementById('brand').value = p.brand||'';
    document.getElementById('size').value = p.size||'';
    document.getElementById('unitType').value = p.unitType;
    document.getElementById('piecesPerBox').value = p.piecesPerBox||1;
    document.getElementById('sftPerBox').value = p.sftPerBox||'';
    document.getElementById('price').value = p.price;
    document.getElementById('stock').value = p.stock;
    document.getElementById('minStock').value = p.minStock;
    new bootstrap.Modal(document.getElementById('productModal')).show();
  }

  async function saveProduct(){
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value.trim();
    const size = document.getElementById('size').value.trim();
    const unitType = document.getElementById('unitType').value;
    const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value)||1;
    const sftPerBox = parseFloat(document.getElementById('sftPerBox').value)||0;
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const minStock = parseInt(document.getElementById('minStock').value)||5;
    if(!name||!category||isNaN(price)||isNaN(stock)||stock<0){ alert('âŒ Fill required fields'); return; }
    const product = { id: editingProductId || (Date.now().toString(36)+Math.random().toString(36).substr(2)), name, category, brand, size, unitType, piecesPerBox, sftPerBox, price, stock, minStock };
    const idx = (cachedProducts||[]).findIndex(p=>p.id===product.id);
    const previous = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
    if(idx !== -1) cachedProducts[idx] = product; else cachedProducts.push(product);
    renderProducts();
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal')); if(modal) modal.hide();
    showSyncIndicator('Saving product...');
    // background save but update local id if server returns id
    saveProductToSheet(product, !!editingProductId).then(resp=>{
      if(resp && resp.success && resp.id){
        const localIdx = cachedProducts.findIndex(p=>p.id===product.id);
        if(localIdx!==-1){ cachedProducts[localIdx].id = resp.id; renderProducts(); }
      }
      showSyncIndicator('Saved',900);
    }).catch(err=>{ console.error(err); if(previous) cachedProducts[idx]=previous; renderProducts(); alert('âŒ Save failed - reverted locally.'); });
  }

  function deleteProduct(id){
    if(!confirm('Are you sure?')) return;
    const prev = cachedProducts.slice();
    cachedProducts = (cachedProducts||[]).filter(p=>p.id!==id);
    renderProducts();
    showSyncIndicator('Deleting...');
    deleteProductFromSheet(id).then(success=>{ if(success) showSyncIndicator('Deleted',900); else { cachedProducts = prev; renderProducts(); alert('âŒ Delete failed - reverted locally.'); } });
  }

  /***********************
   * SALES GRID: create rows, populate selects, mobile behavior
   ***********************/
  function openSalesModal(){ initSalesGrid(); new bootstrap.Modal(document.getElementById('salesModal')).show(); }
  function initSalesGrid(){
    const body = document.getElementById('product-grid-body');
    body.innerHTML = '';
    for(let i=1;i<=3;i++) appendEmptyRow(i);
    updateRowNumbers();
    updateGrandTotal();
  }

  function appendEmptyRow(index){
    const tbody = document.getElementById('product-grid-body');
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.dataset.custom = 'false';
    tr.innerHTML = `
      <td class="grid-row-number"></td>
      <td>
        <select class="form-select product-select" id="product-${index}" onchange="onProductSelect(${index})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${index}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${index}" min="1" disabled oninput="onQtyChange(${index})" /></td>
      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${index}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${index}" readonly /></td>
      <td><div id="total-${index}" class="fw-bold">₹0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
    populateProductSelectForRow(index);
  }

  function addMoreRows(){
    const currentCount = document.querySelectorAll('#product-grid-body .product-row').length;
    for(let i=1;i<=3;i++) appendEmptyRow(currentCount+i);
    updateRowNumbers();
  }

  function removeRow(btn){
    const tr = btn.closest('tr');
    if(!tr) return;
    // if custom product in this row, remove from customProductsInSale as well
    const select = tr.querySelector('.product-select');
    if(select && select.value && select.value.startsWith('CUST_TMP_')){
      customProductsInSale = customProductsInSale.filter(c => c.tempId !== select.value);
    }
    tr.remove();
    updateRowNumbers();
    updateGrandTotal();
  }

  function updateRowNumbers(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      r.querySelector('.grid-row-number').textContent = idx;
      // update element ids to keep consistent
      const sel = r.querySelector('.product-select'); if(sel) sel.id = `product-${idx}`;
      const sizeEl = r.querySelector('.size-input'); if(sizeEl) sizeEl.id = `size-${idx}`;
      const qtyEl = r.querySelector('.qty-input'); if(qtyEl){ qtyEl.id = `qty-${idx}`; qtyEl.setAttribute('oninput', `onQtyChange(${idx})`); }
      const unitEl = r.querySelector('.unit-input'); if(unitEl) unitEl.id = `unit-${idx}`;
      const priceEl = r.querySelector('.price-input'); if(priceEl) priceEl.id = `price-${idx}`;
      const totalEl = r.querySelector('[id^=total-]'); if(totalEl) totalEl.id = `total-${idx}`;
      // ensure options refreshed (keeps custom options)
      populateProductSelectForRow(idx);
    });
  }


    // ========== NEW: Sort sales by date (newest first) ==========
function sortSalesByDateDescending() {
    cachedSales.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Newest first
    });
    console.log('ðŸ”„ Sales sorted: newest first');
}

  /***********************
   * Row interactions
   ***********************/
  function onProductSelect(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    const sizeEl = document.getElementById(`size-${rowIndex}`);
    const unitEl = document.getElementById(`unit-${rowIndex}`);
    const priceEl = document.getElementById(`price-${rowIndex}`);
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!sel) return;
    const val = sel.value;
    if(!val){
      if(sizeEl) sizeEl.value=''; if(unitEl) unitEl.value=''; if(priceEl) priceEl.value=''; if(qtyEl){ qtyEl.value=''; qtyEl.disabled=true; qtyEl.removeAttribute('max'); }
      document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
      updateGrandTotal(); return;
    }
    // if this value is a custom temporary product
    if(val.startsWith('CUST_TMP_')){
      const cp = customProductsInSale.find(c => c.tempId === val);
      if(cp){
        sizeEl.value = cp.size || 'N/A';
        unitEl.value = cp.unitType;
        priceEl.value = cp.price;
        qtyEl.disabled = false;
        qtyEl.max = cp.quantity || '';
        qtyEl.value = cp.quantity || '';
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * (cp.quantity||0));
        updateGrandTotal();
      }
      return;
    }
    // Normal product from cachedProducts
    const product = (cachedProducts || []).find(p => p.id === val);
    if(!product){ sizeEl.value=''; unitEl.value=''; priceEl.value=''; if(qtyEl){ qtyEl.disabled=true; qtyEl.value=''; } return; }
    sizeEl.value = product.size || 'N/A';
    unitEl.value = product.unitType || '';
    priceEl.value = product.price || 0;
    qtyEl.disabled = false;
    qtyEl.value = '';
    qtyEl.max = product.stock || '';
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
    updateGrandTotal();
  }

  function onQtyChange(rowIndex){
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!qtyEl) return;
    const qty = Number(qtyEl.value || 0);
    const max = Number(qtyEl.max || Infinity);
    if(qty > max){
      alert(`âŒ Quantity exceeds available stock (${max}). Adjusting to max.`);
      qtyEl.value = max;
    }
    updateRowTotal(rowIndex);
    updateGrandTotal();
  }

  function updateRowTotal(rowIndex){
    const price = Number(document.getElementById(`price-${rowIndex}`).value || 0);
    const qty = Number(document.getElementById(`qty-${rowIndex}`).value || 0);
    const total = price * qty;
    const el = document.getElementById(`total-${rowIndex}`);
    if(el) el.textContent = formatCurrency(total);
    return total;
  }

  function updateGrandTotal(){
    let grand = 0;
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel) return;
      if(!sel.value && r.dataset.custom!=='true') return;
      const qty = Number(document.getElementById(`qty-${idx}`)?.value || 0);
      const price = Number(document.getElementById(`price-${idx}`)?.value || 0);
      const line = qty * price;
      grand += line;
      const totalEl = document.getElementById(`total-${idx}`);
      if(totalEl) totalEl.textContent = formatCurrency(line);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(grand);
    document.getElementById('subtotal').textContent = formatCurrency(grand);
  }

  /***********************
   * CUSTOM PRODUCT: open, validate, add to grid (and optionally inventory)
   ***********************/
  function openCustomProductPopup(){
    document.getElementById('customProductForm').reset();
    document.getElementById('customTotal').textContent = formatCurrency(0);
    document.getElementById('addToInventory').checked = false;
    new bootstrap.Modal(document.getElementById('customProductModal'), { backdrop:'static' }).show();
    setTimeout(()=> document.getElementById('customName').focus(), 200);
  }

  function updateCustomTotalDisplay(){
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    document.getElementById('customTotal').textContent = formatCurrency(qty * price);
  }
  // Attach in case DOM ready
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.id==='customQty' || e.target.id==='customPrice')) updateCustomTotalDisplay();
  });

  function validateCustomProduct(){
    const name = (document.getElementById('customName').value||'').trim();
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    const addInventory = document.getElementById('addToInventory').checked;
    const stock = Number(document.getElementById('customStock').value || 0);
    if(!name || name.length < 2){ alert('âŒ Product name required (min 2 chars)'); return false; }
    if(!qty || qty < 1){ alert('âŒ Quantity must be at least 1'); return false; }
    if(!price || price <= 0){ alert('âŒ Unit price must be greater than 0'); return false; }
    if(addInventory && (!stock || stock < 1)){ alert('âŒ Please provide Current Stock to add to inventory'); return false; }
    if(stock && stock < qty){ alert('âŒ Current stock cannot be less than sale quantity'); return false; }
    return true;
  }

  function addCustomProductToGrid(){
    if(!validateCustomProduct()) return;
    const name = document.getElementById('customName').value.trim();
    const size = document.getElementById('customSize').value.trim() || 'N/A';
    const qty = Number(document.getElementById('customQty').value || 0);
    const unitType = document.getElementById('customUnit').value || 'Box';
    const price = Number(document.getElementById('customPrice').value || 0);
    const addInventory = document.getElementById('addToInventory').checked;
    const currentStock = Number(document.getElementById('customStock').value || 0);

    const tempId = 'CUST_TMP_' + Date.now().toString(36); // unique temp id for select
    // store in persistent array
    const cp = { tempId, name, size, unitType, price, quantity: qty, addToInventory, currentStock, persistedId: null };
    customProductsInSale.push(cp);

    // If adding to inventory: create product object locally and save in background
    if(addToInventory && currentStock > 0){
      const newProduct = {
        id: tempId, // use temp id locally; will replace when server returns id
        name: name,
        category: 'Custom',
        brand: '',
        size: size,
        unitType: unitType,
        piecesPerBox: 1,
        sftPerBox: 0,
        price: price,
        stock: currentStock - qty, // deduct sale quantity
        minStock: 5,
        imageUrl: ''
      };
      // add to cached products so select options include it immediately
      cachedProducts.push(newProduct);
      renderProducts();
      // background save - when server returns id, patch local cachedProducts & replace temp ids
      saveProductToSheet(Object.assign({}, newProduct)).then(resp=>{
        if(resp && resp.success && resp.id){
          // replace tempId in cachedProducts & customProductsInSale
          const idx = cachedProducts.findIndex(p=>p.id===tempId);
          if(idx!==-1) cachedProducts[idx].id = resp.id;
          customProductsInSale.forEach(c=>{
            if(c.tempId === tempId){ c.persistedId = resp.id; }
          });
          renderProducts();
        }
      }).catch(e=>{ console.error('add custom->inventory failed', e); });
    }

    // Add custom item to first empty row (or append)
    let idx = findFirstEmptyRowIndex();
    if(!idx){
      const count = document.querySelectorAll('#product-grid-body .product-row').length;
      appendEmptyRow(count+1);
      updateRowNumbers();
      idx = count+1;
    }
    // populate row with custom data
    populateRowWithCustom(idx, cp);
    updateGrandTotal();
    // close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('customProductModal')); if(modal) modal.hide();
  }

  function populateRowWithCustom(rowIndex, cp){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    // ensure select contains this option (populateProductSelectForRow will add it)
    populateProductSelectForRow(rowIndex);
    // create or update option
    let opt = Array.from(sel.options).find(o=>o.value===cp.tempId);
    if(!opt){
      opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.text = `${cp.name} (Custom)`;
      opt.dataset.size = cp.size;
      opt.dataset.unit = cp.unitType;
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity;
      sel.appendChild(opt);
    }
    sel.value = cp.tempId;
    document.getElementById(`size-${rowIndex}`).value = cp.size;
    document.getElementById(`unit-${rowIndex}`).value = cp.unitType;
    document.getElementById(`price-${rowIndex}`).value = cp.price;
    const qtyEl = document.getElementById(`qty-${rowIndex}`)
qtyEl.disabled = false  // ✅ Ensure editable
qtyEl.readOnly = false  // ✅ Ensure editable
qtyEl.value = cp.quantity
qtyEl.max = cp.quantity

// ✅ FIX: Allow quantity to be edited and update total
qtyEl.addEventListener('input', function() {
    const newQty = parseFloat(this.value) || 0;
    const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
    const total = newQty * price;
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(total);
    updateGrandTotal();
});


  function findFirstEmptyRowIndex(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    for(let i=0;i<rows.length;i++){
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel || !sel.value) return idx;
    }
    return null;
  }

  /***********************
   * COMPLETE SALE (fire-and-forget background saves)
   ***********************/
  async function completeSale(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    const saleItems = [];
    let hasErrors = false;

    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      const qtyEl = document.getElementById(`qty-${idx}`);
      const priceEl = document.getElementById(`price-${idx}`);
      const unitEl = document.getElementById(`unit-${idx}`);
      const sizeEl = document.getElementById(`size-${idx}`);
      if(!sel) return;
      // Skip empty rows
      if(!sel.value) return;

      const qty = Number(qtyEl.value || 0);
      if(!qty || qty <= 0){ alert(`âŒ Row ${idx}: Enter a valid quantity`); hasErrors = true; return; }
      const maxStock = Number(qtyEl.max || Infinity);
      if(!sel.value.startsWith('CUST_TMP_') && qty > maxStock){ alert(`âŒ Row ${idx}: Quantity exceeds available stock (${maxStock})`); hasErrors = true; return; }

      // Determine if custom (temp) or normal product
      let isCustom = sel.value.startsWith('CUST_TMP_');
      let productId = isCustom ? null : sel.value;
      let productName = '';
      let size = sizeEl.value || 'N/A';
      let unitType = unitEl.value || '';
      let unitPrice = Number(priceEl.value || 0);
      let lineTotal = unitPrice * qty;

      if(isCustom){
        const cp = customProductsInSale.find(c => c.tempId === sel.value) || {};
        productName = cp.name || (sel.options[sel.selectedIndex]?.text || 'Custom');
      } else {
        const prod = (cachedProducts||[]).find(p => p.id === productId);
        if(!prod){ alert(`âŒ Row ${idx}: Product not found`); hasErrors = true; return; }
        productName = prod.name;
        size = prod.size || size;
        unitType = prod.unitType || unitType;
        unitPrice = prod.price || unitPrice;
      }

      saleItems.push({
        productId,
        productName,
        size,
        quantity: qty,
        unitType,
        unitPrice,
        totalAmount: lineTotal,
        isCustomProduct: isCustom
      });
    });

    if(hasErrors) return;
    if(saleItems.length === 0){ alert('âŒ Please add at least one product to the sale'); return; }

    // OPTIMISTIC: update local cache & UI immediately
    const saleId = 'SALE_' + Date.now();
    const nowIso = new Date().toISOString();
    // push each line to cachedSales and deduct stock for non-custom
    saleItems.forEach(item => {
      const line = {
        id: generateId(),
        saleId,
        productId: item.productId || '',
        productName: item.productName,
        size: item.size,
        quantity: item.quantity,
        unitType: item.unitType,
        unitPrice: item.unitPrice,
        totalAmount: item.totalAmount,
        date: nowIso,
        isCustomProduct: item.isCustomProduct
      };
      cachedSales.unshift(line);
      // Deduct stock optimistically
      if(!item.isCustomProduct && item.productId){
        const pi = cachedProducts.findIndex(p => p.id === item.productId);
        if(pi !== -1){
          cachedProducts[pi].stock = Number(cachedProducts[pi].stock || 0) - Number(item.quantity);
          if(cachedProducts[pi].stock < 0) cachedProducts[pi].stock = 0;
        }
      }
    });

      // âœ… NEW: Sort sales by date after adding new sales
    sortSalesByDateDescending();
    renderProducts();
    renderSales();

    // Close modal immediately (fast UX)
    const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
    if(modal) modal.hide();

    // Show immediate success message and that save happens in background
    const grandTotal = saleItems.reduce((s,it) => s + Number(it.totalAmount || 0), 0);
    setTimeout(()=> alert(`âœ… Sale recorded locally!\nItems: ${saleItems.length}\nTotal: ${formatCurrency(grandTotal)}\n\nSaving to Google Sheets in background...`), 300);

    // FIRE AND FORGET: save each item in background (don't block UI)
    const saves = saleItems.map(item => {
      const payload = {
        saleId,
        productId: item.productId || '',
        productName: item.productName,
        size: item.size,
        quantity: item.quantity,
        unitType: item.unitType,
        unitPrice: item.unitPrice,
        totalAmount: item.totalAmount,
        isCustomProduct: item.isCustomProduct || false
      };
      return saveSaleToSheet(payload).then(resp=>{
        if(!(resp && resp.success)){
          console.error('Sale line failed to save', payload, resp);
          // optionally: mark a small flag in UI or show toast later
          return { ok:false, payload, resp };
        }
        return { ok:true, payload, resp };
      }).catch(err => { console.error('saveSale error', err); return { ok:false, payload, err }; });
    });

    // handle results when finished (optional)
    Promise.allSettled(saves).then(results => {
      const failed = results.filter(r => r.status === 'fulfilled' && r.value && r.value.ok === false);
      if(failed.length){
        console.warn('Some rows failed to save', failed);
        // show a gentle non-blocking alert
        setTimeout(()=> alert(`âš ï¸ Some items failed to sync to Google Sheets. Please click Refresh later.`), 800);
      } else {
        // re-sync to get canonical server state (ids, timestamps, stock)
        syncFromGoogleSheets();
      }
    });
  }

  /***********************
   * Load sale product select helper (if needed elsewhere)
   ***********************/
  function loadProductsForSaleFromCache(){
    // not used directly now (we populate selects per-row), but keep for compatibility
  }

  /***********************
   * Backup/Import
   ***********************/
  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('âœ… Backup downloaded');
  }
  function importData(){ document.getElementById('fileInput').click(); }
  function handleFileImport(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(evt){ try{ const data = JSON.parse(evt.target.result); if(data.products) cachedProducts = data.products; if(data.sales) cachedSales = data.sales; hasInitialLoaded=true; renderProducts(); renderSales(); alert('âœ… Data restored (local)'); }catch(err){ alert('âŒ Invalid file'); } }; reader.readAsText(file); }

      function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // If empty, display all products
    if (!searchTerm) {
        displayAllProducts();
        return;
    }
    
    // Filter products
    const filteredProducts = cachedProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category || '').toLowerCase();
        const brand = (product.brand || '').toLowerCase();
        const size = (product.size || '').toLowerCase();
        
        return name.includes(searchTerm) ||
               category.includes(searchTerm) ||
               brand.includes(searchTerm) ||
               size.includes(searchTerm);
    });
    
    // Display filtered products
    displayProducts(filteredProducts);
}

function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-search"></i>
                    <p>No products found matching your search</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    products.forEach(product => {
        const iconColor = categoryIconColor(product.category);
        const stockClass = product.stock > product.minStock ? 'In Stock' : 
                          product.stock > 0 ? 'Low' : 'Out of Stock';
        const stockBadgeClass = product.stock > product.minStock ? 'bg-success' : 
                               product.stock > 0 ? 'bg-warning' : 'bg-danger';
        
        html += `
            <tr>
                <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>
                <td>${escapeHtml(product.name)}</td>
                <td>${escapeHtml(product.category)}</td>
                <td>${escapeHtml(product.brand) || '-'}</td>
                <td><strong>${escapeHtml(product.size) || 'N/A'}</strong></td>
                <td><span class="badge ${stockBadgeClass}">${stockClass} (${product.stock})</span></td>
                <td>₹${product.price.toFixed(2)}/${product.unitType}</td>
                <td>
                    <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Also update mobile list
    const container = document.getElementById('mobileProductsList');
    if (products.length === 0) {
        container.innerHTML = '<div class="mobile-item text-center text-muted">No products found</div>';
        return;
    }
    
    let mobileHtml = '';
    products.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const stockBadge = stockBadgeHtml(p.stock, p.minStock);
        mobileHtml += `
            <div class="mobile-item d-flex align-items-start justify-content-between">
                <div style="display:flex;gap:.8rem;align-items:center">
                    <div style="width:36px;text-align:center">
                        <i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600">${escapeHtml(p.name)}</div>
                        <div class="small-muted">${escapeHtml(p.category)} ${escapeHtml(p.brand)}</div>
                        <div class="small-muted"><strong>${escapeHtml(p.size)}</strong> ₹${parseFloat(p.price || 0).toFixed(2)}/${p.unitType}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    ${stockBadge}
                    <div style="margin-top:.5rem">
                        <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = mobileHtml;
}

function displayAllProducts() {
    displayProducts(cachedProducts);
}


    // Open Clear Sales popup
function openClearSalesPopup() {
    // Set default dates (last 30 days to today)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('clearFromDate').value = formatDateForInput(thirtyDaysAgo);
    document.getElementById('clearToDate').value = formatDateForInput(today);
    
    // Reset count display
    document.getElementById('clearSalesCount').style.display = 'none';
    
    // Add event listeners to count on date change
    document.getElementById('clearFromDate').addEventListener('change', updateClearSalesCount);
    document.getElementById('clearToDate').addEventListener('change', updateClearSalesCount);
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('clearSalesModal'));
    modal.show();
    
    // Initial count
    updateClearSalesCount();
}

// Format date for input field (YYYY-MM-DD)
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Update count of sales in selected date range
function updateClearSalesCount() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) return;
    
    if (fromDate > toDate) {
        alert('âŒ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Count sales in range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    // Display count
    const countDiv = document.getElementById('clearSalesCount');
    const countNumber = document.getElementById('salesCountNumber');
    
    countNumber.textContent = salesInRange.length;
    countDiv.style.display = salesInRange.length > 0 ? 'block' : 'none';
}

// Clear sales in date range
function clearSalesInDateRange() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) {
        alert('âŒ Please select both From and To dates');
        return;
    }
    
    // Set time to start/end of day for accurate comparison
    fromDate.setHours(0, 0, 0, 0);
    toDate.setHours(23, 59, 59, 999);
    
    if (fromDate > toDate) {
        alert('âŒ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Find sales in date range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    if (salesInRange.length === 0) {
        alert('â„¹ï¸ No sales found in the selected date range');
        return;
    }
    
    // Confirm deletion
    const fromStr = fromDate.toLocaleDateString('en-IN');
    const toStr = toDate.toLocaleDateString('en-IN');
    const confirmMsg = `Are you sure you want to hide ${salesInRange.length} sales records between ${fromStr} and ${toStr}?\n\nâš ï¸ This will hide them from display only.\nGoogle Sheets data remains unchanged.\n\nYou can restore them later by clearing browser data.`;
    
    if (!confirm(confirmMsg)) return;
    
    // âœ… FIX: Store deleted IDs persistently
    salesInRange.forEach(sale => {
        if (sale.id && !deletedSaleIds.includes(sale.id)) {
            deletedSaleIds.push(sale.id);
        }
    });
    
    // Save to localStorage for persistence across sessions and page reloads
    try {
        localStorage.setItem('deletedSaleIds', JSON.stringify(deletedSaleIds));
        console.log('ðŸ’¾ Saved', deletedSaleIds.length, 'deleted sale IDs to localStorage');
    } catch (e) {
        console.warn('Could not save deletedSaleIds to localStorage', e);
    }
    
    // Filter out sales in the date range
    cachedSales = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate < fromDate || saleDate > toDate;
    });
    
    // Update display
    displaySalesFromCache();
    updateSummaryFromCache();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearSalesModal'));
    modal.hide();
    
    // Show success message
    alert(`âœ… Successfully cleared ${salesInRange.length} sales records!\n\nNote: They're hidden from display only. Google Sheets data is unchanged.\n\nTo restore: Clear browser data or use developer console to run:\nlocalStorage.removeItem('deletedSaleIds')`);
}


    function displaySalesFromCache() {
    const salesList = document.getElementById('salesList');
    
    if (cachedSales.length === 0) {
        salesList.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    No sales recorded yet
                </td>
            </tr>
        `;
        return;
    }
    
    salesList.innerHTML = '';
    
    // Show only last 100 sales (most recent)
    const recentSales = cachedSales.slice(0, 100);
    
    recentSales.forEach(sale => {
        const date = new Date(sale.date);
        const formattedDate = date.toLocaleDateString('en-IN') + ' ' + 
                             date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
        
        const row = `
            <tr>
                <td>${formattedDate}</td>
                <td>${sale.productName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.unitType}</td>
                <td class="text-success fw-bold">₹${parseFloat(sale.totalAmount).toFixed(2)}</td>
            </tr>
        `;
        
        salesList.innerHTML += row;
    });
    
    // Show count if more sales exist
    if (cachedSales.length > 100) {
        salesList.innerHTML += `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <small>Showing 50 most recent sales. Total: ${cachedSales.length} sales</small>
                </td>
            </tr>
        `;
    }
}

  /***********************
   * Init
   ***********************/
  document.addEventListener('DOMContentLoaded', ()=>{
    // initial placeholders
    renderProducts();
    renderSales();
    syncFromGoogleSheets();
  });

    
  </script>
</body>
</html>







