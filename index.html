<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tile & Sanitaryware Inventory</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>



  <!-- ✅ html2canvas for image generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    .table-explorer { background:#fff; border-radius:6px; overflow:hidden; }
    .file-icon { font-size:1.15rem; display:inline-block; width:1.6rem; text-align:center; }
    .stock-badge{font-size:.85rem;padding:.25rem .5rem;border-radius:.5rem}
    .mobile-list{display:none}
    .mobile-item{background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.7rem;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .btn-action-sm{padding:.25rem .5rem;font-size:.85rem}
    .sync-indicator{position:fixed;top:70px;left:20px;background:#fff;padding:8px 12px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:none;z-index:1000}
   /* Sales grid mobile transforms */
@media (max-width:768px) {
  .desktop-table { display:none !important; }
  .mobile-list { display:block !important; }
  /* Make table rows card-like */
  .grid-table thead { display:none; }
  .grid-table tbody tr { display:block; margin-bottom:12px; padding:12px; border:1px solid #e9ecef; border-radius:8px; background:#fff; }
  .grid-table td { display:block; width:100%; padding:.35rem 0; border:0; }
  .grid-row-number { float:right; font-size:.85rem; color:#6c757d; }
  .product-select, .qty-input, .price-input { width:100% !important; font-size:16px; height:44px; }
  .mobile-two-col { display:flex; gap:10px; }
  .mobile-two-col > div { flex:1; }
  .modal-dialog { margin:.5rem; max-width: calc(100% - 1rem); }
  .modal-body { max-height: calc(100vh - 200px); overflow-y:auto; -webkit-overflow-scrolling: touch; }
  .modal-footer { position: sticky; bottom:0; background: white; z-index:10; box-shadow:0 -2px 10px rgba(0,0,0,.08); }
}

/* ✅ NEW: Additional mobile fixes for Record Sale modal */
@media (max-width: 768px) {
    /* Specific fixes for salesModal only */
    #salesModal .modal-dialog {
        margin: 0.25rem;
        max-width: calc(100% - 0.5rem);
    }
    
    #salesModal .modal-body {
        padding: 0.75rem 0.5rem;
    }
    
    /* Smaller font for sales grid on mobile */
    #salesModal .grid-table {
        font-size: 0.85rem;
    }
    
    /* Add labels before each field for clarity */
    #salesModal .grid-table td:nth-child(2)::before { 
        content: "Product: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(3)::before { 
        content: "Size: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(4)::before { 
        content: "Qty: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(5)::before { 
        content: "Unit: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(6)::before { 
        content: "Price: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(7)::before { 
        content: "Total: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    /* Hide row number on mobile */
    #salesModal .grid-table td:nth-child(1) {
        display: none;
    }
    
    /* Make total more prominent */
    #salesModal .grid-table td:nth-child(7) {
        font-size: 1.1rem;
        color: #28a745;
        font-weight: bold;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 2px solid #28a745;
    }
    
    /* Ensure inputs are touch-friendly */
    #salesModal .product-select,
    #salesModal .qty-input {
        width: 100% !important;
        font-size: 16px !important;
        height: 44px;
        margin-top: 4px;
    }
    
    /* Multi-select dropdown smaller on mobile */
    .multi-select-options {
        max-height: 200px;
    }
    
    /* Stack modal footer buttons vertically */
    #salesModal .modal-footer {
        flex-direction: column;
        gap: 8px;
    }
    
    #salesModal .modal-footer button {
        width: 100%;
        margin: 0;
    }
    
    /* Smaller buttons on mobile */
    #salesModal .btn-sm {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }
}


/* ✅ NEW: Mobile Recent Sales Table Optimization */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.75rem;
        overflow-x: auto;
    }
    
    #salesList td {
        padding: 0.4rem 0.2rem !important;
        font-size: 0.75rem;
    }
    
    #salesList th {
        padding: 0.5rem 0.2rem !important;
        font-size: 0.8rem;
    }
    
    #salesList td:nth-child(1),
    #salesList th:nth-child(1) {
        max-width: 85px;
        word-wrap: break-word;
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    #salesList td:nth-child(2),
    #salesList th:nth-child(2) {
        max-width: 110px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #salesList td:nth-child(3),
    #salesList th:nth-child(3) {
        text-align: center;
        max-width: 45px;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(4),
    #salesList th:nth-child(4) {
        text-align: center;
        max-width: 45px;
        font-size: 0.7rem;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(5) {
        font-weight: bold;
        color: #28a745;
        font-size: 0.85rem;
        text-align: right;
        max-width: 80px;
    }
    
    #salesList th:nth-child(5) {
        text-align: right;
        max-width: 80px;
    }
}


    /* Multi-Select Dropdown Styles */
.multi-select-dropdown {
    position: relative;
}

.multi-select-toggle {
    cursor: pointer;
}

.multi-select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    padding: 10px;
    display: none;
}

.multi-select-options.show {
    display: block;
}

.multi-select-list {
    max-height: 250px;
    overflow-y: auto;
}

.multi-select-item {
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 4px;
}

.multi-select-item:hover {
    background-color: #f8f9fa;
}

.multi-select-item label {
    cursor: pointer;
    margin-bottom: 0;
    width: 100%;
}


  </style>
</head>
<body>

 

<!-- ✅ ADD THIS AUTHENTICATION SCREEN -->
<div id="authScreen" style="display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); text-align:center; max-width:400px; width:90%;">
    <i class="bi bi-shield-lock" style="font-size:64px; color:#667eea;"></i>
    <h2 style="margin:20px 0 10px;">Tile & Sanitaryware Inventory</h2>
    <p style="color:#666; margin-bottom:30px;">Sign in with your authorized Google account</p>
    
    <div id="g_id_onload"
         data-client_id="PLACEHOLDER"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
    
    <p style="color:#999; font-size:12px; margin-top:30px;">
      🔒 Secure authentication via Google
    </p>
  </div>
</div>

<!-- App Content (hidden until authenticated) -->
<div id="appContent" style="display:none;">

  <!-- YOUR EXISTING NAVBAR, DASHBOARD, ETC. GOES HERE -->

  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator"><i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span></div>

  <!-- Navbar -->
  
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm me-2" onclick="manualRefresh()"><i id="refreshIcon" class="bi bi-arrow-clockwise"></i> Refresh</button>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
        <!-- Add this to your navbar -->
<div class="d-flex align-items-center ms-auto">
  <img id="userAvatar" src="" alt="User" style="width:32px; height:32px; border-radius:50%; margin-right:10px; display:none;">
  <span id="userName" style="margin-right:15px; color:white;"></span>
  <button class="btn btn-sm btn-outline-light" onclick="signOut()">
    <i class="bi bi-box-arrow-right"></i> Sign Out
  </button>
</div>


        <!-- ✅ NEW: View Invoices Button -->
      <button class="btn btn-success btn-sm" onclick="viewSavedInvoices()">
        <i class="bi bi-receipt-cutoff"></i> View Invoices
      </button>
    </div>
  </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Actions -->
    <div class="row mb-4">
      <div class="col-12 text-center">
        <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()"><i class="bi bi-plus-circle"></i> Add Product</button>
        <button class="btn btn-info btn-lg mb-2" onclick="openSalesModal()"><i class="bi bi-cart-check"></i> Record Sale</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-box-seam text-primary" style="font-size:2rem"></i><h3 id="totalProducts" class="mt-2">0</h3><p class="text-muted mb-0">Total Products</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-currency-rupee text-success" style="font-size:2rem"></i><h3 id="salesToday" class="mt-2">₹0</h3><p class="text-muted mb-0">Sales Today</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem"></i><h3 id="lowStock" class="mt-2">0</h3><p class="text-muted mb-0">Low Stock Items</p></div></div></div>
    </div>

    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <input id="searchInput" class="form-control form-control-lg" placeholder="🔍Search products by name, brand or size..." onkeyup="searchProducts()">
      </div>
    </div>

    <!-- Products table (desktop) & mobile list -->
    <div class="row mb-4">
      <div class="col-12 desktop-table">
        <div class="table-explorer">
          <table class="table table-sm table-striped mb-0">
            <thead><tr><th style="width:50px">Icon</th><th>Product</th><th>Category</th><th>Brand</th><th>Size</th><th style="width:120px">Stock</th><th style="width:140px">Price</th><th style="width:150px">Actions</th></tr></thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;"></div>
    </div>

  <!-- Recent Sales -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Recent Sales</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="openClearSalesPopup()">
                <i class="bi bi-trash"></i> Clear Sales
            </button>
        </div>
        <div class="table-responsive">

          <table class="table table-striped">
            <thead class="table-primary"><tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr></thead>
            <tbody id="salesList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!--  Sales Modal -->
<div class="modal fade" id="clearSalesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Clear Sales History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Clear sales records between specific dates:</p>
                
                <div class="mb-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" class="form-control" id="clearFromDate" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" class="form-control" id="clearToDate" required>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This will clear sales from display only. 
                    Google Sheets data remains unchanged.
                </div>
                
                <div id="clearSalesCount" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    Found <strong id="salesCountNumber">0</strong> sales records in this date range.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearSalesInDateRange()">
                    <i class="bi bi-trash"></i> Clear Sales
                </button>
            </div>
        </div>
    </div>
</div>


  <!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt"></i> Create Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" 
                   required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6 class="border-bottom pb-2">Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 12%" class="text-center">Quantity</th>
                    <th style="width: 15%" class="text-end">Rate (₹)</th>
                    <th style="width: 18%" class="text-end">Amount (₹)</th>
                    <th style="width: 5%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-6"></div>
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" style="width: 150px" id="invoiceSubtotal">₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Discount:</span>
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 70px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">₹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Tax (GST):</span>
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 90px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">5%</option>
                      <option value="12">12%</option>
                      <option value="18" selected>18%</option>
                      <option value="28">28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">₹0.00</td>
                </tr>
                <tr class="table-success fw-bold">
                  <td class="text-end"><h5 class="mb-0">Total (₹):</h5></td>
                  <td class="text-end"><h5 class="mb-0" id="invoiceGrandTotal">₹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer (e.g., delivery instructions, thank you message)">Thanks for your business.</textarea>
            <small class="text-muted">Optional message to include on the invoice</small>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link p-0" onclick="loadDefaultTerms()">
                <i class="bi bi-arrow-clockwise"></i> Use Default
              </button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="4" 
                      placeholder="Enter payment terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
     <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- ✅ NEW: Share Invoice Dropdown -->
  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsImage(); return false;">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsPDF(); return false;">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaWhatsApp(); return false;">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaEmail(); return false;">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaSMS(); return false;">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>

      
    </div>
  </div>
</div>

<!-- VIEW INVOICES MODAL -->
<div class="modal fade" id="viewInvoicesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt-cutoff"></i> Saved Invoices
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <div id="invoicesListContainer">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




  <!-- Add/Edit Product Modal (image removed) -->
  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 id="modalTitle" class="modal-title">Add New Product</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row mb-3">
          <div class="col-md-8"><label class="form-label">Product Name *</label><input id="productName" class="form-control" required/></div>
          <div class="col-md-4"><label class="form-label">Category *</label><select id="category" class="form-select" required><option value="">Select</option><option value="Tiles">Tiles</option><option value="Sanitaryware">Sanitaryware</option><option value="Accessories">Accessories</option></select></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><label class="form-label">Brand</label><input id="brand" class="form-control"/></div>
          <div class="col-md-6"><label class="form-label">Size</label><input id="size" class="form-control" placeholder="e.g., 2x2 feet or Standard"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Unit Type *</label><select id="unitType" class="form-select" required><option value="Box">Box</option><option value="Piece">Piece</option><option value="SFT">Square Feet</option></select></div>
          <div class="col-md-4"><label class="form-label">Pieces per Box</label><input id="piecesPerBox" class="form-control" type="number" value="1"/></div>
          <div class="col-md-4"><label class="form-label">SFT per Box</label><input id="sftPerBox" class="form-control" type="number" step="0.01"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Price per Unit *</label><input id="price" class="form-control" type="number" step="0.01" required/></div>
          <div class="col-md-4"><label class="form-label">Current Stock *</label><input id="stock" class="form-control" type="number" required/></div>
          <div class="col-md-4"><label class="form-label">Minimum Stock</label><input id="minStock" class="form-control" type="number" value="5"/></div>
        </div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div>
  </div></div></div>

  <!-- SALES MODAL (grid) - top buttons removed, kept within body below grid -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Record New Sale</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">

      <!-- ✅ NEW: Multi-Select Product Picker -->
  <div class="mb-3">
    <label class="form-label fw-bold">
      <i class="bi bi-lightning-charge-fill text-warning"></i> Quick Add Products (Multi-Select)
    </label>
    <div class="multi-select-dropdown">
      <button type="button" class="form-control text-start multi-select-toggle" id="multiSelectToggle" onclick="toggleMultiSelect()">
        <span id="multiSelectLabel">Click to select multiple products...</span>
        <i class="bi bi-chevron-down float-end"></i>
      </button>
      <div class="multi-select-options" id="multiSelectOptions">
        <input type="text" class="form-control form-control-sm mb-2" 
               placeholder="🔍 Search products..." 
               id="multiSelectSearch" 
               oninput="filterMultiSelectOptions()">
        <div class="multi-select-list" id="multiSelectList">
          <!-- Checkboxes populated by JS -->
        </div>
      </div>
    </div>
    <small class="text-muted">Select multiple products to auto-fill rows below</small>
  </div>



      
      <!-- ✅ NEW: Buttons at TOP -->
  <div class="mb-3 text-end">
    <button class="btn btn-outline-primary btn-sm me-2" onclick="addMoreRows()">
      <i class="bi bi-plus-circle"></i> Add More Rows
    </button>
    <button class="btn btn-outline-success btn-sm" onclick="openCustomProductPopup()">
      <i class="bi bi-pencil-square"></i> Add Custom Product
    </button>
  </div>
      <div class="table-responsive">
        <table class="table table-sm grid-table mb-0">
          <thead><tr><th class="grid-row-number">#</th><th>Product Name</th><th style="width:130px">Size</th><th style="width:90px">Qty</th><th style="width:110px">Unit</th><th style="width:120px">Price</th><th style="width:140px">Total</th><th style="width:60px"></th></tr></thead>
          <tbody id="product-grid-body"></tbody>
        </table>
      </div>

      <!-- Keep Add buttons only here (below grid) -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="addMoreRows()"><i class="bi bi-plus-circle"></i> Add More Rows</button>
          <button class="btn btn-outline-success btn-sm ms-2" onclick="openCustomProductPopup()"><i class="bi bi-pencil-square"></i> Add Custom Product</button>
        </div>
        <div class="text-end" style="min-width:320px;">
          <table class="table table-borderless mb-0">
            <tr><td class="text-end small-muted"><strong>Subtotal:</strong></td><td id="subtotal" class="text-end">₹0.00</td></tr>
            <tr style="font-size:1.25rem;color:#28a745"><td class="text-end"><strong>GRAND TOTAL:</strong></td><td id="grandTotal" class="text-end">₹0.00</td></tr>
          </table>
        </div>
      </div>
    </div>

   <div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button class="btn btn-info" onclick="generateInvoice()">
    <i class="bi bi-receipt"></i> Generate Invoice
  </button>
  <button class="btn btn-success" onclick="completeSale()">Complete Sale</button>
</div>

  </div></div></div>

  <!-- CUSTOM PRODUCT MODAL (NEW fields) -->
  <div class="modal fade" id="customProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Add Custom Product</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="customProductForm">
        <div class="mb-3"><label class="form-label">Product Name *</label><input id="customName" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Size</label><input id="customSize" class="form-control" placeholder="e.g., 3x3 feet or Standard"/></div>
        <div class="row">
        
          <div class="col-md-6 mb-3"><label class="form-label">Unit Type *</label><select id="customUnit" class="form-select"><option>Box</option><option>Piece</option><option>SFT</option></select></div>
        </div>
        <div class="mb-3"><label class="form-label">Unit Price *</label><input id="customPrice" type="number" class="form-control" min="0.01" step="0.01" value="0"/></div>
         <div class="col-md-6 mb-3"><label class="form-label">Quantity (for this sale) *</label><input id="customQty" type="number" class="form-control" min="1" value="1"/></div>


        <div class="mb-3"><label class="form-label">Total</label><div id="customTotal" class="fw-bold">₹0.00</div></div>
      </form>
    </div>

<!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Create Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6>Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 15%">Quantity</th>
                    <th style="width: 15%">Rate</th>
                    <th style="width: 20%">Amount</th>
                    <th style="width: 10%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-7"></div>
            <div class="col-md-5">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" id="invoiceSubtotal">₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Discount:
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 80px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">₹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Tax:
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 100px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">GST 5%</option>
                      <option value="12">GST 12%</option>
                      <option value="18" selected>GST 18%</option>
                      <option value="28">GST 28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">₹0.00</td>
                </tr>
                <tr class="table-success">
                  <td class="text-end"><h5>Total (₹):</h5></td>
                  <td class="text-end"><h5 id="invoiceGrandTotal">₹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer...">Thanks for your business.</textarea>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link" onclick="loadDefaultTerms()">Use Default</button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="3" 
                      placeholder="Enter terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-info" onclick="previewInvoice()">
          <i class="bi bi-eye"></i> Preview
        </button>
        <button type="button" class="btn btn-primary" onclick="saveInvoice()">
          <i class="bi bi-save"></i> Save Invoice
        </button>
      </div>
      
    </div>
  </div>
</div>

    
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="addCustomProductToGrid()">Add to Sale</button>
    </div>
  </div></div></div>


  

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    
// ==========================================
// AUTHENTICATION
// ==========================================

let currentUser = null;
let googleIdToken = null;
let GOOGLE_CLIENT_ID = null;

// On page load - check authentication
window.addEventListener('load', async function() {
  // Fetch CLIENT_ID from server (secure)
  await fetchClientId();
  
  // Check if user has a saved session
  const savedToken = localStorage.getItem('googleIdToken');
  if (savedToken) {
    await authenticateWithToken(savedToken);
  } else {
    showAuthScreen();
  }
});

// Fetch CLIENT_ID from server
async function fetchClientId() {
  try {
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getClientId`);
    const data = await response.json();
    if (data.ok) {
      GOOGLE_CLIENT_ID = data.clientId;
      // Update the data-client_id attribute
      const gIdOnload = document.querySelector('[data-client_id]');
      if (gIdOnload) {
        gIdOnload.setAttribute('data-client_id', GOOGLE_CLIENT_ID);
      }
    }
  } catch (error) {
    console.error('Error fetching client ID:', error);
    alert('Failed to initialize authentication. Please refresh the page.');
  }
}

// Handle Google Sign-In response
async function handleCredentialResponse(response) {
  const idToken = response.credential;
  await authenticateWithToken(idToken);
}

// Authenticate with Google ID token
async function authenticateWithToken(idToken) {
  try {
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `action=authenticate&idToken=${encodeURIComponent(idToken)}`
    });
    
    const data = await response.json();
    
    if (data.ok) {
      // Authentication successful
      currentUser = data.user;
      googleIdToken = idToken;
      localStorage.setItem('googleIdToken', idToken);
      
      showApp();
      updateUserUI();
      
      // Load inventory data
      syncFromGoogleSheets();
    } else {
      // Authentication failed
      showAuthError(data.message || 'Access denied');
      localStorage.removeItem('googleIdToken');
    }
  } catch (error) {
    console.error('Authentication error:', error);
    showAuthError('Authentication failed. Please try again.');
  }
}

// Show authentication screen
function showAuthScreen() {
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('appContent').style.display = 'none';
}

// Show app (hide auth screen)
function showApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appContent').style.display = 'block';
}

// Update user UI
function updateUserUI() {
  if (currentUser) {
    document.getElementById('userName').textContent = currentUser.name;
    if (currentUser.picture) {
      const avatar = document.getElementById('userAvatar');
      avatar.src = currentUser.picture;
      avatar.style.display = 'inline-block';
    }
  }
}

// Show authentication error
function showAuthError(message) {
  alert('🔒 ' + message);
  showAuthScreen();
}

// Sign out
function signOut() {
  if (confirm('Are you sure you want to sign out?')) {
    currentUser = null;
    googleIdToken = null;
    localStorage.removeItem('googleIdToken');
    
    // Revoke Google session
    if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
      google.accounts.id.disableAutoSelect();
    }
    
    showAuthScreen();
  }
}



  /***********************
   * CONFIG
   ***********************/
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyU9TlmuIw4_iVg0RUqoZHXVQrmOrtpVq-mz3LNt4jeZKXEIL9vyfL5GJg0gKMvZXw/exec'; // <-- replace with your deployed URL
  let cachedProducts = [];
  let cachedSales = [];

let deletedSaleIds = []; // NEW: Track manually deleted sales

// NEW: Load deleted IDs from localStorage on page load
try {
    const stored = localStorage.getItem('deletedSaleIds');
    if (stored) {
        deletedSaleIds = JSON.parse(stored);
        console.log('ðŸ“ Loaded', deletedSaleIds.length, 'deleted sale IDs from localStorage');
    }
} catch (e) {
    console.warn('Could not load deletedSaleIds from localStorage', e);
}
    
  let hasInitialLoaded = false;

  // Keep custom products added into the current sale (persist across grid re-builds)
  let customProductsInSale = []; // { id, name, size, unitType, price, quantity, isPersistedToInventory:false/true, tempProductId }







  /***********************
   * Helpers
   ***********************/
  function showSyncIndicator(msg='Syncing...', hideAfterMs=null) {
    const el = document.getElementById('syncIndicator');
    document.getElementById('syncText').textContent = msg;
    el.style.display = 'block';
    if (hideAfterMs) setTimeout(()=> el.style.display = 'none', hideAfterMs);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  function safeParseResponse(res) {
    return res.text().then(txt => {
      try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
      catch(e) { return { ok: res.ok, json: null, text: txt }; }
    });
  }
  function formatCurrency(n){ return '₹' + Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function generateId(){ return 'TMP_' + Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  /***********************
   * Sync / Fetch
   ***********************/
  async function syncFromGoogleSheets() {
  // Check authentication
  if (!googleIdToken) {
    showAuthError('Please sign in to continue');
    return;
  }
  
  showLoading('Syncing data...');
  
  try {
    // Add idToken to request
    const url = `${GOOGLE_SCRIPT_URL}?action=getProducts&idToken=${encodeURIComponent(googleIdToken)}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.ok) {
      if (data.error === 'unauthorized') {
        showAuthError('Session expired. Please sign in again.');
        signOut();
        return;
      }
      throw new Error(data.message || 'Failed to fetch data');
    }
    
    // Process data...
    cachedProducts = data.products || [];
    renderProductTable();
    hideLoading();
    
  } catch (error) {
    console.error('Sync error:', error);
    alert('Failed to sync data: ' + error.message);
    hideLoading();
  }
}


  async function fallbackGetProductsAndSales() {
    try { const p = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`); if(p.ok){ const pj=await p.json(); if(pj && pj.products) cachedProducts=pj.products; } }
    catch(e){ console.warn('fallback products failed', e); }
    try { const s = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales&t=${Date.now()}`); if(s.ok){ const sj=await s.json(); if(sj && sj.sales) cachedSales=sj.sales; } }
    catch(e){ console.warn('fallback sales failed', e); }
    hasInitialLoaded = true; renderProducts(); renderSales();
  }
  async function manualRefresh(){ const btn = document.getElementById('refreshBtn'); const icon=document.getElementById('refreshIcon'); btn.disabled=true; icon.className='bi bi-arrow-clockwise spinner-border spinner-border-sm'; await syncFromGoogleSheets(); icon.className='bi bi-arrow-clockwise'; btn.disabled=false; }

  /***********************
   * Rendering
   ***********************/
  function categoryIconColor(cat){
    if(!cat) return '#6c757d';
    const c = cat.toLowerCase();
    if(c.includes('tile')) return '#0d6efd';
    if(c.includes('sanitary')) return '#198754';
    if(c.includes('access')) return '#fd7e14';
    return '#6c757d';
  }

  function stockBadgeHtml(stock, minStock){
    minStock = (typeof minStock === 'number') ? minStock : Number(minStock)||5;
    stock = Number(stock)||0;
    if(stock === 0) return `<span class="stock-badge bg-danger text-white">Out of Stock</span>`;
    if(stock <= minStock) return `<span class="stock-badge bg-warning text-dark">Low (${stock})</span>`;
    return `<span class="stock-badge bg-success text-white">In Stock (${stock})</span>`;
  }

  function renderProducts(){
    const tbody = document.getElementById('productsTableBody');
    if(!hasInitialLoaded){
      tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryâ€¦</div></td></tr>`;
    } else if(!cachedProducts || cachedProducts.length===0){
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
    } else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const priceText = (p.price!==undefined && p.price!==null) ? `₹${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
        html += `<tr>
          <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.category||'')}</td>
          <td>${escapeHtml(p.brand||'')}</td>
          <td><strong>${escapeHtml(p.size||'')}</strong></td>
          <td>${stockBadgeHtml(p.stock,p.minStock)}</td>
          <td>${priceText}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i> Delete</button>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }
    // mobile list
    const container = document.getElementById('mobileProductsList');
    if(!hasInitialLoaded){ container.innerHTML=`<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryâ€¦</div></div>`; }
    else if(!cachedProducts || cachedProducts.length===0){ container.innerHTML=`<div class="mobile-item text-center text-muted">No products yet</div>`; }
    else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        html += `<div class="mobile-item d-flex align-items-start justify-content-between">
          <div style="display:flex;gap:.8rem;align-items:center;">
            <div style="width:36px;text-align:center;"><i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i></div>
            <div>
              <div style="font-weight:600">${escapeHtml(p.name)}</div>
              <div class="small-muted">${escapeHtml(p.category||'')} â€¢ ${escapeHtml(p.brand||'')}</div>
              <div class="small-muted"><strong>${escapeHtml(p.size||'')}</strong> â€¢ ₹${parseFloat(p.price||0).toFixed(2)}/${p.unitType}</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div>${stockBadgeHtml(p.stock,p.minStock)}</div>
            <div style="margin-top:.5rem">
              <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }
    updateSummaryFromCache();
    loadProductsForSaleFromCache();
  }

  function renderSales(){
    const tbody = document.getElementById('salesList');
    
    if(!hasInitialLoaded){ tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading salesâ€¦</div></td></tr>`; return; }
    
    if(!cachedSales || cachedSales.length===0){ tbody.innerHTML=`<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`; return; }
    
    let html = '';
    
    const recent = (cachedSales || []).slice(0,100);
    recent.forEach(sale => {
      const d = new Date(sale.date||'');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">₹${parseFloat(sale.totalAmount||0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
    updateSummaryFromCache();
  }

  function updateSummaryFromCache(){
    if(!hasInitialLoaded){ document.getElementById('totalProducts').textContent='Loading...'; document.getElementById('salesToday').textContent='Loading...'; document.getElementById('lowStock').textContent='Loading...'; return; }
    document.getElementById('totalProducts').textContent = (cachedProducts||[]).length;
    const today = new Date().toDateString();
    const todaySales = (cachedSales||[]).filter(s => new Date(s.date).toDateString() === today);
    const sum = todaySales.reduce((acc,s) => acc + parseFloat(s.totalAmount||0), 0);
    document.getElementById('salesToday').textContent = '₹' + sum.toFixed(2);
    const low = (cachedProducts||[]).filter(p => p.stock <= p.minStock && p.stock > 0).length;
    document.getElementById('lowStock').textContent = low;
  }

  /***********************
   * Utility: build product selects including custom in-sale items
   ***********************/
  function populateProductSelectForRow(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">-- Select Product --</option>`;
    // Add cachedProducts first
    (cachedProducts || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.dataset.size = p.size || '';
      opt.dataset.unit = p.unitType || '';
      opt.dataset.price = p.price;
      opt.dataset.stock = p.stock;
      opt.text = `${p.name} (Stock: ${p.stock} ${p.unitType})`;
      sel.appendChild(opt);
    });
    // Add custom in-sale products (those not in cachedProducts yet)
    (customProductsInSale || []).forEach(cp => {
      // If a matching id already exists in cachedProducts skip
      if((cachedProducts||[]).find(p => p.id === cp.tempId)) return;
      const opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.dataset.size = cp.size || '';
      opt.dataset.unit = cp.unitType || '';
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity; // treat its available stock as sale-qty (or 9999)
      opt.text = `${cp.name} (Custom)`;
      sel.appendChild(opt);
    });
    if(current) sel.value = current;
  }

  /***********************
   * Save helpers (server calls)
   ***********************/
  async function saveProductToSheet(product, isEdit=false){
    try{
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=${isEdit ? 'updateProduct':'addProduct'}`, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(product)
      });
      const parsed = await safeParseResponse(res);
      return parsed.json || null;
    }catch(e){ console.error('saveProductToSheet', e); return null; }
  }

  async function saveSaleToSheet(item){
    try{
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=addSale`, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify(item)
      });
      const parsed = await safeParseResponse(res);
      return parsed.json || null;
    }catch(e){ console.error('saveSaleToSheet', e); return null; }
  }

  async function deleteProductFromSheet(id){
    try{
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=deleteProduct`, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({ id })
      });
      const parsed = await safeParseResponse(res);
      return parsed.json && parsed.json.success;
    }catch(e){ console.error('deleteProductFromSheet', e); return false; }
  }

  /***********************
   * Product CRUD UI
   ***********************/
  let editingProductId = null;
  function showAddProduct(){ editingProductId=null; document.getElementById('modalTitle').textContent='Add New Product'; document.getElementById('productForm').reset(); document.getElementById('productId').value=''; new bootstrap.Modal(document.getElementById('productModal')).show(); }
  function editProduct(id){
    const p = (cachedProducts||[]).find(x=>x.id===id);
    if(!p){ alert('❌ Product not found'); return; }
    editingProductId = id;
    document.getElementById('modalTitle').textContent='Edit Product';
    document.getElementById('productId').value = p.id;
    document.getElementById('productName').value = p.name;
    document.getElementById('category').value = p.category;
    document.getElementById('brand').value = p.brand||'';
    document.getElementById('size').value = p.size||'';
    document.getElementById('unitType').value = p.unitType;
    document.getElementById('piecesPerBox').value = p.piecesPerBox||1;
    document.getElementById('sftPerBox').value = p.sftPerBox||'';
    document.getElementById('price').value = p.price;
    document.getElementById('stock').value = p.stock;
    document.getElementById('minStock').value = p.minStock;
    new bootstrap.Modal(document.getElementById('productModal')).show();
  }

  async function saveProduct(){
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value.trim();
    const size = document.getElementById('size').value.trim();
    const unitType = document.getElementById('unitType').value;
    const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value)||1;
    const sftPerBox = parseFloat(document.getElementById('sftPerBox').value)||0;
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const minStock = parseInt(document.getElementById('minStock').value)||5;
    if(!name||!category||isNaN(price)||isNaN(stock)||stock<0){ alert('❌ Fill required fields'); return; }
    const product = { id: editingProductId || (Date.now().toString(36)+Math.random().toString(36).substr(2)), name, category, brand, size, unitType, piecesPerBox, sftPerBox, price, stock, minStock };
    const idx = (cachedProducts||[]).findIndex(p=>p.id===product.id);
    const previous = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
    if(idx !== -1) cachedProducts[idx] = product; else cachedProducts.push(product);
    renderProducts();
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal')); if(modal) modal.hide();
    showSyncIndicator('Saving product...');
    // background save but update local id if server returns id
    saveProductToSheet(product, !!editingProductId).then(resp=>{
      if(resp && resp.success && resp.id){
        const localIdx = cachedProducts.findIndex(p=>p.id===product.id);
        if(localIdx!==-1){ cachedProducts[localIdx].id = resp.id; renderProducts(); }
      }
      showSyncIndicator('Saved',900);
    }).catch(err=>{ console.error(err); if(previous) cachedProducts[idx]=previous; renderProducts(); alert('❌ Save failed - reverted locally.'); });
  }

  function deleteProduct(id){
    if(!confirm('Are you sure?')) return;
    const prev = cachedProducts.slice();
    cachedProducts = (cachedProducts||[]).filter(p=>p.id!==id);
    renderProducts();
    showSyncIndicator('Deleting...');
    deleteProductFromSheet(id).then(success=>{ if(success) showSyncIndicator('Deleted',900); else { cachedProducts = prev; renderProducts(); alert('❌ Delete failed - reverted locally.'); } });
  }

  /***********************
   * SALES GRID: create rows, populate selects, mobile behavior
   ***********************/
  function openSalesModal(){
  initSalesGrid();
  populateMultiSelect(); // ✅ NEW: Populate multi-select
  new bootstrap.Modal(document.getElementById('salesModal')).show();
}

// ✅ NEW: Multi-Select Functions
function populateMultiSelect() {
    const container = document.getElementById('multiSelectList');
    if (!container) return;
    
    let html = '';
    
    cachedProducts.filter(p => p.stock > 0).forEach(product => {
        html += `
            <div class="multi-select-item">
                <div class="form-check">
                    <input class="form-check-input multi-select-checkbox" type="checkbox" 
                           id="multi-${product.id}" 
                           value="${product.id}"
                           onchange="onMultiSelectChange()">
                    <label class="form-check-label" for="multi-${product.id}">
                        ${escapeHtml(product.name)} 
                        <small class="text-muted">(Stock: ${product.stock} ${product.unitType})</small>
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<small class="text-muted">No products available</small>';
}

function toggleMultiSelect() {
    const options = document.getElementById('multiSelectOptions');
    options.classList.toggle('show');
}

function filterMultiSelectOptions() {
    const searchTerm = document.getElementById('multiSelectSearch').value.toLowerCase();
    const items = document.querySelectorAll('.multi-select-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function onMultiSelectChange() {
    const checkedProducts = [];
    
    // Get all checked checkboxes
    document.querySelectorAll('.multi-select-checkbox:checked').forEach(checkbox => {
        const productId = checkbox.value;
        const product = cachedProducts.find(p => p.id === productId);
        if (product) {
            checkedProducts.push(product);
        }
    });
    
    // Update label
    const label = document.getElementById('multiSelectLabel');
    if (checkedProducts.length === 0) {
        label.innerHTML = 'Click to select multiple products...';
    } else {
        label.innerHTML = `<strong>${checkedProducts.length} product${checkedProducts.length > 1 ? 's' : ''} selected</strong>`;
    }
    
    // Auto-populate rows
    ensureEnoughRows(checkedProducts.length);
    populateRowsWithSelectedProducts(checkedProducts);
}

function ensureEnoughRows(needed) {
    const currentRows = document.querySelectorAll('#product-grid-body tr').length;
    if (needed > currentRows) {
        const rowsToAdd = needed - currentRows;
        for (let i = 0; i < rowsToAdd; i++) {
            const currentCount = document.querySelectorAll('#product-grid-body tr').length;
            appendEmptyRow(currentCount + 1);
        }
        updateRowNumbers();
    }
}

function populateRowsWithSelectedProducts(products) {
    products.forEach((product, index) => {
        const rowIndex = index + 1;
        
        // Select product in dropdown
        const select = document.getElementById(`product-${rowIndex}`);
        if (select) {
            select.value = product.id;
            onProductSelect(rowIndex); // Trigger auto-fill
        }
    });
    
    updateGrandTotal();
}

// Close multi-select when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.multi-select-dropdown');
    const options = document.getElementById('multiSelectOptions');
    if (dropdown && !dropdown.contains(e.target) && options) {
        options.classList.remove('show');
    }
});



    
  function initSalesGrid(){
    const body = document.getElementById('product-grid-body');
    body.innerHTML = '';
    for(let i=1;i<=3;i++) appendEmptyRow(i);
    updateRowNumbers();
    updateGrandTotal();
  }

  function appendEmptyRow(index){
    const tbody = document.getElementById('product-grid-body');
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.dataset.custom = 'false';
    tr.innerHTML = `
      <td class="grid-row-number"></td>
      <td>
        <select class="form-select product-select" id="product-${index}" onchange="onProductSelect(${index})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${index}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${index}" min="1" disabled placeholder="Enter quantity" oninput="onQtyChange(${index})"></td>

      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${index}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${index}" readonly /></td>
      <td><div id="total-${index}" class="fw-bold">₹0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
    populateProductSelectForRow(index);
  }

  function addMoreRows(){
    const currentCount = document.querySelectorAll('#product-grid-body .product-row').length;
    for(let i=1;i<=3;i++) appendEmptyRow(currentCount+i);
    updateRowNumbers();
  }

 function removeRow(btn) {
  const tr = btn.closest('tr')
  if(!tr) return
  
  // ✅ FIX: Don't actually delete the row - just clear/reset it
  const select = tr.querySelector('.product-select')
  const sizeEl = tr.querySelector('.size-input')
  const qtyEl = tr.querySelector('.qty-input')
  const unitEl = tr.querySelector('.unit-input')
  const priceEl = tr.querySelector('.price-input')
  const totalEl = tr.querySelector('[id^="total-"]')
  
  // If custom product, remove from array
  if(select && select.value && select.value.startsWith('CUST_TMP_')) {
    customProductsInSale = customProductsInSale.filter(c => c.tempId !== select.value)
  }
  
  // Reset all fields to empty/default state
  if(select) {
    select.value = ''
    select.disabled = false
  }
  if(sizeEl) sizeEl.value = ''
  if(unitEl) unitEl.value = ''
  if(priceEl) priceEl.value = ''
  if(qtyEl) {
    qtyEl.value = ''
    qtyEl.disabled = true // Disable until product selected
    qtyEl.removeAttribute('max')
  }
  if(totalEl) totalEl.textContent = formatCurrency(0)
  
  // ✅ CRITICAL: Get row index and re-attach event listener
  const rowIndex = Array.from(tr.parentNode.children).indexOf(tr) + 1;
  
  if(select) {
    // Re-populate select options
    populateProductSelectForRow(rowIndex);
    
    // Re-attach onchange handler
    select.onchange = function() {
      onProductSelect(rowIndex);
    };
  }
  
  updateGrandTotal()
}


  function updateRowNumbers(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      r.querySelector('.grid-row-number').textContent = idx;
      // update element ids to keep consistent
      const sel = r.querySelector('.product-select'); if(sel) sel.id = `product-${idx}`;
      const sizeEl = r.querySelector('.size-input'); if(sizeEl) sizeEl.id = `size-${idx}`;
      const qtyEl = r.querySelector('.qty-input'); if(qtyEl){ qtyEl.id = `qty-${idx}`; qtyEl.setAttribute('oninput', `onQtyChange(${idx})`); }
      const unitEl = r.querySelector('.unit-input'); if(unitEl) unitEl.id = `unit-${idx}`;
      const priceEl = r.querySelector('.price-input'); if(priceEl) priceEl.id = `price-${idx}`;
      const totalEl = r.querySelector('[id^=total-]'); if(totalEl) totalEl.id = `total-${idx}`;
      // ensure options refreshed (keeps custom options)
      populateProductSelectForRow(idx);
    });
  }


    // ========== NEW: Sort sales by date (newest first) ==========
function sortSalesByDateDescending() {
    cachedSales.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Newest first
    });
    console.log('ðŸ”„ Sales sorted: newest first');
}

  /***********************
   * Row interactions
   ***********************/
  function onProductSelect(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    const sizeEl = document.getElementById(`size-${rowIndex}`);
    const unitEl = document.getElementById(`unit-${rowIndex}`);
    const priceEl = document.getElementById(`price-${rowIndex}`);
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!sel) return;
    const val = sel.value;
    if(!val){
      if(sizeEl) sizeEl.value=''; if(unitEl) unitEl.value=''; if(priceEl) priceEl.value=''; if(qtyEl){ qtyEl.value=''; qtyEl.disabled=true; qtyEl.removeAttribute('max'); }
      document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
      updateGrandTotal(); return;
    }
    // if this value is a custom temporary product
    if(val.startsWith('CUST_TMP_')){
      const cp = customProductsInSale.find(c => c.tempId === val);
      if(cp){
        sizeEl.value = cp.size || 'N/A';
        unitEl.value = cp.unitType;
        priceEl.value = cp.price;
        qtyEl.disabled = false;
        qtyEl.max = cp.quantity || '';
        qtyEl.value = cp.quantity || '';
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * (cp.quantity||0));
        updateGrandTotal();
      }
      return;
    }
    // Normal product from cachedProducts
    const product = (cachedProducts || []).find(p => p.id === val);
    if(!product){ sizeEl.value=''; unitEl.value=''; priceEl.value=''; if(qtyEl){ qtyEl.disabled=true; qtyEl.value=''; } return; }
    sizeEl.value = product.size || 'N/A';
    unitEl.value = product.unitType || '';
    priceEl.value = product.price || 0;
    qtyEl.disabled = false;
    qtyEl.value = '';
    qtyEl.max = product.stock || '';
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
    updateGrandTotal();
  }

  function onQtyChange(rowIndex){
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!qtyEl) return;
    const qty = Number(qtyEl.value || 0);
    const max = Number(qtyEl.max || Infinity);
    if(qty > max){
      alert(`❌ Quantity exceeds available stock (${max}). Adjusting to max.`);
      qtyEl.value = max;
    }
    updateRowTotal(rowIndex);
    updateGrandTotal();
  }

  function updateRowTotal(rowIndex){
    const price = Number(document.getElementById(`price-${rowIndex}`).value || 0);
    const qty = Number(document.getElementById(`qty-${rowIndex}`).value || 0);
    const total = price * qty;
    const el = document.getElementById(`total-${rowIndex}`);
    if(el) el.textContent = formatCurrency(total);
    return total;
  }

  function updateGrandTotal(){
    let grand = 0;
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel) return;
      if(!sel.value && r.dataset.custom!=='true') return;
      const qty = Number(document.getElementById(`qty-${idx}`)?.value || 0);
      const price = Number(document.getElementById(`price-${idx}`)?.value || 0);
      const line = qty * price;
      grand += line;
      const totalEl = document.getElementById(`total-${idx}`);
      if(totalEl) totalEl.textContent = formatCurrency(line);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(grand);
    document.getElementById('subtotal').textContent = formatCurrency(grand);
  }

  /***********************
   * CUSTOM PRODUCT: open, validate, add to grid (and optionally inventory)
   ***********************/
function openCustomProductPopup() {
  document.getElementById('customProductForm').reset();
  document.getElementById('customTotal').textContent = '₹0.00';
  new bootstrap.Modal(document.getElementById('customProductModal'), {backdrop: 'static'}).show();
  setTimeout(() => document.getElementById('customName').focus(), 200);
}

  function updateCustomTotalDisplay(){
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    document.getElementById('customTotal').textContent = formatCurrency(qty * price);
  }
  // Attach in case DOM ready
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.id==='customQty' || e.target.id==='customPrice')) updateCustomTotalDisplay();
  });

function validateCustomProduct() {
  const name = document.getElementById('customName').value.trim();
  const qty = Number(document.getElementById('customQty').value || 0);
  const price = Number(document.getElementById('customPrice').value || 0);
  
  if (!name || name.length < 2) {
    alert('❌ Product name required (min 2 chars)');
    return false;
  }
  
  if (!qty || qty < 1) {
    alert('❌ Quantity must be at least 1');
    return false;
  }
  
  if (!price || price <= 0) {
    alert('❌ Unit price must be greater than 0');
    return false;
  }
  
  return true;
}


function addCustomProductToGrid() {
  if (!validateCustomProduct()) return;
  
  const name = document.getElementById('customName').value.trim();
  const size = document.getElementById('customSize').value.trim() || 'N/A';
  const qty = Number(document.getElementById('customQty').value || 0);
  const unitType = document.getElementById('customUnit').value || 'Box';
  const price = Number(document.getElementById('customPrice').value || 0);
  
  const tempId = 'CUST_TMP_' + Date.now().toString(36); // Unique temp id
  
  // Store in persistent array
  const cp = {
    tempId: tempId,
    name: name,
    size: size,
    unitType: unitType,
    price: price,
    quantity: qty
  };
  
  customProductsInSale.push(cp);
  
  // Find first empty row or append new row
  let idx = findFirstEmptyRowIndex();
  if (!idx) {
    const count = document.querySelectorAll('#product-grid-body .product-row').length;
    appendEmptyRow(count + 1);
    updateRowNumbers();
    idx = count + 1;
  }
  
  // Populate row with custom data
  populateRowWithCustom(idx, cp);
  updateGrandTotal();
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('customProductModal'));
  if (modal) modal.hide();
  
  // Show success
  alert(`✅ Custom product "${name}" added to sale!`);
}


function populateRowWithCustom(rowIndex, cp){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    // ensure select contains this option (populateProductSelectForRow will add it)
    populateProductSelectForRow(rowIndex);
    // create or update option
    let opt = Array.from(sel.options).find(o=>o.value===cp.tempId);
    if(!opt){
      opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.text = `${cp.name} (Custom)`;
      opt.dataset.size = cp.size;
      opt.dataset.unit = cp.unitType;
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity;
      sel.appendChild(opt);
    }
    sel.value = cp.tempId;
    document.getElementById(`size-${rowIndex}`).value = cp.size;
    document.getElementById(`unit-${rowIndex}`).value = cp.unitType;
    document.getElementById(`price-${rowIndex}`).value = cp.price;
    
    // ✅ FIX: Make quantity editable for custom products
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    qtyEl.disabled = false;  // ✅ Keep enabled
    qtyEl.readOnly = false;  // ✅ Not read-only
    qtyEl.value = cp.quantity;
    qtyEl.max = cp.quantity; // Can increase up to this amount
    
    // ✅ NEW: Add event listener to update total when quantity changes
    qtyEl.addEventListener('input', function() {
        const newQty = parseFloat(this.value) || 0;
        const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
        const total = newQty * price;
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(total);
        updateGrandTotal();
    });
    
    // Set initial total
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * cp.quantity);
}



  function findFirstEmptyRowIndex(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    for(let i=0;i<rows.length;i++){
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel || !sel.value) return idx;
    }
    return null;
  }

  /***********************
   * COMPLETE SALE (fire-and-forget background saves)
   ***********************/
  async function completeSale(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    const saleItems = [];
    let hasErrors = false;

    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      const qtyEl = document.getElementById(`qty-${idx}`);
      const priceEl = document.getElementById(`price-${idx}`);
      const unitEl = document.getElementById(`unit-${idx}`);
      const sizeEl = document.getElementById(`size-${idx}`);
      if(!sel) return;
      // Skip empty rows
      if(!sel.value) return;

      const qty = Number(qtyEl.value || 0);
      if(!qty || qty <= 0){ alert(`❌ Row ${idx}: Enter a valid quantity`); hasErrors = true; return; }
      const maxStock = Number(qtyEl.max || Infinity);
      if(!sel.value.startsWith('CUST_TMP_') && qty > maxStock){ alert(`❌ Row ${idx}: Quantity exceeds available stock (${maxStock})`); hasErrors = true; return; }

      // Determine if custom (temp) or normal product
      let isCustom = sel.value.startsWith('CUST_TMP_');
      let productId = isCustom ? null : sel.value;
      let productName = '';
      let size = sizeEl.value || 'N/A';
      let unitType = unitEl.value || '';
      let unitPrice = Number(priceEl.value || 0);
      let lineTotal = unitPrice * qty;

      if(isCustom){
        const cp = customProductsInSale.find(c => c.tempId === sel.value) || {};
        productName = cp.name || (sel.options[sel.selectedIndex]?.text || 'Custom');
      } else {
        const prod = (cachedProducts||[]).find(p => p.id === productId);
        if(!prod){ alert(`❌ Row ${idx}: Product not found`); hasErrors = true; return; }
        productName = prod.name;
        size = prod.size || size;
        unitType = prod.unitType || unitType;
        unitPrice = prod.price || unitPrice;
      }

      saleItems.push({
        productId,
        productName,
        size,
        quantity: qty,
        unitType,
        unitPrice,
        totalAmount: lineTotal,
        isCustomProduct: isCustom
      });
    });

    if(hasErrors) return;
    if(saleItems.length === 0){ alert('❌ Please add at least one product to the sale'); return; }

    // OPTIMISTIC: update local cache & UI immediately
    const saleId = 'SALE_' + Date.now();
    const nowIso = new Date().toISOString();
    // push each line to cachedSales and deduct stock for non-custom
    saleItems.forEach(item => {
      const line = {
        id: generateId(),
        saleId,
        productId: item.productId || '',
        productName: item.productName,
        size: item.size,
        quantity: item.quantity,
        unitType: item.unitType,
        unitPrice: item.unitPrice,
        totalAmount: item.totalAmount,
        date: nowIso,
        isCustomProduct: item.isCustomProduct
      };
      cachedSales.unshift(line);
      // Deduct stock optimistically
      if(!item.isCustomProduct && item.productId){
        const pi = cachedProducts.findIndex(p => p.id === item.productId);
        if(pi !== -1){
          cachedProducts[pi].stock = Number(cachedProducts[pi].stock || 0) - Number(item.quantity);
          if(cachedProducts[pi].stock < 0) cachedProducts[pi].stock = 0;
        }
      }
    });

      // âœ… NEW: Sort sales by date after adding new sales
    sortSalesByDateDescending();
    renderProducts();
    renderSales();

    // Close modal immediately (fast UX)
    const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
    if(modal) modal.hide();

    // Show immediate success message and that save happens in background
    const grandTotal = saleItems.reduce((s,it) => s + Number(it.totalAmount || 0), 0);
    setTimeout(()=> alert(`âœ… Sale recorded locally!\nItems: ${saleItems.length}\nTotal: ${formatCurrency(grandTotal)}\n\nSaving to Google Sheets in background...`), 300);

    // FIRE AND FORGET: save each item in background (don't block UI)
    const saves = saleItems.map(item => {
      const payload = {
        saleId,
        productId: item.productId || '',
        productName: item.productName,
        size: item.size,
        quantity: item.quantity,
        unitType: item.unitType,
        unitPrice: item.unitPrice,
        totalAmount: item.totalAmount,
        isCustomProduct: item.isCustomProduct || false
      };
      return saveSaleToSheet(payload).then(resp=>{
        if(!(resp && resp.success)){
          console.error('Sale line failed to save', payload, resp);
          // optionally: mark a small flag in UI or show toast later
          return { ok:false, payload, resp };
        }
        return { ok:true, payload, resp };
      }).catch(err => { console.error('saveSale error', err); return { ok:false, payload, err }; });
    });

    // handle results when finished (optional)
    Promise.allSettled(saves).then(results => {
      const failed = results.filter(r => r.status === 'fulfilled' && r.value && r.value.ok === false);
      if(failed.length){
        console.warn('Some rows failed to save', failed);
        // show a gentle non-blocking alert
        setTimeout(()=> alert(`âš ï¸ Some items failed to sync to Google Sheets. Please click Refresh later.`), 800);
      } else {
        // re-sync to get canonical server state (ids, timestamps, stock)
        syncFromGoogleSheets();
      }
    });
  }

  /***********************
   * Load sale product select helper (if needed elsewhere)
   ***********************/
  function loadProductsForSaleFromCache(){
    // not used directly now (we populate selects per-row), but keep for compatibility
  }

  /***********************
   * Backup/Import
   ***********************/
  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('âœ… Backup downloaded');
  }
  function importData(){ document.getElementById('fileInput').click(); }
  function handleFileImport(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(evt){ try{ const data = JSON.parse(evt.target.result); if(data.products) cachedProducts = data.products; if(data.sales) cachedSales = data.sales; hasInitialLoaded=true; renderProducts(); renderSales(); alert('âœ… Data restored (local)'); }catch(err){ alert('❌ Invalid file'); } }; reader.readAsText(file); }

      function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // If empty, display all products
    if (!searchTerm) {
        displayAllProducts();
        return;
    }
    
    // Filter products
    const filteredProducts = cachedProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category || '').toLowerCase();
        const brand = (product.brand || '').toLowerCase();
        const size = (product.size || '').toLowerCase();
        
        return name.includes(searchTerm) ||
               category.includes(searchTerm) ||
               brand.includes(searchTerm) ||
               size.includes(searchTerm);
    });
    
    // Display filtered products
    displayProducts(filteredProducts);
}

function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-search"></i>
                    <p>No products found matching your search</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    products.forEach(product => {
        const iconColor = categoryIconColor(product.category);
        const stockClass = product.stock > product.minStock ? 'In Stock' : 
                          product.stock > 0 ? 'Low' : 'Out of Stock';
        const stockBadgeClass = product.stock > product.minStock ? 'bg-success' : 
                               product.stock > 0 ? 'bg-warning' : 'bg-danger';
        
        html += `
            <tr>
                <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>
                <td>${escapeHtml(product.name)}</td>
                <td>${escapeHtml(product.category)}</td>
                <td>${escapeHtml(product.brand) || '-'}</td>
                <td><strong>${escapeHtml(product.size) || 'N/A'}</strong></td>
                <td><span class="badge ${stockBadgeClass}">${stockClass} (${product.stock})</span></td>
                <td>₹${product.price.toFixed(2)}/${product.unitType}</td>
                <td>
                    <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Also update mobile list
    const container = document.getElementById('mobileProductsList');
    if (products.length === 0) {
        container.innerHTML = '<div class="mobile-item text-center text-muted">No products found</div>';
        return;
    }
    
    let mobileHtml = '';
    products.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const stockBadge = stockBadgeHtml(p.stock, p.minStock);
        mobileHtml += `
            <div class="mobile-item d-flex align-items-start justify-content-between">
                <div style="display:flex;gap:.8rem;align-items:center">
                    <div style="width:36px;text-align:center">
                        <i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600">${escapeHtml(p.name)}</div>
                        <div class="small-muted">${escapeHtml(p.category)} ${escapeHtml(p.brand)}</div>
                        <div class="small-muted"><strong>${escapeHtml(p.size)}</strong> ₹${parseFloat(p.price || 0).toFixed(2)}/${p.unitType}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    ${stockBadge}
                    <div style="margin-top:.5rem">
                        <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = mobileHtml;
}

function displayAllProducts() {
    displayProducts(cachedProducts);
}


    // Open Clear Sales popup
function openClearSalesPopup() {
    // Set default dates (last 30 days to today)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('clearFromDate').value = formatDateForInput(thirtyDaysAgo);
    document.getElementById('clearToDate').value = formatDateForInput(today);
    
    // Reset count display
    document.getElementById('clearSalesCount').style.display = 'none';
    
    // Add event listeners to count on date change
    document.getElementById('clearFromDate').addEventListener('change', updateClearSalesCount);
    document.getElementById('clearToDate').addEventListener('change', updateClearSalesCount);
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('clearSalesModal'));
    modal.show();
    
    // Initial count
    updateClearSalesCount();
}

// Format date for input field (YYYY-MM-DD)
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Update count of sales in selected date range
function updateClearSalesCount() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) return;
    
    if (fromDate > toDate) {
        alert('❌ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Count sales in range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    // Display count
    const countDiv = document.getElementById('clearSalesCount');
    const countNumber = document.getElementById('salesCountNumber');
    
    countNumber.textContent = salesInRange.length;
    countDiv.style.display = salesInRange.length > 0 ? 'block' : 'none';
}

// Clear sales in date range
function clearSalesInDateRange() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) {
        alert('❌ Please select both From and To dates');
        return;
    }
    
    // Set time to start/end of day for accurate comparison
    fromDate.setHours(0, 0, 0, 0);
    toDate.setHours(23, 59, 59, 999);
    
    if (fromDate > toDate) {
        alert('❌ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Find sales in date range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    if (salesInRange.length === 0) {
        alert('â„¹ï¸ No sales found in the selected date range');
        return;
    }
    
    // Confirm deletion
    const fromStr = fromDate.toLocaleDateString('en-IN');
    const toStr = toDate.toLocaleDateString('en-IN');
    const confirmMsg = `Are you sure you want to hide ${salesInRange.length} sales records between ${fromStr} and ${toStr}?\n\nâš ï¸ This will hide them from display only.\nGoogle Sheets data remains unchanged.\n\nYou can restore them later by clearing browser data.`;
    
    if (!confirm(confirmMsg)) return;
    
    // âœ… FIX: Store deleted IDs persistently
    salesInRange.forEach(sale => {
        if (sale.id && !deletedSaleIds.includes(sale.id)) {
            deletedSaleIds.push(sale.id);
        }
    });
    
    // Save to localStorage for persistence across sessions and page reloads
    try {
        localStorage.setItem('deletedSaleIds', JSON.stringify(deletedSaleIds));
        console.log('ðŸ’¾ Saved', deletedSaleIds.length, 'deleted sale IDs to localStorage');
    } catch (e) {
        console.warn('Could not save deletedSaleIds to localStorage', e);
    }
    
    // Filter out sales in the date range
    cachedSales = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate < fromDate || saleDate > toDate;
    });
    
    // Update display
    displaySalesFromCache();
    updateSummaryFromCache();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearSalesModal'));
    modal.hide();
    
    // Show success message
    alert(`âœ… Successfully cleared ${salesInRange.length} sales records!\n\nNote: They're hidden from display only. Google Sheets data is unchanged.\n\nTo restore: Clear browser data or use developer console to run:\nlocalStorage.removeItem('deletedSaleIds')`);
}


   function displaySalesFromCache() {
  const salesList = document.getElementById('salesList');
  
  if (cachedSales.length === 0) {
    salesList.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  salesList.innerHTML = '';
  
  // ✅ FIX: Show only last 100 sales (most recent)
  const recentSales = cachedSales.slice(0, 100);
  
  recentSales.forEach(sale => {
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString('en-IN') + ' ' + 
                         date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
    
    const row = `
      <tr>
        <td>${formattedDate}</td>
        <td>${sale.productName}</td>
        <td>${sale.quantity}</td>
        <td>${sale.unitType}</td>
        <td class="text-success fw-bold">₹${parseFloat(sale.totalAmount).toFixed(2)}</td>
      </tr>
    `;
    
    salesList.innerHTML += row;
  });
  
  // ✅ FIX: Show count if more than 100 sales exist
  if (cachedSales.length > 100) {
    salesList.innerHTML += `
      <tr>
        <td colspan="5" class="text-center text-muted">
          <small>Showing 100 most recent sales. Total: ${cachedSales.length} sales</small>
        </td>
      </tr>
    `;
  }
}



  /***********************
   * Init
   ***********************/
  document.addEventListener('DOMContentLoaded', ()=>{
    // initial placeholders
    renderProducts();
    renderSales();
    syncFromGoogleSheets();
  });


    /***********************
 * INVOICE GENERATOR
 ***********************/

// Global variable to store invoice number counter
let invoiceCounter = parseInt(localStorage.getItem('lastInvoiceNumber') || '0');

function generateInvoice() {
  
  
  // Collect products from sale grid
  const rows = document.querySelectorAll('#product-grid-body .product-row');
 
  
  const items = [];
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    const priceEl = document.getElementById(`price-${idx}`);
    const sizeEl = document.getElementById(`size-${idx}`);
    
    // Skip if no product selected or no quantity
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return; // Continue to next iteration
    }
    
    // Get clean product name without stock info
let productName = sel.options[sel.selectedIndex]?.text || 'Product';
// Remove stock information (e.g., "(Stock: 147 Box)")
productName = productName.replace(/\(Stock:.*?\)/g, '').trim();

    const quantity = Number(qtyEl.value);
    const rate = Number(priceEl.value || 0);
    const size = sizeEl.value || '';
    
    items.push({
      name: productName,
      size: size,
      quantity: quantity,
      rate: rate,
      amount: quantity * rate
    });
  });
  
  
  if (items.length === 0) {
    
    return;
  }
  

  
  // Store items temporarily
  window.tempInvoiceItems = items;
  
  
  
  // Open invoice modal
  openInvoiceModal();
  
}


function openInvoiceModal() {

  
  // Check if modal exists
  const modalEl = document.getElementById('invoiceModal');
  
  
  if (!modalEl) {
    
    return;
  }
  
  
  // Generate invoice number
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  
  const invoiceNumEl = document.getElementById('invoiceNumber');
  
  if (invoiceNumEl) {
    invoiceNumEl.value = invoiceNo;
  }
  
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  
 
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('invoiceDate');
  if (dateEl) {
    dateEl.value = today;
  }
  

  calculateDueDate();
  populateInvoiceItems();
  loadDefaultTerms();
  
  // Show modal
  try {
    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
 
  } catch (error) {
    
  }
}


// Regenerate Invoice Number
function regenerateInvoiceNumber() {
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  document.getElementById('invoiceNumber').value = invoiceNo;
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
}

// Calculate Due Date based on Payment Terms
function calculateDueDate() {
  const invoiceDate = new Date(document.getElementById('invoiceDate').value);
  const terms = parseInt(document.getElementById('paymentTerms').value);
  
  const dueDate = new Date(invoiceDate);
  dueDate.setDate(dueDate.getDate() + terms);
  
  document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
}

// Populate Invoice Items from Sale
function populateInvoiceItems() {
  const tbody = document.getElementById('invoiceItemsBody');
  tbody.innerHTML = '';
  
  if (!window.tempInvoiceItems || window.tempInvoiceItems.length === 0) return;
  
  window.tempInvoiceItems.forEach((item, index) => {
    const row = createInvoiceRow(item, index);
    tbody.innerHTML += row;
  });
  
  calculateInvoiceTotal();
}

// Create Invoice Row HTML
function createInvoiceRow(item, index) {
  const itemName = item.size ? `${item.name} (${item.size})` : item.name;
  return `
    <tr data-index="${index}">
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="${escapeHtml(itemName)}" 
               oninput="calculateInvoiceTotal()">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-center invoice-qty" 
               value="${item.quantity}" min="1" 
               oninput="updateInvoiceRowTotal(${index})">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-end invoice-rate" 
               value="${item.rate}" min="0" step="0.01" 
               oninput="updateInvoiceRowTotal(${index})">
      </td>
      <td class="text-end fw-bold invoice-row-total">
        ₹${(item.quantity * item.rate).toFixed(2)}
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-link text-danger" 
                onclick="deleteInvoiceRow(${index})">
          <i class="bi bi-x-lg"></i>
        </button>
      </td>
    </tr>
  `;
}

// Update Invoice Row Total
function updateInvoiceRowTotal(index) {
  const row = document.querySelector(`#invoiceItemsBody tr[data-index="${index}"]`);
  if (!row) return;
  
  const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
  const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
  const total = qty * rate;
  
  row.querySelector('.invoice-row-total').textContent = formatCurrency(total);
  calculateInvoiceTotal();
}

// Delete Invoice Row
function deleteInvoiceRow(index) {
  const row = document.querySelector(`#invoiceItemsBody tr[data-index="${index}"]`);
  if (row) {
    row.remove();
    calculateInvoiceTotal();
  }
}

// Add New Invoice Row
function addInvoiceRow() {
  const tbody = document.getElementById('invoiceItemsBody');
  const index = tbody.querySelectorAll('tr').length;
  
  const newItem = {
    name: '',
    size: '',
    quantity: 1,
    rate: 0,
    amount: 0
  };
  
  tbody.innerHTML += createInvoiceRow(newItem, index);
}

// Calculate Invoice Total
function calculateInvoiceTotal() {
  // Calculate subtotal
  let subtotal = 0;
  document.querySelectorAll('#invoiceItemsBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.invoice-qty')?.value) || 0;
    const rate = parseFloat(row.querySelector('.invoice-rate')?.value) || 0;
    subtotal += qty * rate;
  });
  
  document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
  
  // Calculate discount
  const discountValue = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
  const discountType = document.getElementById('invoiceDiscountType').value;
  let discount = 0;
  
  if (discountType === 'amount') {
    discount = discountValue;
  } else {
    discount = (subtotal * discountValue) / 100;
  }
  
  document.getElementById('invoiceDiscountAmount').textContent = '-' + formatCurrency(discount);
  
  // Calculate tax
  const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;
  const taxableAmount = subtotal - discount;
  const tax = (taxableAmount * taxRate) / 100;
  
  document.getElementById('invoiceTaxAmount').textContent = formatCurrency(tax);
  
  // Calculate grand total
  const grandTotal = taxableAmount + tax;
  document.getElementById('invoiceGrandTotal').textContent = formatCurrency(grandTotal);
}

// Load Default Terms & Conditions
function loadDefaultTerms() {
  const defaultTerms = `1. Payment due within 14 days of invoice date
2. Late payments subject to 2% monthly interest charge
3. Goods once sold cannot be returned or exchanged
4. Delivery charges may apply for orders under ₹10,000
5. Company not responsible for damages during transit`;
  
  document.getElementById('invoiceTerms').value = defaultTerms;
}

// Save Invoice
async function saveInvoice() {
  // Validate required fields
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  
  if (!customerName) {
    alert('❌ Please enter customer name');
    return;
  }
  
  // Collect invoice data
  const invoiceData = collectInvoiceData();
  
  // Save to localStorage
  let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  invoices.push(invoiceData);
  localStorage.setItem('invoices', JSON.stringify(invoices));
  
  alert('✅ Invoice saved successfully!\n\nInvoice Number: ' + invoiceData.invoiceNumber);
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
  if (modal) modal.hide();
}

// Collect Invoice Data
function collectInvoiceData() {
  const items = [];
  document.querySelectorAll('#invoiceItemsBody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value;
    const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
    const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
    
    if (name && qty > 0) {
      items.push({
        name: name,
        quantity: qty,
        rate: rate,
        amount: qty * rate
      });
    }
  });
  
  const subtotal = parseFloat(document.getElementById('invoiceSubtotal').textContent.replace(/[₹,]/g, ''));
  const discount = parseFloat(document.getElementById('invoiceDiscountAmount').textContent.replace(/[₹,-]/g, ''));
  const tax = parseFloat(document.getElementById('invoiceTaxAmount').textContent.replace(/[₹,]/g, ''));
  const total = parseFloat(document.getElementById('invoiceGrandTotal').textContent.replace(/[₹,]/g, ''));
  
  return {
    invoiceNumber: document.getElementById('invoiceNumber').value,
    customerName: document.getElementById('invoiceCustomerName').value,
    invoiceDate: document.getElementById('invoiceDate').value,
    dueDate: document.getElementById('invoiceDueDate').value,
    items: items,
    subtotal: subtotal,
    discount: discount,
    tax: tax,
    total: total,
    notes: document.getElementById('invoiceNotes').value,
    terms: document.getElementById('invoiceTerms').value,
    createdAt: new Date().toISOString()
  };
}

// Preview Invoice
function previewInvoice() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('❌ Please enter customer name');
    return;
  }
  
  // Generate HTML for invoice
  const invoiceHTML = generateInvoiceHTML(invoiceData);
  
  // Open in new window
  const previewWindow = window.open('', 'Invoice Preview', 'width=800,height=600');
  previewWindow.document.write(invoiceHTML);
  previewWindow.document.close();
}

// Generate Invoice HTML for Preview/Print
function generateInvoiceHTML(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align: center">${index + 1}</td>
        <td>${escapeHtml(item.name)}</td>
        <td style="text-align: center">${item.quantity}</td>
        <td style="text-align: right">₹${item.rate.toFixed(2)}</td>
        <td style="text-align: right">₹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${data.invoiceNumber}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; }
        .invoice-header { text-align: center; margin-bottom: 30px; }
        .invoice-details { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; }
        th { background-color: #f8f9fa; }
        .text-right { text-align: right; }
        .total-row { font-weight: bold; background-color: #e9ecef; }
        @media print {
          button { display: none; }
        }
      </style>
      
    </head>

</div> <!-- End of appContent -->

    <body>
      <div class="invoice-header">
        <h1>INVOICE</h1>
        <h3>Tile & Sanitaryware Inventory</h3>
      </div>
      
      <div class="invoice-details">
        <p><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
        <p><strong>Customer Name:</strong> ${data.customerName}</p>
        <p><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
        <p><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
      </div>
      
      <table>
        <thead>
          <tr>
            <th style="width: 50px">#</th>
            <th>Item Description</th>
            <th style="width: 100px">Quantity</th>
            <th style="width: 120px">Rate</th>
            <th style="width: 120px">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <table style="width: 400px; margin-left: auto">
        <tr>
          <td>Sub Total:</td>
          <td class="text-right">₹${data.subtotal.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Discount:</td>
          <td class="text-right">-₹${data.discount.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Tax:</td>
          <td class="text-right">₹${data.tax.toFixed(2)}</td>
        </tr>
        <tr class="total-row">
          <td>Grand Total:</td>
          <td class="text-right">₹${data.total.toFixed(2)}</td>
        </tr>
      </table>
      
      <div style="margin-top: 30px">
        <p><strong>Customer Notes:</strong></p>
        <p>${data.notes || 'N/A'}</p>
      </div>
      
      <div style="margin-top: 20px">
        <p><strong>Terms & Conditions:</strong></p>
        <p style="white-space: pre-line">${data.terms || 'N/A'}</p>
      </div>
      
      <div style="margin-top: 40px; text-align: center">
        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer">
          Print Invoice
        </button>
      </div>

     </body>
    </html>
  `;
}
            

// ==========================================
// VIEW SAVED INVOICES FEATURE
// ==========================================

function viewSavedInvoices() {
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  
  const container = document.getElementById('invoicesListContainer');
  
  if (invoices.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> No saved invoices found
      </div>
    `;
  } else {
    let html = `
      <div class="table-responsive">
        <table class="table table-hover table-bordered">
          <thead class="table-light">
            <tr>
              <th style="width: 15%">Invoice No</th>
              <th style="width: 20%">Customer Name</th>
              <th style="width: 12%">Date</th>
              <th style="width: 12%">Due Date</th>
              <th style="width: 10%" class="text-end">Total</th>
              <th style="width: 18%">Items</th>
              <th style="width: 13%" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    invoices.forEach((inv, index) => {
      const itemsCount = inv.items ? inv.items.length : 0;
      const itemsSummary = inv.items ? inv.items.slice(0, 2).map(i => i.name).join(', ') : '';
      const moreItems = itemsCount > 2 ? ` +${itemsCount - 2} more` : '';
      
      html += `
        <tr>
          <td><strong>${inv.invoiceNumber}</strong></td>
          <td>${escapeHtml(inv.customerName)}</td>
          <td>${new Date(inv.invoiceDate).toLocaleDateString('en-IN')}</td>
          <td>${new Date(inv.dueDate).toLocaleDateString('en-IN')}</td>
          <td class="text-end"><strong>₹${inv.total.toFixed(2)}</strong></td>
          <td><small>${escapeHtml(itemsSummary)}${moreItems}</small></td>
          <td class="text-center">
            <button class="btn btn-sm btn-info" onclick="previewSavedInvoice(${index})" title="Preview">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteSavedInvoice(${index})" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      <div class="alert alert-success">
        <strong>Total Invoices:</strong> ${invoices.length}
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Show modal
  new bootstrap.Modal(document.getElementById('viewInvoicesModal')).show();
}

function previewSavedInvoice(index) {
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const invoice = invoices[index];
  
  if (!invoice) {
    alert('Invoice not found');
    return;
  }
  
  // Generate and show preview
  const invoiceHTML = generateInvoiceHTML(invoice);
  const previewWindow = window.open('', 'Invoice Preview', 'width=800,height=600');
  previewWindow.document.write(invoiceHTML);
  previewWindow.document.close();
}

function deleteSavedInvoice(index) {
  if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
    return;
  }
  
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const deletedInvoice = invoices[index];
  
  invoices.splice(index, 1);
  localStorage.setItem('invoices', JSON.stringify(invoices));
  
  alert(`✅ Invoice ${deletedInvoice.invoiceNumber} deleted successfully`);
  
  // Refresh the list
  viewSavedInvoices();
}


    // ==========================================
// SHARE INVOICE FEATURE
// ==========================================

// Share Invoice as Image (Primary Method)
async function shareInvoiceAsImage() {
  // Validate customer name
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('❌ Please enter customer name before sharing');
    return;
  }
  
  showLoading('Generating image...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML in hidden container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    // Wait for fonts to load
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    // Remove temp container
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = `Invoice_${invoiceData.invoiceNumber}_${invoiceData.customerName.replace(/\s+/g, '_')}.png`;
      const file = new File([blob], fileName, { type: 'image/png' });
      
      // Try Web Share API (mobile & modern browsers)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: `Invoice ${invoiceData.invoiceNumber}`,
            text: `Invoice for ${invoiceData.customerName} - ₹${invoiceData.total.toFixed(2)}`,
            files: [file]
          });
          console.log('✅ Invoice shared successfully');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            fallbackDownloadImage(canvas, fileName);
          }
        }
      } else {
        // Fallback: Download image
        fallbackDownloadImage(canvas, fileName);
      }
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating image:', error);
    alert('❌ Error generating invoice image. Please try again.');
  }
}

// Fallback: Download image if share not supported
function fallbackDownloadImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  alert('✅ Invoice image downloaded! You can now share it from your downloads.');
}

// Generate clean invoice HTML for image conversion
function generateInvoiceHTMLForImage(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${index + 1}</td>
        <td style="padding:8px;border:1px solid #ddd;">${escapeHtml(item.name)}</td>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${item.quantity}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">₹${item.rate.toFixed(2)}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">₹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:30px;border-bottom:3px solid #0d6efd;padding-bottom:20px;">
        <h1 style="margin:0;font-size:36px;color:#0d6efd;">INVOICE</h1>
        <h2 style="margin:10px 0;font-size:20px;color:#333;">Tile & Sanitaryware Inventory</h2>
      </div>
      
      <div style="display:flex;justify-content:space-between;margin-bottom:30px;">
        <div style="flex:1;">
          <p style="margin:5px 0;"><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
          <p style="margin:5px 0;"><strong>Customer Name:</strong> ${escapeHtml(data.customerName)}</p>
        </div>
        <div style="flex:1;text-align:right;">
          <p style="margin:5px 0;"><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p style="margin:5px 0;"><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:50px;">#</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:left;">Item Description</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:80px;">Quantity</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:100px;">Rate</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:120px;">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <div style="text-align:right;margin-bottom:20px;">
        <table style="margin-left:auto;width:300px;">
          <tr>
            <td style="padding:5px;"><strong>Sub Total:</strong></td>
            <td style="padding:5px;text-align:right;">₹${data.subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;color:#dc3545;"><strong>Discount:</strong></td>
            <td style="padding:5px;text-align:right;color:#dc3545;">-₹${data.discount.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;"><strong>Tax:</strong></td>
            <td style="padding:5px;text-align:right;">₹${data.tax.toFixed(2)}</td>
          </tr>
          <tr style="border-top:2px solid #000;">
            <td style="padding:10px;font-size:18px;"><strong>Grand Total:</strong></td>
            <td style="padding:10px;text-align:right;font-size:18px;"><strong>₹${data.total.toFixed(2)}</strong></td>
          </tr>
        </table>
      </div>
      
      ${data.notes ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Customer Notes:</strong></p>
          <p style="margin:5px 0;padding:10px;background:#f8f9fa;border-left:3px solid #0d6efd;">${escapeHtml(data.notes)}</p>
        </div>
      ` : ''}
      
      ${data.terms ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Terms & Conditions:</strong></p>
          <p style="margin:5px 0;white-space:pre-line;font-size:12px;color:#666;">${escapeHtml(data.terms)}</p>
        </div>
      ` : ''}
      
      <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #ddd;color:#666;font-size:12px;">
        <p>Thank you for your business!</p>
      </div>
    </div>
  `;
}

// Share Invoice as PDF
async function shareInvoiceAsPDF() {
  alert('📄 PDF sharing coming soon! For now, use Preview → Print to save as PDF.');
  // You can implement PDF generation using jsPDF or html2pdf.js later
}

// Share via WhatsApp (Text message)
function shareViaWhatsApp() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('❌ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Share via Email (Text)
function shareViaEmail() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('❌ Please enter customer name');
    return;
  }
  
  const subject = `Invoice ${invoiceData.invoiceNumber} from Tile & Sanitaryware Inventory`;
  const body = generateShareText(invoiceData);
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoUrl;
}

// Share via SMS (Text)
function shareViaSMS() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('❌ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
  window.location.href = smsUrl;
}

// Generate text message for sharing
function generateShareText(data) {
  let text = `🧾 INVOICE\n\n`;
  text += `Invoice No: ${data.invoiceNumber}\n`;
  text += `Customer: ${data.customerName}\n`;
  text += `Date: ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}\n`;
  text += `Due Date: ${new Date(data.dueDate).toLocaleDateString('en-IN')}\n\n`;
  
  text += `ITEMS:\n`;
  data.items.forEach((item, i) => {
    text += `${i + 1}. ${item.name} x ${item.quantity} = ₹${item.amount.toFixed(2)}\n`;
  });
  
  text += `\n`;
  text += `Sub Total: ₹${data.subtotal.toFixed(2)}\n`;
  if (data.discount > 0) {
    text += `Discount: -₹${data.discount.toFixed(2)}\n`;
  }
  if (data.tax > 0) {
    text += `Tax: ₹${data.tax.toFixed(2)}\n`;
  }
  text += `━━━━━━━━━━━━━━━━\n`;
  text += `TOTAL: ₹${data.total.toFixed(2)}\n\n`;
  
  text += `Thank you for your business!\n`;
  text += `- Tile & Sanitaryware Inventory`;
  
  return text;
}

// Loading indicator helpers
function showLoading(message = 'Processing...') {
  let loader = document.getElementById('globalLoader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'globalLoader';
    loader.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px 40px;border-radius:8px;z-index:10000;font-size:16px;';
    document.body.appendChild(loader);
  }
  loader.textContent = message;
  loader.style.display = 'block';
}

function hideLoading() {
  const loader = document.getElementById('globalLoader');
  if (loader) {
    loader.style.display = 'none';
  }
}


    
  </script>
</body>
</html>



























