<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tile & Sanitaryware Inventory</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .product-card { transition: transform 0.2s, box-shadow 0.2s; height: 100%; border: 1px solid #dee2e6; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .product-image { width: 100%; height: 200px; object-fit: cover; background-color: #e9ecef; }
        .stock-badge { font-size: 1rem; padding: 0.5rem 1rem; }
        .stock-good { background-color: #28a745; color: white; }
        .stock-low { background-color: #ffc107; color: black; }
        .stock-out { background-color: #dc3545; color: white; }
        .card-actions { display: flex; gap: 0.5rem; }
        .btn-action { flex: 1; }
        .empty-state { text-align: center; padding: 3rem; color: #6c757d; }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { background: white; padding: 2rem; border-radius: 10px; }
    </style>
</head>
<body>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading...</p>
        </div>
    </div>
    
    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory
            </span>
            <button class="btn btn-light btn-sm" onclick="loadData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </nav>

    <div class="container-fluid py-4">
        
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()">
                    <i class="bi bi-plus-circle"></i> Add Product
                </button>
                <button class="btn btn-info btn-lg mb-2" onclick="showSalesSection()">
                    <i class="bi bi-cart-check"></i> Record Sale
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-box-seam text-primary" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="totalProducts">0</h3>
                        <p class="text-muted mb-0">Total Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-currency-rupee text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="salesToday">₹0</h3>
                        <p class="text-muted mb-0">Sales Today</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" id="lowStock">0</h3>
                        <p class="text-muted mb-0">Low Stock Items</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6 mx-auto">
                <input type="text" class="form-control form-control-lg" id="searchInput" 
                       placeholder="🔍 Search products..." onkeyup="searchProducts()">
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">Products Inventory</h4>
                <div class="row" id="productsList"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <h4 class="mb-3">Recent Sales</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Date & Time</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesList"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select</option>
                                    <option value="Tiles">Tiles</option>
                                    <option value="Sanitaryware">Sanitaryware</option>
                                    <option value="Accessories">Accessories</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Brand</label>
                                <input type="text" class="form-control" id="brand">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Size</label>
                                <input type="text" class="form-control" id="size">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Unit Type *</label>
                                <select class="form-select" id="unitType" required>
                                    <option value="Box">Box</option>
                                    <option value="Piece">Piece</option>
                                    <option value="SFT">Square Feet</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pieces per Box</label>
                                <input type="number" class="form-control" id="piecesPerBox" value="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">SFT per Box</label>
                                <input type="number" class="form-control" id="sftPerBox" step="0.01">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Price per Unit *</label>
                                <input type="number" class="form-control" id="price" required step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Stock *</label>
                                <input type="number" class="form-control" id="stock" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Minimum Stock</label>
                                <input type="number" class="form-control" id="minStock" value="5">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Product Image URL</label>
                            <input type="url" class="form-control" id="imageUrl">
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Modal -->
    <div class="modal fade" id="salesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Record New Sale</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="salesForm">
                        <div class="mb-3">
                            <label class="form-label">Select Product *</label>
                            <select class="form-select" id="saleProduct" onchange="updateSalePrice()" required>
                                <option value="">Choose product...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="saleQuantity" 
                                   oninput="updateSalePrice()" required min="1">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Unit Price</label>
                            <input type="text" class="form-control" id="saleUnitPrice" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Total Amount (Editable)</label>
                            <input type="number" class="form-control" id="saleTotal" step="0.01">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="recordSale()">Complete Sale</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let cachedProducts = [];
        let cachedSales = [];
        let editingProductId = null;
        
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function loadData() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(products) {
                    cachedProducts = products;
                    displayProducts();
                    updateSummary();
                    
                    google.script.run
                        .withSuccessHandler(function(sales) {
                            cachedSales = sales;
                            displaySales();
                            updateSummary();
                            hideLoading();
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error loading sales:', error);
                            hideLoading();
                            alert('Error loading sales: ' + error.message);
                        })
                        .getSales();
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading products:', error);
                    hideLoading();
                    alert('Error loading products: ' + error.message);
                })
                .getProducts();
        }
        
        function displayProducts() {
            const list = document.getElementById('productsList');
            
            if (cachedProducts.length === 0) {
                list.innerHTML = '<div class="col-12"><div class="empty-state"><i class="bi bi-inbox"></i><h4>No Products Yet</h4></div></div>';
                return;
            }
            
            list.innerHTML = '';
            cachedProducts.forEach(p => {
                const stockClass = p.stock > p.minStock ? 'stock-good' : p.stock > 0 ? 'stock-low' : 'stock-out';
                const stockText = p.stock > p.minStock ? 'In Stock' : p.stock > 0 ? 'Low Stock' : 'Out of Stock';
                const img = p.imageUrl || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(p.name);
                
                list.innerHTML += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card product-card">
                            <img src="${img}" class="product-image" alt="${p.name}">
                            <div class="card-body">
                                <h5 class="card-title">${p.name}</h5>
                                <p class="text-muted mb-2"><small>${p.category} ${p.brand ? '• ' + p.brand : ''}</small></p>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge stock-badge ${stockClass}">${stockText}</span>
                                    <h5 class="mb-0">Stock: ${p.stock}</h5>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Price: <strong>₹${p.price}</strong>/${p.unitType}</span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-primary btn-action" onclick='editProduct(${JSON.stringify(p)})'>
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-action" onclick="deleteProduct('${p.id}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        function displaySales() {
            const list = document.getElementById('salesList');
            
            if (cachedSales.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No sales yet</td></tr>';
                return;
            }
            
            list.innerHTML = '';
            cachedSales.slice(0, 10).forEach(s => {
                const date = new Date(s.date);
                const formatted = date.toLocaleDateString('en-IN') + ' ' + date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
                
                list.innerHTML += `
                    <tr>
                        <td>${formatted}</td>
                        <td>${s.productName}</td>
                        <td>${s.quantity}</td>
                        <td>${s.unitType}</td>
                        <td class="text-success fw-bold">₹${s.totalAmount.toFixed(2)}</td>
                    </tr>
                `;
            });
        }
        
        function updateSummary() {
            document.getElementById('totalProducts').textContent = cachedProducts.length;
            
            const today = new Date().toDateString();
            const todaySales = cachedSales.filter(s => new Date(s.date).toDateString() === today);
            const total = todaySales.reduce((sum, s) => sum + s.totalAmount, 0);
            document.getElementById('salesToday').textContent = '₹' + total.toFixed(2);
            
            const lowStock = cachedProducts.filter(p => p.stock <= p.minStock && p.stock > 0);
            document.getElementById('lowStock').textContent = lowStock.length;
        }
        
        function showAddProduct() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
        
        function editProduct(product) {
            editingProductId = product.id;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('category').value = product.category;
            document.getElementById('brand').value = product.brand || '';
            document.getElementById('size').value = product.size || '';
            document.getElementById('unitType').value = product.unitType;
            document.getElementById('piecesPerBox').value = product.piecesPerBox || 1;
            document.getElementById('sftPerBox').value = product.sftPerBox || '';
            document.getElementById('price').value = product.price;
            document.getElementById('stock').value = product.stock;
            document.getElementById('minStock').value = product.minStock;
            document.getElementById('imageUrl').value = product.imageUrl || '';
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
        
        function saveProduct() {
            const product = {
                id: editingProductId,
                name: document.getElementById('productName').value.trim(),
                category: document.getElementById('category').value,
                brand: document.getElementById('brand').value.trim(),
                size: document.getElementById('size').value.trim(),
                unitType: document.getElementById('unitType').value,
                piecesPerBox: parseInt(document.getElementById('piecesPerBox').value) || 1,
                sftPerBox: parseFloat(document.getElementById('sftPerBox').value) || 0,
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
                minStock: parseInt(document.getElementById('minStock').value) || 5,
                imageUrl: document.getElementById('imageUrl').value.trim()
            };
            
            if (!product.name || !product.category || !product.price || product.stock < 0) {
                alert('Please fill all required fields!');
                return;
            }
            
            showLoading();
            
            if (editingProductId) {
                google.script.run
                    .withSuccessHandler(function() {
                        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                        loadData();
                        alert('✅ Product updated!');
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        alert('Error: ' + error.message);
                    })
                    .updateProduct(product);
            } else {
                google.script.run
                    .withSuccessHandler(function() {
                        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                        loadData();
                        alert('✅ Product added!');
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        alert('Error: ' + error.message);
                    })
                    .addProduct(product);
            }
        }
        
        function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            
            showLoading();
            google.script.run
                .withSuccessHandler(function() {
                    loadData();
                    alert('✅ Product deleted!');
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    alert('Error: ' + error.message);
                })
                .deleteProduct(id);
        }
        
        function showSalesSection() {
            document.getElementById('saleProduct').innerHTML = '<option value="">Choose product...</option>';
            cachedProducts.forEach(p => {
                if (p.stock > 0) {
                    document.getElementById('saleProduct').innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`;
                }
            });
            
            document.getElementById('salesForm').reset();
            new bootstrap.Modal(document.getElementById('salesModal')).show();
        }
        
        function updateSalePrice() {
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            
            if (!productId || quantity <= 0) {
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleUnitPrice').value = '';
                return;
            }
            
            const product = cachedProducts.find(p => p.id === productId);
            if (!product) return;
            
            if (quantity > product.stock) {
                alert(`Only ${product.stock} available!`);
                document.getElementById('saleQuantity').value = product.stock;
                return;
            }
            
            const total = product.price * quantity;
            document.getElementById('saleTotal').value = total.toFixed(2);
            document.getElementById('saleUnitPrice').value = '₹' + product.price + '/' + product.unitType;
        }
        
        function recordSale() {
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const totalAmount = parseFloat(document.getElementById('saleTotal').value);
            
            if (!productId || !quantity || !totalAmount) {
                alert('Please fill all fields!');
                return;
            }
            
            const product = cachedProducts.find(p => p.id === productId);
            if (!product) return;
            
            const sale = {
                productId: product.id,
                productName: product.name,
                quantity: quantity,
                unitType: product.unitType,
                totalAmount: totalAmount
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(function() {
                    bootstrap.Modal.getInstance(document.getElementById('salesModal')).hide();
                    loadData();
                    alert(`✅ Sale recorded: ₹${totalAmount.toFixed(2)}`);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    alert('Error: ' + error.message);
                })
                .addSale(sale);
        }
        
        function searchProducts() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = cachedProducts.filter(p => 
                p.name.toLowerCase().includes(term) ||
                (p.brand && p.brand.toLowerCase().includes(term)) ||
                p.category.toLowerCase().includes(term)
            );
            
            const list = document.getElementById('productsList');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="col-12"><div class="empty-state"><i class="bi bi-search"></i><h4>No results</h4></div></div>';
                return;
            }
            
            list.innerHTML = '';
            filtered.forEach(p => {
                const stockClass = p.stock > p.minStock ? 'stock-good' : p.stock > 0 ? 'stock-low' : 'stock-out';
                const stockText = p.stock > p.minStock ? 'In Stock' : p.stock > 0 ? 'Low Stock' : 'Out of Stock';
                const img = p.imageUrl || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(p.name);
                
                list.innerHTML += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card product-card">
                            <img src="${img}" class="product-image" alt="${p.name}">
                            <div class="card-body">
                                <h5 class="card-title">${p.name}</h5>
                                <p class="text-muted mb-2"><small>${p.category} ${p.brand ? '• ' + p.brand : ''}</small></p>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge stock-badge ${stockClass}">${stockText}</span>
                                    <h5 class="mb-0">Stock: ${p.stock}</h5>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Price: <strong>₹${p.price}</strong>/${p.unitType}</span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-primary btn-action" onclick='editProduct(${JSON.stringify(p)})'>
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-action" onclick="deleteProduct('${p.id}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        window.addEventListener('DOMContentLoaded', loadData);
    </script>

</body>
</html>
