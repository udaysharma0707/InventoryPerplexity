<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tile & Sanitaryware Inventory</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .product-card { transition: transform 0.2s, box-shadow 0.2s; height:100%; border:1px solid #dee2e6; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .product-image { width:100%; height:200px; object-fit:cover; background:#e9ecef; }
        .stock-badge { font-size:1rem; padding:0.5rem 1rem; }
        .stock-good { background:#28a745; color:#fff; }
        .stock-low { background:#ffc107; color:#000; }
        .stock-out { background:#dc3545; color:#fff; }
        .card-actions { display:flex; gap:0.5rem; }
        .btn-action { flex:1; }
        .btn-lg { padding:1rem 2rem; font-size:1.2rem; }
        .empty-state { text-align:center; padding:3rem; color:#6c757d; }
        .empty-state i { font-size:4rem; margin-bottom:1rem; }

        .sync-indicator {
            position: fixed;
            top: 70px;
            left: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            z-index: 1000;
            display: none;
        }
        .sync-indicator.syncing { display:block; color:#0d6efd; }
        .sync-indicator.success { display:block; color:#28a745; }

        @media (max-width:768px){
            .btn-lg { padding:0.75rem 1.5rem; font-size:1rem; }
            .product-image { height:150px; }
            .sync-indicator { top:60px; left:10px; font-size:0.8rem; padding:6px 12px; }
        }
    </style>
</head>
<body>

    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator">
        <i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span>
    </div>

    <!-- Header -->
    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory
            </span>
            <div>
                <button class="btn btn-light btn-sm me-2" onclick="exportData()">
                    <i class="bi bi-download"></i> Backup
                </button>
                <button class="btn btn-light btn-sm" onclick="importData()">
                    <i class="bi bi-upload"></i> Restore
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-success btn-lg me-2 mb-2" onclick="showAddProduct()">
                    <i class="bi bi-plus-circle"></i> Add Product
                </button>
                <button class="btn btn-info btn-lg mb-2" onclick="showSalesSection()">
                    <i class="bi bi-cart-check"></i> Record Sale
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-box-seam text-primary" style="font-size:2rem;"></i>
                        <h3 class="mt-2" id="totalProducts">0</h3>
                        <p class="text-muted mb-0">Total Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-currency-rupee text-success" style="font-size:2rem;"></i>
                        <h3 class="mt-2" id="salesToday">₹0</h3>
                        <p class="text-muted mb-0">Sales Today</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem;"></i>
                        <h3 class="mt-2" id="lowStock">0</h3>
                        <p class="text-muted mb-0">Low Stock Items</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="row mb-3">
            <div class="col-md-6 mx-auto">
                <input type="text" class="form-control form-control-lg" id="searchInput"
                       placeholder="🔍 Search products by name or brand..."
                       onkeyup="searchProducts()">
            </div>
        </div>

        <!-- Products Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">Products Inventory</h4>
                <div class="row" id="productsList">
                    <!-- Products will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Recent Sales Section -->
        <div class="row">
            <div class="col-12">
                <h4 class="mb-3">Recent Sales</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Date & Time</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="salesList">
                            <!-- Sales will be displayed here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select</option>
                                    <option value="Tiles">Tiles</option>
                                    <option value="Sanitaryware">Sanitaryware</option>
                                    <option value="Accessories">Accessories</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Brand</label>
                                <input type="text" class="form-control" id="brand">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Size</label>
                                <input type="text" class="form-control" id="size" placeholder="e.g., 2x2 feet">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Unit Type *</label>
                                <select class="form-select" id="unitType" required>
                                    <option value="Box">Box</option>
                                    <option value="Piece">Piece</option>
                                    <option value="SFT">Square Feet</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pieces per Box</label>
                                <input type="number" class="form-control" id="piecesPerBox" value="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">SFT per Box</label>
                                <input type="number" class="form-control" id="sftPerBox" step="0.01">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Price per Unit *</label>
                                <input type="number" class="form-control" id="price" required step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Stock *</label>
                                <input type="number" class="form-control" id="stock" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Minimum Stock</label>
                                <input type="number" class="form-control" id="minStock" value="5">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Product Image URL (optional)</label>
                            <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Modal -->
    <div class="modal fade" id="salesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Record New Sale</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="salesForm">
                        <div class="mb-3">
                            <label class="form-label">Select Product *</label>
                            <select class="form-select" id="saleProduct" onchange="updateSalePriceInstant()" required>
                                <option value="">Choose product...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="saleQuantity"
                                   oninput="updateSalePriceInstant()" required min="1">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Unit Price</label>
                            <input type="text" class="form-control" id="saleUnitPrice" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Total Amount (Editable)</label>
                            <input type="number" class="form-control" id="saleTotal" step="0.01"
                                   placeholder="0.00" oninput="markTotalAsEdited()">
                            <small class="text-muted">Auto-calculated, but you can edit if needed</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="recordSale()">Complete Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ALL JavaScript Code Here -->
    <script>
        // ========== GOOGLE SHEETS API CONFIGURATION ==========
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcn4l-vLF6oY1c47n4-jDwl1nmQY9uAKhrJKN8owz6AojuaiQjWp4Yrl1P_OXwJiOI/exec';

        // ========== CROSS-DEVICE SYNC STORAGE ==========
        let cachedProducts = [];
        let cachedSales = [];
        let totalEdited = false;
        let syncInProgress = false;
        let lastSyncTime = 0;
        let hasInitialLoaded = false; // NEW: indicates first successful getAll

        // ========== SYNC INDICATOR FUNCTIONS ==========
        function showSyncIndicator(message, type = 'syncing') {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            indicator.className = `sync-indicator ${type}`;
            text.textContent = message;
            indicator.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => { indicator.style.display = 'none'; }, 2000);
            }
        }
        function hideSyncIndicator() {
            document.getElementById('syncIndicator').style.display = 'none';
        }

        // ========== CROSS-DEVICE SYNC FUNCTIONS ==========
        // NEW: single request to get both products and sales
        async function syncFromGoogleSheets() {
            if (syncInProgress) return;
            syncInProgress = true;
            showSyncIndicator('Syncing...', 'syncing');

            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                const data = await res.json();

                if (!data || data.success === false) {
                    console.error('getAll failed or returned empty:', data);
                    // keep current UI (don't overwrite with empties)
                    return;
                }

                const serverProducts = data.products || [];
                const serverSales = data.sales || [];

                const productsChanged = JSON.stringify(cachedProducts) !== JSON.stringify(serverProducts);
                const salesChanged = JSON.stringify(cachedSales) !== JSON.stringify(serverSales);

                if (productsChanged || salesChanged || !hasInitialLoaded) {
                    cachedProducts = serverProducts;
                    cachedSales = serverSales;

                    displayProductsFromCache();
                    displaySalesFromCache();
                    updateSummaryFromCache();
                    loadProductsForSaleFromCache();

                    showSyncIndicator('Synced!', 'success');
                } else {
                    hideSyncIndicator();
                }

                hasInitialLoaded = true;
                lastSyncTime = Date.now();
            } catch (error) {
                console.error('Sync error (getAll):', error);
                // keep UI as-is (loading skeleton will remain until hasInitialLoaded true)
            } finally {
                syncInProgress = false;
            }
        }

        // ---------- HELPER: parse server response (safe) ----------
        async function safeParseResponse(res) {
            const txt = await res.text();
            try {
                return { ok: res.ok, json: JSON.parse(txt), text: txt };
            } catch (e) {
                return { ok: res.ok, json: null, text: txt };
            }
        }

        // ---------- SAVE PRODUCT (robust, uses explicit isEdit flag) ----------
        async function saveProductToSheet(product, isEdit = false) {
            const action = isEdit ? 'updateProduct' : 'addProduct';
            const url = `${GOOGLE_SCRIPT_URL}?action=${action}`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                    body: JSON.stringify(product)
                });

                const parsed = await safeParseResponse(res);

                if (parsed.json) {
                    if (parsed.json.success === false || !res.ok) {
                        console.error('Server responded with error:', parsed.json);
                        showSyncIndicator('Save failed', '');
                        alert('❌ Save failed: ' + (parsed.json.error || JSON.stringify(parsed.json)));
                        return null;
                    }

                    console.log('✅ Product saved to Google Sheets (server response):', parsed.json);
                    // replace local id with server id for newly added product
                    if (!isEdit && parsed.json.id) {
                        const localIndex = cachedProducts.findIndex(p => p && p.id === product.id);
                        if (localIndex !== -1) {
                            cachedProducts[localIndex].id = parsed.json.id;
                            product.id = parsed.json.id;
                            displayProductsFromCache();
                            loadProductsForSaleFromCache();
                            updateSummaryFromCache();
                        } else {
                            // fallback match by name + price
                            const fallbackIndex = cachedProducts.findIndex(p => p && p.name === product.name && p.price == product.price);
                            if (fallbackIndex !== -1) {
                                cachedProducts[fallbackIndex].id = parsed.json.id;
                                product.id = parsed.json.id;
                                displayProductsFromCache();
                                loadProductsForSaleFromCache();
                                updateSummaryFromCache();
                            }
                        }
                    }

                    // quick re-sync after short delay
                    setTimeout(() => syncFromGoogleSheets(), 1500);
                    return parsed.json;
                }

                // Non-JSON response
                console.error('Non-JSON server response:', parsed.text);
                showSyncIndicator('Save failed', '');
                alert('❌ Save failed — server returned non-JSON response. Check console Network tab.');
                return null;
            } catch (err) {
                console.error('Save error:', err);
                showSyncIndicator('Save failed', '');
                alert('❌ Save failed. See console for details: ' + (err.message || err));
                return null;
            }
        }

        // ---------- DELETE & SALE wrappers: improved ----------
        async function deleteProductFromSheet(id) {
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=deleteProduct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                    body: JSON.stringify({ id })
                });
                const parsed = await safeParseResponse(res);
                if (parsed.json && parsed.json.success) {
                    console.log('✅ Product deleted from Google Sheets');
                    setTimeout(() => syncFromGoogleSheets(), 1500);
                    return true;
                } else {
                    console.error('Delete error:', parsed);
                    alert('❌ Delete failed. Check console/network.');
                    return false;
                }
            } catch (e) {
                console.error('Delete network error:', e);
                alert('❌ Delete network error. See console.');
                return false;
            }
        }

        async function saveSaleToSheet(sale) {
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=addSale`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                    body: JSON.stringify(sale)
                });
                const parsed = await safeParseResponse(res);
                if (parsed.json && parsed.json.success) {
                    console.log('✅ Sale saved to Google Sheets');
                    setTimeout(() => syncFromGoogleSheets(), 1500);
                    return parsed.json;
                } else {
                    console.error('Sale save failed', parsed);
                    alert('❌ Sale save failed. See console/network.');
                    return null;
                }
            } catch (e) {
                console.error('Sale save network error:', e);
                alert('❌ Sale save network error. See console.');
                return null;
            }
        }

        // Generate unique client-side ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ========== DISPLAY FUNCTIONS (INSTANT FROM CACHE) ==========
        function displayProductsFromCache() {
            const productsList = document.getElementById('productsList');

            // Show loading skeleton until first successful sync
            if (!hasInitialLoaded) {
                productsList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border" role="status" aria-hidden="true"></div>
                        <p class="mt-3 text-muted">Loading inventory…</p>
                    </div>
                `;
                return;
            }

            if (!cachedProducts || cachedProducts.length === 0) {
                productsList.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <h4>No Products Yet</h4>
                            <p>Click "Add Product" to add your first item</p>
                        </div>
                    </div>
                `;
                return;
            }

            productsList.innerHTML = '';
            cachedProducts.forEach(product => {
                const stockClass = product.stock > product.minStock ? 'stock-good' :
                    product.stock > 0 ? 'stock-low' : 'stock-out';
                const stockText = product.stock > product.minStock ? 'In Stock' :
                    product.stock > 0 ? 'Low Stock' : 'Out of Stock';
                const imageUrl = product.imageUrl || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(product.name);

                const card = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card product-card">
                            <img src="${imageUrl}" class="product-image" alt="${product.name}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted mb-2">
                                    <small>${product.category} ${product.brand ? '• ' + product.brand : ''}</small>
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge stock-badge ${stockClass}">${stockText}</span>
                                    <h5 class="mb-0">Stock: ${product.stock}</h5>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span>Price: <strong>₹${product.price}</strong>/${product.unitType}</span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-primary btn-action" onclick="editProduct('${product.id}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-action" onclick="deleteProduct('${product.id}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                productsList.innerHTML += card;
            });
        }

        function displaySalesFromCache() {
            const salesList = document.getElementById('salesList');

            if (!hasInitialLoaded) {
                salesList.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border" role="status" aria-hidden="true"></div>
                            <div class="mt-2 text-muted">Loading sales…</div>
                        </td>
                    </tr>
                `;
                return;
            }

            if (!cachedSales || cachedSales.length === 0) {
                salesList.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td>
                    </tr>
                `;
                return;
            }

            salesList.innerHTML = '';
            const recentSales = cachedSales.slice(0, 10);
            recentSales.forEach(sale => {
                const date = new Date(sale.date);
                const formattedDate = date.toLocaleDateString('en-IN') + ' ' +
                    date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

                const row = `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${sale.productName}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.unitType}</td>
                        <td class="text-success fw-bold">₹${parseFloat(sale.totalAmount).toFixed(2)}</td>
                    </tr>
                `;
                salesList.innerHTML += row;
            });
        }

        function updateSummaryFromCache() {
            if (!hasInitialLoaded) {
                document.getElementById('totalProducts').textContent = 'Loading...';
                document.getElementById('salesToday').textContent = 'Loading...';
                document.getElementById('lowStock').textContent = 'Loading...';
                return;
            }

            document.getElementById('totalProducts').textContent = (cachedProducts || []).length;

            const today = new Date().toDateString();
            const todaySales = (cachedSales || []).filter(sale => {
                const saleDate = new Date(sale.date).toDateString();
                return saleDate === today;
            });

            const totalSalesToday = todaySales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount || 0), 0);
            document.getElementById('salesToday').textContent = '₹' + totalSalesToday.toFixed(2);

            const lowStockItems = (cachedProducts || []).filter(p => p.stock <= p.minStock && p.stock > 0);
            document.getElementById('lowStock').textContent = lowStockItems.length;
        }

        function loadProductsForSaleFromCache() {
            const select = document.getElementById('saleProduct');
            select.innerHTML = '<option value="">Choose product...</option>';
            (cachedProducts || []).forEach(product => {
                if (product.stock > 0) {
                    select.innerHTML += `<option value="${product.id}">${product.name} (Stock: ${product.stock} ${product.unitType})</option>`;
                }
            });
        }

        // ========== PRODUCT FUNCTIONS ==========
        let editingProductId = null;

        function showAddProduct() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function editProduct(id) {
            const product = (cachedProducts || []).find(p => p.id === id);
            if (!product) {
                alert('❌ Product not found!');
                return;
            }
            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('category').value = product.category;
            document.getElementById('brand').value = product.brand || '';
            document.getElementById('size').value = product.size || '';
            document.getElementById('unitType').value = product.unitType;
            document.getElementById('piecesPerBox').value = product.piecesPerBox || 1;
            document.getElementById('sftPerBox').value = product.sftPerBox || '';
            document.getElementById('price').value = product.price;
            document.getElementById('stock').value = product.stock;
            document.getElementById('minStock').value = product.minStock;
            document.getElementById('imageUrl').value = product.imageUrl || '';
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('category').value;
            const brand = document.getElementById('brand').value.trim();
            const size = document.getElementById('size').value.trim();
            const unitType = document.getElementById('unitType').value;
            const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
            const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
            const price = parseFloat(document.getElementById('price').value);
            const stock = parseInt(document.getElementById('stock').value);
            const minStock = parseInt(document.getElementById('minStock').value) || 5;
            const imageUrl = document.getElementById('imageUrl').value.trim();

            if (!name || !category || (isNaN(price) || price === null) || (isNaN(stock) || stock < 0)) {
                alert('❌ Please fill all required fields!');
                return;
            }

            const product = {
                id: editingProductId || generateId(),
                name, category, brand, size, unitType,
                piecesPerBox, sftPerBox, price, stock, minStock, imageUrl
            };

            const existingIndex = (cachedProducts || []).findIndex(p => p.id === product.id);
            const previous = existingIndex !== -1 ? Object.assign({}, cachedProducts[existingIndex]) : null;

            // Optimistic update
            if (existingIndex !== -1) {
                cachedProducts[existingIndex] = product;
            } else {
                cachedProducts.push(product);
            }

            displayProductsFromCache();
            updateSummaryFromCache();
            loadProductsForSaleFromCache();

            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();

            showSyncIndicator('Saving...', 'syncing');

            const isEdit = !!editingProductId;
            const serverResp = await saveProductToSheet(product, isEdit);

            if (serverResp && serverResp.success) {
                showSyncIndicator('Saved', 'success');
                editingProductId = null;
                setTimeout(()=> alert('✅ Product saved successfully!'), 300);
            } else {
                // revert
                if (previous) {
                    cachedProducts[existingIndex] = previous;
                } else {
                    cachedProducts = (cachedProducts || []).filter(p => p.id !== product.id);
                }
                displayProductsFromCache();
                updateSummaryFromCache();
                loadProductsForSaleFromCache();
                alert('❌ Product save failed. Changes were reverted locally.');
            }
        }

        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            const prevProducts = cachedProducts.slice();
            cachedProducts = (cachedProducts || []).filter(p => p.id !== id);
            displayProductsFromCache();
            updateSummaryFromCache();
            loadProductsForSaleFromCache();
            showSyncIndicator('Deleting...', 'syncing');
            deleteProductFromSheet(id).then(success => {
                if (success) {
                    setTimeout(()=> alert('✅ Product deleted successfully!'), 300);
                } else {
                    cachedProducts = prevProducts;
                    displayProductsFromCache();
                    updateSummaryFromCache();
                    loadProductsForSaleFromCache();
                    alert('❌ Delete failed — reverted locally.');
                }
            });
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = (cachedProducts || []).filter(p =>
                p.name.toLowerCase().includes(searchTerm) ||
                (p.brand && p.brand.toLowerCase().includes(searchTerm)) ||
                p.category.toLowerCase().includes(searchTerm)
            );

            const productsList = document.getElementById('productsList');

            if (filtered.length === 0) {
                productsList.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-search"></i>
                            <h4>No Results Found</h4>
                            <p>Try different search terms</p>
                        </div>
                    </div>
                `;
                return;
            }

            productsList.innerHTML = '';
            filtered.forEach(product => {
                const stockClass = product.stock > product.minStock ? 'stock-good' :
                    product.stock > 0 ? 'stock-low' : 'stock-out';
                const stockText = product.stock > product.minStock ? 'In Stock' :
                    product.stock > 0 ? 'Low Stock' : 'Out of Stock';
                const imageUrl = product.imageUrl || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(product.name);

                const card = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card product-card">
                            <img src="${imageUrl}" class="product-image" alt="${product.name}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted mb-2">
                                    <small>${product.category} ${product.brand ? '• ' + product.brand : ''}</small>
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge stock-badge ${stockClass}">${stockText}</span>
                                    <h5 class="mb-0">Stock: ${product.stock}</h5>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span>Price: <strong>₹${product.price}</strong>/${product.unitType}</span>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-primary btn-action" onclick="editProduct('${product.id}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-action" onclick="deleteProduct('${product.id}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                productsList.innerHTML += card;
            });
        }

        // ========== SALES FUNCTIONS ==========
        function showSalesSection() {
            loadProductsForSaleFromCache();
            document.getElementById('salesForm').reset();
            document.getElementById('saleTotal').value = '';
            document.getElementById('saleUnitPrice').value = '';
            totalEdited = false;
            const modal = new bootstrap.Modal(document.getElementById('salesModal'));
            modal.show();
        }

        function updateSalePriceInstant() {
            if (totalEdited) return;
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            if (!productId || quantity <= 0) {
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleUnitPrice').value = '';
                return;
            }
            const product = (cachedProducts || []).find(p => p.id === productId);
            if (!product) return;
            if (quantity > product.stock) {
                alert(`❌ Only ${product.stock} ${product.unitType} available in stock!`);
                document.getElementById('saleQuantity').value = product.stock;
                return;
            }
            const total = product.price * quantity;
            document.getElementById('saleTotal').value = total.toFixed(2);
            document.getElementById('saleUnitPrice').value = '₹' + product.price + '/' + product.unitType;
        }

        function markTotalAsEdited() { totalEdited = true; }

        async function recordSale() {
            const productId = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const totalAmount = parseFloat(document.getElementById('saleTotal').value);

            if (!productId || !quantity || quantity <= 0 || !totalAmount) {
                alert('❌ Please select product, enter quantity, and total amount!');
                return;
            }
            const product = (cachedProducts || []).find(p => p.id === productId);
            if (!product) { alert('❌ Product not found!'); return; }
            if (quantity > product.stock) { alert(`❌ Insufficient stock! Only ${product.stock} available.`); return; }

            const sale = {
                id: generateId(),
                productId: product.id,
                productName: product.name,
                quantity: quantity,
                unitType: product.unitType,
                totalAmount: totalAmount,
                date: new Date().toISOString()
            };

            // Optimistic updates
            product.stock -= quantity;
            cachedSales.unshift(sale);

            // UI updates
            const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
            modal.hide();
            displayProductsFromCache();
            displaySalesFromCache();
            updateSummaryFromCache();
            loadProductsForSaleFromCache();

            showSyncIndicator('Saving sale...', 'syncing');
            const serverResp = await saveSaleToSheet(sale);
            if (serverResp && serverResp.success) {
                showSyncIndicator('Saved', 'success');
                setTimeout(()=> alert(`✅ Sale recorded successfully!\nTotal: ₹${totalAmount.toFixed(2)}`), 300);
            } else {
                // revert
                cachedSales = cachedSales.filter(s => s.id !== sale.id);
                const prod = (cachedProducts || []).find(p => p.id === productId);
                if (prod) prod.stock += quantity;
                displayProductsFromCache();
                displaySalesFromCache();
                updateSummaryFromCache();
                loadProductsForSaleFromCache();
                alert('❌ Sale failed to save. Changes were reverted locally.');
            }
        }

        // ========== BACKUP/RESTORE ==========
        function exportData() {
            const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('✅ Backup downloaded successfully!');
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.products) cachedProducts = data.products;
                    if (data.sales) cachedSales = data.sales;
                    displayProductsFromCache();
                    displaySalesFromCache();
                    updateSummaryFromCache();
                    loadProductsForSaleFromCache();
                    alert('✅ Data restored successfully!');
                } catch (error) {
                    alert('❌ Error: Invalid backup file!');
                }
            };
            reader.readAsText(file);
        }

        // ========== INITIALIZATION ==========
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Tile & Sanitaryware Inventory App Loading...');
            showSyncIndicator('Loading...', 'syncing');
            await syncFromGoogleSheets();
            console.log('✅ App loaded successfully!');
            // Keep periodic syncing (careful with heavy usage - Apps Script quotas)
            setInterval(() => { syncFromGoogleSheets(); }, 5000);
        });

        // Sync when tab becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('👀 Tab visible - syncing...');
                syncFromGoogleSheets();
            }
        });
    </script>

</body>
</html>
